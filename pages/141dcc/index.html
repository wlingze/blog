<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>对upx壳的一次较深入探究 | Lingze&#39;s blog</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ctfer">
    <meta name="keywords" content="ctfer">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.415d0a97.css" as="style"><link rel="preload" href="/assets/js/app.01f8cc77.js" as="script"><link rel="preload" href="/assets/js/2.5ece5099.js" as="script"><link rel="preload" href="/assets/js/56.637c3b4a.js" as="script"><link rel="prefetch" href="/assets/js/10.f923d8b8.js"><link rel="prefetch" href="/assets/js/100.cf64d3e9.js"><link rel="prefetch" href="/assets/js/11.19955ff8.js"><link rel="prefetch" href="/assets/js/12.e16d4c4d.js"><link rel="prefetch" href="/assets/js/13.0552f541.js"><link rel="prefetch" href="/assets/js/14.78d67d73.js"><link rel="prefetch" href="/assets/js/15.d342dfc4.js"><link rel="prefetch" href="/assets/js/16.36f247d6.js"><link rel="prefetch" href="/assets/js/17.031ae63f.js"><link rel="prefetch" href="/assets/js/18.7c49a89e.js"><link rel="prefetch" href="/assets/js/19.2d69c943.js"><link rel="prefetch" href="/assets/js/20.e845eb34.js"><link rel="prefetch" href="/assets/js/21.e398898d.js"><link rel="prefetch" href="/assets/js/22.6efd51e5.js"><link rel="prefetch" href="/assets/js/23.21d2b263.js"><link rel="prefetch" href="/assets/js/24.3231fe48.js"><link rel="prefetch" href="/assets/js/25.26e66a19.js"><link rel="prefetch" href="/assets/js/26.ddde99c2.js"><link rel="prefetch" href="/assets/js/27.f8e523dc.js"><link rel="prefetch" href="/assets/js/28.2c1ddb1d.js"><link rel="prefetch" href="/assets/js/29.f15cca3e.js"><link rel="prefetch" href="/assets/js/3.c087139c.js"><link rel="prefetch" href="/assets/js/30.2d433b5b.js"><link rel="prefetch" href="/assets/js/31.87dbaed0.js"><link rel="prefetch" href="/assets/js/32.045dc002.js"><link rel="prefetch" href="/assets/js/33.db01bde8.js"><link rel="prefetch" href="/assets/js/34.d177d280.js"><link rel="prefetch" href="/assets/js/35.360c2104.js"><link rel="prefetch" href="/assets/js/36.afbabc8a.js"><link rel="prefetch" href="/assets/js/37.8e60e299.js"><link rel="prefetch" href="/assets/js/38.c6a43a23.js"><link rel="prefetch" href="/assets/js/39.08102dc6.js"><link rel="prefetch" href="/assets/js/4.28fb810e.js"><link rel="prefetch" href="/assets/js/40.5767c7d7.js"><link rel="prefetch" href="/assets/js/41.307bcf10.js"><link rel="prefetch" href="/assets/js/42.daf03989.js"><link rel="prefetch" href="/assets/js/43.952d68dc.js"><link rel="prefetch" href="/assets/js/44.cbeef42b.js"><link rel="prefetch" href="/assets/js/45.fbd2a9f2.js"><link rel="prefetch" href="/assets/js/46.a92ae456.js"><link rel="prefetch" href="/assets/js/47.24f82953.js"><link rel="prefetch" href="/assets/js/48.fa3498f4.js"><link rel="prefetch" href="/assets/js/49.a64774f2.js"><link rel="prefetch" href="/assets/js/5.0660e0b3.js"><link rel="prefetch" href="/assets/js/50.d0ed88cd.js"><link rel="prefetch" href="/assets/js/51.50727b96.js"><link rel="prefetch" href="/assets/js/52.2756affe.js"><link rel="prefetch" href="/assets/js/53.2739f473.js"><link rel="prefetch" href="/assets/js/54.f0b71120.js"><link rel="prefetch" href="/assets/js/55.94d5a5ee.js"><link rel="prefetch" href="/assets/js/57.7b7e3fee.js"><link rel="prefetch" href="/assets/js/58.812bae5d.js"><link rel="prefetch" href="/assets/js/59.70fe1d63.js"><link rel="prefetch" href="/assets/js/6.c52e1544.js"><link rel="prefetch" href="/assets/js/60.0e6a01d3.js"><link rel="prefetch" href="/assets/js/61.702e5198.js"><link rel="prefetch" href="/assets/js/62.38f55e44.js"><link rel="prefetch" href="/assets/js/63.b505c9de.js"><link rel="prefetch" href="/assets/js/64.5489c9d8.js"><link rel="prefetch" href="/assets/js/65.3db6e034.js"><link rel="prefetch" href="/assets/js/66.3605a461.js"><link rel="prefetch" href="/assets/js/67.00d97ed9.js"><link rel="prefetch" href="/assets/js/68.78ef741a.js"><link rel="prefetch" href="/assets/js/69.808ca1f4.js"><link rel="prefetch" href="/assets/js/7.9920c8ea.js"><link rel="prefetch" href="/assets/js/70.15347f58.js"><link rel="prefetch" href="/assets/js/71.b9acfd65.js"><link rel="prefetch" href="/assets/js/72.7e1140f3.js"><link rel="prefetch" href="/assets/js/73.874f0e99.js"><link rel="prefetch" href="/assets/js/74.117bb7d4.js"><link rel="prefetch" href="/assets/js/75.964e2dfe.js"><link rel="prefetch" href="/assets/js/76.2df26afd.js"><link rel="prefetch" href="/assets/js/77.93ebe7b7.js"><link rel="prefetch" href="/assets/js/78.67c6c9bb.js"><link rel="prefetch" href="/assets/js/79.0d846438.js"><link rel="prefetch" href="/assets/js/8.f3c32733.js"><link rel="prefetch" href="/assets/js/80.4716a5b6.js"><link rel="prefetch" href="/assets/js/81.d8c3b2d2.js"><link rel="prefetch" href="/assets/js/82.ea63e06a.js"><link rel="prefetch" href="/assets/js/83.4d1ef8ae.js"><link rel="prefetch" href="/assets/js/84.32a22fe7.js"><link rel="prefetch" href="/assets/js/85.7fb3f862.js"><link rel="prefetch" href="/assets/js/86.4d386fc9.js"><link rel="prefetch" href="/assets/js/87.a095878a.js"><link rel="prefetch" href="/assets/js/88.69d77356.js"><link rel="prefetch" href="/assets/js/89.21ebadb4.js"><link rel="prefetch" href="/assets/js/9.d8b27656.js"><link rel="prefetch" href="/assets/js/90.d49929b7.js"><link rel="prefetch" href="/assets/js/91.cc956227.js"><link rel="prefetch" href="/assets/js/92.b72e3535.js"><link rel="prefetch" href="/assets/js/93.a76f52a2.js"><link rel="prefetch" href="/assets/js/94.82a77dbd.js"><link rel="prefetch" href="/assets/js/95.b0cec47e.js"><link rel="prefetch" href="/assets/js/96.87307703.js"><link rel="prefetch" href="/assets/js/97.c731aa62.js"><link rel="prefetch" href="/assets/js/98.1e36c988.js"><link rel="prefetch" href="/assets/js/99.914f1e07.js">
    <link rel="stylesheet" href="/assets/css/0.styles.415d0a97.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open no-sidebar have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/EB-logo.png" alt="Lingze's blog" class="logo"> <span class="site-name can-hide">Lingze's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/archives/" class="nav-link">timeline</a></div><div class="nav-item"><a href="/about.html" class="nav-link">about</a></div><div class="nav-item"><a href="/friends.html" class="nav-link">friends</a></div><div class="nav-item"><a href="/categories/" class="nav-link">categories</a></div><div class="nav-item"><a href="/tags/" class="nav-link">tags</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar2.jpg"> <div class="blogger-info"><h3>lingze</h3> <span>bin不是垃圾桶的意思!</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/archives/" class="nav-link">timeline</a></div><div class="nav-item"><a href="/about.html" class="nav-link">about</a></div><div class="nav-item"><a href="/friends.html" class="nav-link">friends</a></div><div class="nav-item"><a href="/categories/" class="nav-link">categories</a></div><div class="nav-item"><a href="/tags/" class="nav-link">tags</a></div> <!----></nav>  <!----> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1baff76c><div class="articleInfo" data-v-1baff76c><ul class="breadcrumbs" data-v-1baff76c><li data-v-1baff76c><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-1baff76c></a></li> <li data-v-1baff76c><a href="/categories/?category=ctf_wp" title="分类" data-v-1baff76c>ctf_wp</a></li><li data-v-1baff76c><a href="/categories/?category=%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C" title="分类" data-v-1baff76c>攻防世界</a></li></ul> <div class="info" data-v-1baff76c><div title="作者" class="author iconfont icon-touxiang" data-v-1baff76c><a href="https://github.com/wlingze" target="_blank" title="作者" class="beLink" data-v-1baff76c>lingze</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1baff76c><a href="javascript:;" data-v-1baff76c>2020-03-19</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">对upx壳的一次较深入探究<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="对upx壳的一次较深入探究"><a href="#对upx壳的一次较深入探究" class="header-anchor">#</a> 对upx壳的一次较深入探究</h1> <blockquote><p>最开始的起因是一个攻防世界的题目，这个题目使用的upx加壳，题目为easyre-150。</p> <p>攻防世界题号会变化也就不给链接了，进阶区前三页内，还是比较好找。</p> <p>如果直接upx脱壳的话，题目基本没有啥难度，但是在题目做完以后我去翻看这个原本加壳后的文件发现很有趣。</p> <p>于是便去简单的了解了一下。</p></blockquote> <p>@[toc]</p> <h1 id="easy-re-154"><a href="#easy-re-154" class="header-anchor">#</a> easy-re-154</h1> <h2 id="直接脱壳的方法"><a href="#直接脱壳的方法" class="header-anchor">#</a> 直接脱壳的方法</h2> <p>首先直接看到文件die查壳查到是upx_easyre150的壳，</p> <p>然后直接脱壳，看到文件：
<img src="https://img-blog.csdnimg.cn/20200319143525201.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsel9sY180,size_16,color_FFFFFF,t_70" alt="">
在动调的时候我们可以轻松改变，走向got  key的位置，</p> <p>然后会进入函数lol，　
<img src="https://img-blog.csdnimg.cn/20200319143536485.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsel9sY180,size_16,color_FFFFFF,t_70" alt=""></p> <p>大概十个这样子，注意判定跳转前的两句：</p> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>.text:080486B0                 mov     [ebp+var_C], 0
.text:080486B7                 cmp     [ebp+var_C], 1
.text:080486BB                 jnz     short loc_80486D3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这个其实永远不会进入到另一侧的语句运行，我们动调的时候改动下，　就可以看到ｆｌａｇ，</p> <p>当然，很坑的格式：要套上RCTF{}，</p> <p><img src="https://img-blog.csdnimg.cn/20200319143547461.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsel9sY180,size_16,color_FFFFFF,t_70" alt=""></p> <p>就是一个很简单的题目，</p> <p>下面我们去考虑下手动脱壳的方法？</p> <h2 id="知识点"><a href="#知识点" class="header-anchor">#</a> 知识点：</h2> <blockquote><p>在此之前，我们先写一下这一部分出现的知识点：</p></blockquote> <h3 id="proc文件"><a href="#proc文件" class="header-anchor">#</a> proc文件</h3> <p>linux 下的proc文件体系实际上并不是文件，而是我们在运行中的进程，每个进程都会产生一个由其运行的pid为文件名的文件， 其中，<code>/proc/[pid]/</code>目录下的文件：</p> <ul><li><p>cwd :</p> <p>这是一个符号链接，指向这个进程的运行目录。</p></li> <li><p>exe :</p> <p>这也是个软链接， 指向这个进程对应的可执行文件。</p></li> <li><p>fd ：</p> <p>这是一个目录，里面包含进程打开的文件的文件描述符，并且这些描述符都是软链接，指向实际文件。</p></li> <li><p>maps：</p> <p>这个文件包含当前进程在虚拟内存中的空间分布已经对应的地址，访问权限。</p></li></ul> <h3 id="syscall"><a href="#syscall" class="header-anchor">#</a> syscall</h3> <blockquote><p>主要写一下里面出现的系统调用作用和调用号</p> <p>32位 linux 程序系统调用  <code>int 80</code></p></blockquote> <ul><li>sys_open:  <code>eax=5</code>， 打开文件， 并返回一个该文件的文件描述符。</li> <li>sys_lseek:  <code>eax=19</code>， 返回文件读写指针距离文件开头的字节大小。</li> <li>sys_unlink: <code>eax=10</code>， 删除文件链接的意思， 大体就是删除我们open的文件吧，</li> <li>sys_ftruncate：<code>eax=93</code>， 将文件截断，</li> <li>sys_execve：<code>eax=11</code>，加载和启动新的程序</li> <li>sys_munmap: <code>eax=91</code>， 映射内存</li></ul> <h2 id="动调-手动处理壳"><a href="#动调-手动处理壳" class="header-anchor">#</a> 动调，手动处理壳：</h2> <blockquote><p>那么就开始处理：</p></blockquote> <p>进入ida看到其实函数极少， 动调以后大致可以了解他们的内容， 这里简单进行了一下命名：
<img src="https://img-blog.csdnimg.cn/20200319143621125.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsel9sY180,size_16,color_FFFFFF,t_70" alt=""></p> <h3 id="start函数"><a href="#start函数" class="header-anchor">#</a> start函数：</h3> <p><img src="https://img-blog.csdnimg.cn/20200319143612566.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsel9sY180,size_16,color_FFFFFF,t_70" alt="">
这里就是函数入口处了，看起来没啥好看的，动调以后也会发现其实就没啥，进入main函数：</p> <h3 id="main"><a href="#main" class="header-anchor">#</a> main：</h3> <p>main函数比较大，主要分成几个部分：</p> <h4 id="open-proc-pid-exe"><a href="#open-proc-pid-exe" class="header-anchor">#</a> open  '/proc/[pid]/exe'</h4> <p><img src="https://img-blog.csdnimg.cn/20200319143631656.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsel9sY180,size_16,color_FFFFFF,t_70" alt=""></p> <p>首先是获取pid， 然后组成一个<code>&quot;/proc/[pid]/exe&quot;</code>的一个字符串，打开这个文件，</p> <p><img src="https://img-blog.csdnimg.cn/20200319145442653.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsel9sY180,size_16,color_FFFFFF,t_70" alt=""></p> <p>我们上述提到过，这个地址对应是一个链接，指向这个程序自身的绝对地址，</p> <p><img src="https://img-blog.csdnimg.cn/20200319145455705.png" alt=""></p> <p>简单点说就是打开自己这个程序本身。</p> <blockquote><p>同样我们也可以在 <code>/proc/[pid]/fd/</code>中看到</p></blockquote> <p><img src="https://img-blog.csdnimg.cn/20200319145505734.png" alt=""></p> <h4 id="open-aaaaaaaacdmvjo1a4nh"><a href="#open-aaaaaaaacdmvjo1a4nh" class="header-anchor">#</a> open &quot;AAAAAAAACDMVJO1A4NH&quot;</h4> <p>后面的位置主要在两个循环中，处理了一个字符串：</p> <p><img src="https://img-blog.csdnimg.cn/20200319145517362.png" alt=""></p> <p><img src="https://img-blog.csdnimg.cn/20200319145527638.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsel9sY180,size_16,color_FFFFFF,t_70" alt=""></p> <p>将其处理为：&quot;AAAAAAAACDMVJO1A4NH&quot;</p> <p>然后打开这个名字的文件，我们可以在<code>/proc/[pid]/fd/</code>中看到：</p> <p><img src="https://img-blog.csdnimg.cn/20200319145536992.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsel9sY180,size_16,color_FFFFFF,t_70" alt=""></p> <blockquote><p>注意两个文件的权限，</p> <p>程序自身为r-x， 而新建的文件为-wx</p></blockquote> <p>但是我们同样也可以查到，这个是程序自身新建的一个文件，其内容为空：</p> <p><img src="https://img-blog.csdnimg.cn/20200319145546368.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsel9sY180,size_16,color_FFFFFF,t_70" alt=""></p> <blockquote><p>同时注意右上角时间标志，刚刚建立的文件，</p></blockquote> <blockquote><p>以下使用elf代表文件本身，然后file代表这个新建立的文件</p></blockquote> <h4 id="reada"><a href="#reada" class="header-anchor">#</a> reada</h4> <p>程序内的一个函数，主要作用就是讲fd 的len个长度的内容写入到addr中，该是比较好理解，</p> <p><img src="https://img-blog.csdnimg.cn/20200319145558173.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsel9sY180,size_16,color_FFFFFF,t_70" alt=""></p> <h4 id="loader"><a href="#loader" class="header-anchor">#</a> loader</h4> <p>在其后进入一个循环，这里除了一下系统调用以外主要是高亮起来的一个较复杂的函数，不出所料应该就是upx  loader</p> <p>大致如下：
<img src="https://img-blog.csdnimg.cn/20200319145612149.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsel9sY180,size_16,color_FFFFFF,t_70" alt=""></p> <p>先是efl文件复制到一块地址空间，然后从这个addr进入loader去解压缩，最后写入到file中，<img src="https://img-blog.csdnimg.cn/20200319145622346.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsel9sY180,size_16,color_FFFFFF,t_70" alt=""></p> <p>我们查看：</p> <p><img src="https://img-blog.csdnimg.cn/20200319145640133.png" alt=""></p> <p>同样注意时间，这个是刚刚运行完write后写入的，</p> <h4 id="execve"><a href="#execve" class="header-anchor">#</a> execve</h4> <p>应该是运行一次循环，然后就会跳出了， 进入判定，</p> <p><img src="https://img-blog.csdnimg.cn/20200319145921517.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsel9sY180,size_16,color_FFFFFF,t_70" alt=""></p> <p>if语句中需要我们注意的是sys_execve函数，改变了运行的程序，</p> <p>动调的时候会有问题：
<img src="https://img-blog.csdnimg.cn/20200319145650294.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsel9sY180,size_16,color_FFFFFF,t_70" alt=""></p> <p>这个if语句是进不去的， 要验证的是&quot;!   &quot;， 而实际运行后的位置是&quot;UPX!&quot;， 这个是UPX压缩的标志， 我们直接去手动该下，让他进入if语句中运行：</p> <p>if语句中，先是关闭两个文件，然后又打开了file文件的读取，如下示：
<img src="https://img-blog.csdnimg.cn/20200319145712302.png" alt=""></p> <blockquote><p>但是这次是r-x权限了</p></blockquote> <p>然后复制了一段数据，使用sys_unlink，</p> <blockquote><p>这里我们要知道，unlink不会直接关闭一个文件， 会先检查下文件是否还在读写，当这个文件不进行读写的时候，再将其关闭，</p></blockquote> <p>于是我们的fd文件夹：</p> <p><img src="https://img-blog.csdnimg.cn/20200319145726223.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsel9sY180,size_16,color_FFFFFF,t_70" alt=""></p> <p>然后执行<code>sys_execve</code>，</p> <p>注意这里的参数已经改为了：</p> <p><img src="https://img-blog.csdnimg.cn/20200319145736696.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsel9sY180,size_16,color_FFFFFF,t_70" alt="">
即，把切换运行的elf文件为我们的file文件，</p> <p>然后我们执行：</p> <p><img src="https://img-blog.csdnimg.cn/2020031914574584.png" alt=""></p> <p>并且可以看到我们的动调的位置：</p> <p><img src="https://img-blog.csdnimg.cn/20200319145755869.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsel9sY180,size_16,color_FFFFFF,t_70" alt="">
已经是在运行我们的脱壳后的文件了。</p> <p>接下来就是直接去查看那个AAAA..的文件，然后会发现和我们脱壳完了以后的文件是一致的。</p> <h1 id="关于查壳"><a href="#关于查壳" class="header-anchor">#</a> 关于查壳</h1> <blockquote><p>由于第二种方式的脱壳并不是我们常见的upx脱壳方式，我也觉得很是怪异，于是去进一步的看了一下upx，</p> <p>包括以下：</p> <p>die是如何查到upx的壳的？</p> <p>一个正常的以前手动脱的壳应该是啥样？</p> <p>upx加壳，这个加载器loader，是如何产生出来的？</p></blockquote> <h2 id="die查壳的脚本"><a href="#die查壳的脚本" class="header-anchor">#</a> die查壳的脚本</h2> <p>从die中找到的upx那个查壳的脚本：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// DIE's signature file</span>

<span class="token function">init</span><span class="token punctuation">(</span><span class="token string">&quot;packer&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;UPX&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

function <span class="token function">getUPXOptions</span><span class="token punctuation">(</span>nOffset<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    var nMethod<span class="token operator">=</span>ELF<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span>nOffset<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    var nLevel<span class="token operator">=</span>ELF<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span>nOffset<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    var sCompression<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>nMethod<span class="token punctuation">)</span> <span class="token comment">// From http://sourceforge.net/p/upx/code/ci/default/tree/src/conf.h</span>
    <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token number">8</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token number">9</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token number">10</span><span class="token operator">:</span> sCompression<span class="token operator">=</span><span class="token string">&quot;NRV&quot;</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">14</span><span class="token operator">:</span> sCompression<span class="token operator">=</span><span class="token string">&quot;LZMA&quot;</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">15</span><span class="token operator">:</span> sCompression<span class="token operator">=</span><span class="token string">&quot;zlib&quot;</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>sCompression<span class="token operator">!=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        sOptions<span class="token operator">=</span>sOptions<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>sCompression<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>nLevel<span class="token operator">==</span><span class="token number">8</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            sOptions<span class="token operator">=</span>sOptions<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;best&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            sOptions<span class="token operator">=</span>sOptions<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;brute&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

function <span class="token function">detect</span><span class="token punctuation">(</span>bShowType<span class="token punctuation">,</span>bShowVersion<span class="token punctuation">,</span>bShowOptions<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    var nSize<span class="token operator">=</span>ELF<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ELF<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token string">&quot;'UPX!'&quot;</span><span class="token punctuation">,</span>nSize<span class="token operator">-</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">getUPXOptions</span><span class="token punctuation">(</span>nSize<span class="token operator">-</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bDetected<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ELF<span class="token punctuation">.</span><span class="token function">compareEP</span><span class="token punctuation">(</span><span class="token string">&quot;E8........EB0E5A585997608A542420E9........60&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        sVersion<span class="token operator">=</span><span class="token string">&quot;3.X&quot;</span><span class="token punctuation">;</span>
        bDetected<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    var nOffset<span class="token operator">=</span>ELF<span class="token punctuation">.</span><span class="token function">findString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>nSize<span class="token punctuation">,</span><span class="token string">&quot;$Id: UPX&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>nOffset<span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        sVersion<span class="token operator">=</span>ELF<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>nOffset<span class="token operator">+</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bDetected<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">result</span><span class="token punctuation">(</span>bShowType<span class="token punctuation">,</span>bShowVersion<span class="token punctuation">,</span>bShowOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><blockquote><p>一个<code>.sq</code>后缀的文件，我也没怎么查到是要用啥语法高亮， 看着非常像c， 就用了c的高亮吧</p> <p>啧， 括号分行写， 我觉得是c</p></blockquote> <p>然后看起来像是，用了个查找字符串 找那个&quot;UPX&quot;标志，然后还有个一大堆的， 但是&quot;e8&quot; ，应该是call的字节码吧，中间省略，后面估计也是字节码，应该是是为了查那个loader，</p> <p>然后拿出010， 把这个题目文件的&quot;UPX!&quot;标志给去掉，</p> <p>然后die查壳：</p> <p><img src="https://img-blog.csdnimg.cn/20200319145809772.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsel9sY180,size_16,color_FFFFFF,t_70" alt=""></p> <p>没有查出来UPX了，</p> <p>成功，那么这样的话， 题目就必须动调，而且还看不出来有壳， 难度就上升很多很多。</p> <h2 id="标准的一个upx加壳程序的-loader"><a href="#标准的一个upx加壳程序的-loader" class="header-anchor">#</a> 标准的一个upx加壳程序的 loader</h2> <p>另外我们看一下一个标准使用upx的程序应该有的loader，</p> <p>我们随手拿来一个简单的文件进行加壳：
<img src="https://img-blog.csdnimg.cn/2020031914582586.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsel9sY180,size_16,color_FFFFFF,t_70" alt=""></p> <p>然后看一下：</p> <p>如果我们多看几个应该是差不多的结构，都是这些东西，</p> <p><img src="https://img-blog.csdnimg.cn/20200319145836264.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsel9sY180,size_16,color_FFFFFF,t_70" alt=""></p> <p>说明， 这个loader是一个固定生成的， 只是call指令会有偏移，会重新计算，</p> <p>这个时候，我们继续去使用010 将其中的&quot;UPX!&quot; 标志去除掉。</p> <p>载入die，　发现仍然可以判断出来是upx, 　估计是前面我们看到分析中间另一部分的那些&quot;e8&quot;之类的，的确是在查找loader，</p> <p>这也证明了我们这个题目并不是标准的一个upx直接进行压缩的，估计应该是出题人自己写的，</p> <p>另外那个我们动调中间判断失败也是由于出现upx标志，可能题目原本应该是没有这个标志的，应该是被改过吧，</p> <h2 id="简略翻看源码-loader的位置"><a href="#简略翻看源码-loader的位置" class="header-anchor">#</a> 简略翻看源码  loader的位置</h2> <p>另外upx是一个开源工具，在github我们可以找到他的源码，</p> <p>另外17年2月有篇文章：<a href="https://bbs.ichunqiu.com/thread-19345-1-1.html" target="_blank" rel="noopener noreferrer">i春秋-Tangerine-upx源码分析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>大佬简单讲述了整个流程和最后产生loader的位置，</p> <p>里面的一部分位置和现在的版本有些许差别，但是整体流程都是一致的，感兴趣的朋友可以看看。
目前我只是跟着这个文章的思路捋了一遍整个的流程，等下一步继续分析再写相关的文章吧。</p> <p>主要的loader已经预设好在文件<code>upx/src/stub/amd64-linux.elf-entry.h</code>中，
<img src="https://img-blog.csdnimg.cn/20200319145847200.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsel9sY180,size_16,color_FFFFFF,t_70" alt=""></p> <p>然后除了对于call指令进行矫正之类的， opcode和这里的数据基本一致，这里就不再赘述，</p> <h1 id="最后"><a href="#最后" class="header-anchor">#</a> 最后</h1> <p>其实仔细的调试了下这个题目了解到了不少和linux内的一些东西，
且最后也发现了这个题目的前面的加载部分，应该是一个作者自己写的， 如果我们讲其中的upx标志去掉，还是一个比较有难度的题目，
而且我们也可以使用这样的框架，讲其中的loader函数部修改，实现另外一种加壳， 自己做出来一个稍微比较有难度的题目。</p></div></div> <!----> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=wp" title="标签">#wp</a><a href="/tags/?tag=reverse" title="标签">#reverse</a><a href="/tags/?tag=%E5%A3%B3" title="标签">#壳</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">8/26/2021, 3:14:55 AM</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:wl200103124@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/wlingze" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://blog.csdn.net/wlz_lc_4" title="csdn" target="_blank" class="iconfont icon-csdn"></a><a href="https://www.zhihu.com/people/wlingze" title="zhihu" target="_blank" class="iconfont icon-zhihu"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2022
    <span>lingze | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.01f8cc77.js" defer></script><script src="/assets/js/2.5ece5099.js" defer></script><script src="/assets/js/56.637c3b4a.js" defer></script>
  </body>
</html>
