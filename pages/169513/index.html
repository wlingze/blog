<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>libfuzzer source code analysis | Lingze&#39;s blog</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ctfer">
    <meta name="keywords" content="ctfer">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.415d0a97.css" as="style"><link rel="preload" href="/assets/js/app.01f8cc77.js" as="script"><link rel="preload" href="/assets/js/2.5ece5099.js" as="script"><link rel="preload" href="/assets/js/72.7e1140f3.js" as="script"><link rel="prefetch" href="/assets/js/10.f923d8b8.js"><link rel="prefetch" href="/assets/js/100.cf64d3e9.js"><link rel="prefetch" href="/assets/js/11.19955ff8.js"><link rel="prefetch" href="/assets/js/12.e16d4c4d.js"><link rel="prefetch" href="/assets/js/13.0552f541.js"><link rel="prefetch" href="/assets/js/14.78d67d73.js"><link rel="prefetch" href="/assets/js/15.d342dfc4.js"><link rel="prefetch" href="/assets/js/16.36f247d6.js"><link rel="prefetch" href="/assets/js/17.031ae63f.js"><link rel="prefetch" href="/assets/js/18.7c49a89e.js"><link rel="prefetch" href="/assets/js/19.2d69c943.js"><link rel="prefetch" href="/assets/js/20.e845eb34.js"><link rel="prefetch" href="/assets/js/21.e398898d.js"><link rel="prefetch" href="/assets/js/22.6efd51e5.js"><link rel="prefetch" href="/assets/js/23.21d2b263.js"><link rel="prefetch" href="/assets/js/24.3231fe48.js"><link rel="prefetch" href="/assets/js/25.26e66a19.js"><link rel="prefetch" href="/assets/js/26.ddde99c2.js"><link rel="prefetch" href="/assets/js/27.f8e523dc.js"><link rel="prefetch" href="/assets/js/28.2c1ddb1d.js"><link rel="prefetch" href="/assets/js/29.f15cca3e.js"><link rel="prefetch" href="/assets/js/3.c087139c.js"><link rel="prefetch" href="/assets/js/30.2d433b5b.js"><link rel="prefetch" href="/assets/js/31.87dbaed0.js"><link rel="prefetch" href="/assets/js/32.045dc002.js"><link rel="prefetch" href="/assets/js/33.db01bde8.js"><link rel="prefetch" href="/assets/js/34.d177d280.js"><link rel="prefetch" href="/assets/js/35.360c2104.js"><link rel="prefetch" href="/assets/js/36.afbabc8a.js"><link rel="prefetch" href="/assets/js/37.8e60e299.js"><link rel="prefetch" href="/assets/js/38.c6a43a23.js"><link rel="prefetch" href="/assets/js/39.08102dc6.js"><link rel="prefetch" href="/assets/js/4.28fb810e.js"><link rel="prefetch" href="/assets/js/40.5767c7d7.js"><link rel="prefetch" href="/assets/js/41.307bcf10.js"><link rel="prefetch" href="/assets/js/42.daf03989.js"><link rel="prefetch" href="/assets/js/43.952d68dc.js"><link rel="prefetch" href="/assets/js/44.cbeef42b.js"><link rel="prefetch" href="/assets/js/45.fbd2a9f2.js"><link rel="prefetch" href="/assets/js/46.a92ae456.js"><link rel="prefetch" href="/assets/js/47.24f82953.js"><link rel="prefetch" href="/assets/js/48.fa3498f4.js"><link rel="prefetch" href="/assets/js/49.a64774f2.js"><link rel="prefetch" href="/assets/js/5.0660e0b3.js"><link rel="prefetch" href="/assets/js/50.d0ed88cd.js"><link rel="prefetch" href="/assets/js/51.50727b96.js"><link rel="prefetch" href="/assets/js/52.2756affe.js"><link rel="prefetch" href="/assets/js/53.2739f473.js"><link rel="prefetch" href="/assets/js/54.f0b71120.js"><link rel="prefetch" href="/assets/js/55.94d5a5ee.js"><link rel="prefetch" href="/assets/js/56.637c3b4a.js"><link rel="prefetch" href="/assets/js/57.7b7e3fee.js"><link rel="prefetch" href="/assets/js/58.812bae5d.js"><link rel="prefetch" href="/assets/js/59.70fe1d63.js"><link rel="prefetch" href="/assets/js/6.c52e1544.js"><link rel="prefetch" href="/assets/js/60.0e6a01d3.js"><link rel="prefetch" href="/assets/js/61.702e5198.js"><link rel="prefetch" href="/assets/js/62.38f55e44.js"><link rel="prefetch" href="/assets/js/63.b505c9de.js"><link rel="prefetch" href="/assets/js/64.5489c9d8.js"><link rel="prefetch" href="/assets/js/65.3db6e034.js"><link rel="prefetch" href="/assets/js/66.3605a461.js"><link rel="prefetch" href="/assets/js/67.00d97ed9.js"><link rel="prefetch" href="/assets/js/68.78ef741a.js"><link rel="prefetch" href="/assets/js/69.808ca1f4.js"><link rel="prefetch" href="/assets/js/7.9920c8ea.js"><link rel="prefetch" href="/assets/js/70.15347f58.js"><link rel="prefetch" href="/assets/js/71.b9acfd65.js"><link rel="prefetch" href="/assets/js/73.874f0e99.js"><link rel="prefetch" href="/assets/js/74.117bb7d4.js"><link rel="prefetch" href="/assets/js/75.964e2dfe.js"><link rel="prefetch" href="/assets/js/76.2df26afd.js"><link rel="prefetch" href="/assets/js/77.93ebe7b7.js"><link rel="prefetch" href="/assets/js/78.67c6c9bb.js"><link rel="prefetch" href="/assets/js/79.0d846438.js"><link rel="prefetch" href="/assets/js/8.f3c32733.js"><link rel="prefetch" href="/assets/js/80.4716a5b6.js"><link rel="prefetch" href="/assets/js/81.d8c3b2d2.js"><link rel="prefetch" href="/assets/js/82.ea63e06a.js"><link rel="prefetch" href="/assets/js/83.4d1ef8ae.js"><link rel="prefetch" href="/assets/js/84.32a22fe7.js"><link rel="prefetch" href="/assets/js/85.7fb3f862.js"><link rel="prefetch" href="/assets/js/86.4d386fc9.js"><link rel="prefetch" href="/assets/js/87.a095878a.js"><link rel="prefetch" href="/assets/js/88.69d77356.js"><link rel="prefetch" href="/assets/js/89.21ebadb4.js"><link rel="prefetch" href="/assets/js/9.d8b27656.js"><link rel="prefetch" href="/assets/js/90.d49929b7.js"><link rel="prefetch" href="/assets/js/91.cc956227.js"><link rel="prefetch" href="/assets/js/92.b72e3535.js"><link rel="prefetch" href="/assets/js/93.a76f52a2.js"><link rel="prefetch" href="/assets/js/94.82a77dbd.js"><link rel="prefetch" href="/assets/js/95.b0cec47e.js"><link rel="prefetch" href="/assets/js/96.87307703.js"><link rel="prefetch" href="/assets/js/97.c731aa62.js"><link rel="prefetch" href="/assets/js/98.1e36c988.js"><link rel="prefetch" href="/assets/js/99.914f1e07.js">
    <link rel="stylesheet" href="/assets/css/0.styles.415d0a97.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open no-sidebar have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/EB-logo.png" alt="Lingze's blog" class="logo"> <span class="site-name can-hide">Lingze's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/archives/" class="nav-link">timeline</a></div><div class="nav-item"><a href="/about.html" class="nav-link">about</a></div><div class="nav-item"><a href="/friends.html" class="nav-link">friends</a></div><div class="nav-item"><a href="/categories/" class="nav-link">categories</a></div><div class="nav-item"><a href="/tags/" class="nav-link">tags</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar2.jpg"> <div class="blogger-info"><h3>lingze</h3> <span>bin不是垃圾桶的意思!</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/archives/" class="nav-link">timeline</a></div><div class="nav-item"><a href="/about.html" class="nav-link">about</a></div><div class="nav-item"><a href="/friends.html" class="nav-link">friends</a></div><div class="nav-item"><a href="/categories/" class="nav-link">categories</a></div><div class="nav-item"><a href="/tags/" class="nav-link">tags</a></div> <!----></nav>  <!----> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1baff76c><div class="articleInfo" data-v-1baff76c><ul class="breadcrumbs" data-v-1baff76c><li data-v-1baff76c><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-1baff76c></a></li> <li data-v-1baff76c><a href="/categories/?category=labbb" title="分类" data-v-1baff76c>labbb</a></li><li data-v-1baff76c><a href="/categories/?category=fuzz" title="分类" data-v-1baff76c>fuzz</a></li></ul> <div class="info" data-v-1baff76c><div title="作者" class="author iconfont icon-touxiang" data-v-1baff76c><a href="https://github.com/wlingze" target="_blank" title="作者" class="beLink" data-v-1baff76c>lingze</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1baff76c><a href="javascript:;" data-v-1baff76c>2022-05-07</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">libfuzzer source code analysis<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="libfuzzer-source-code-analysis"><a href="#libfuzzer-source-code-analysis" class="header-anchor">#</a> libfuzzer source code analysis</h1> <p>libfuzzer 简单源码分析</p> <p></p><div class="table-of-contents"><ul><li><a href="#使用">使用</a></li><li><a href="#环境搭建">环境搭建</a></li><li><a href="#源码分析">源码分析</a></li><li><a href="#初始化">初始化</a></li><li><a href="#运行逻辑">运行逻辑</a><ul><li><a href="#fuzzer-loop">Fuzzer::Loop</a></li><li><a href="#fuzzer-mutateandtestone">Fuzzer::MutateAndTestOne</a></li><li><a href="#executecallback">ExecuteCallback</a></li></ul></li><li><a href="#多线程运行">多线程运行</a><ul><li><a href="#runinmultipleprocesses">RunInMultipleProcesses</a></li><li><a href="#fork模式">fork模式</a></li></ul></li><li><a href="#变异策略">变异策略</a><ul><li><a href="#mutationdispatcher-mutationdispatcher">MutationDispatcher::MUtationDispatcher</a></li><li><a href="#mutationdispatcher-mutatewithmask">MutationDispatcher::MutateWithMask</a></li><li><a href="#mutationdispatcher-mutate">MUtationDispatcher::Mutate</a></li><li><a href="#变异方案">变异方案</a></li><li><a href="#addwordfromtorc">AddWordFromTORC</a></li></ul></li><li><a href="#插桩策略">插桩策略</a><ul><li><a href="#trace方法">trace方法</a></li><li><a href="#路径记录">路径记录</a></li><li><a href="#判断路径">判断路径</a></li><li><a href="#pc-guard">pc_guard</a></li></ul></li></ul></div><p></p> <h2 id="使用"><a href="#使用" class="header-anchor">#</a> 使用</h2> <p>libfuzz使用可以参考这个项目， <a href="https://github.com/Dor1s/libfuzzer-workshop" target="_blank" rel="noopener noreferrer">libfuzz-workshop<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, 其内部也有一个单独取出来的libfuzz源码，但是和我本地版本不对应，就没直接使用。</p> <p>libfuzzer使用：
编写一个loader， 将 <code>extern &quot;C&quot; int LLVMFuzzerTestOneInput(const uint8_t *Data, size_t Size)</code> 实现， 这个size和data就是fuzz输入进来的数据，一般实现如下：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> <span class="token function">LLVMFuzzerTestOneInput</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>Data<span class="token punctuation">,</span> size_t Size<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">FuzzTargetApi</span><span class="token punctuation">(</span>Data<span class="token punctuation">,</span> Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然后使用<code>clang</code>进行编译， 常用编译选项：</p> <ul><li>-fsanitize=
<ul><li>fuzzer: 使用libfuzzer， 会自动读取到<code>LLVMFuzzerTestOneInput</code>函数，将libfuzz的代码链接在一起， 可以追加<code>-DLLVMFuzzerTestOneInput=FunctionName</code>编译选项， 将认为给定的函数是<code>LLVMFuzzerTestOneInput</code></li> <li>address: 启动<code>AddressSanitizer</code>功能， 这是llvm中的对内存进行检查的功能， 因为fuzz是检查崩溃或超时等异常引号，对于溢出特别是短字节溢出没有很好的效果，在afl和libfuzzer中我们都会使用这个编译选项。</li> <li>fuzzer-no-link: 在fuzz一些库函数的时候会用到，在编译的时候开启这个选项， 会对库函数内增加fuzz需要的插桩，但是不会立刻生成fuzz程序，而是生成一个<code>xx.a</code>文件，用于后续和loader链接在一起。</li></ul></li> <li>-fsantize-coveraeg=
<ul><li>这部分是llvm在ir层面的插桩， 增加以下几个选项会开启对应的插桩，</li></ul> <blockquote><p>这部分llvm实现的非常聪明， 插桩实在ir优化的时候做的，但是只是插入代码，详细的实现其实是在libfuzzer的代码中，这样libfuzzer在运行时就可以获取到覆盖率信息。</p></blockquote> <ul><li>trace-cmp</li> <li>trace-div</li> <li>trace-gep</li> <li>trace-pc-guard</li></ul></li></ul> <p>一般使用流程：
首先编译出静态链接库，</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">FUZZ_CXXFLAGS</span><span class="token operator">=</span><span class="token string">&quot;-O2 -fno-omit-frame-pointer -g -fsanitize=address,fuzzer-no-link -fsanitize-coverage=trace-cmp,trace-gep,trace-div&quot;</span>
./configure <span class="token assign-left variable">CC</span><span class="token operator">=</span><span class="token string">&quot;clang&quot;</span> <span class="token assign-left variable">CFLAGS</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$FUZZ_CXX_FLAGS</span>&quot;</span> <span class="token assign-left variable">CXX</span><span class="token operator">=</span><span class="token string">&quot;clang++&quot;</span>
<span class="token function">make</span> -j8
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>生成xx.a文件，然后和编译出fuzz，</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>clang++ -std<span class="token operator">=</span>c++11 fuzzer.cc -O2 -fno-omit-frame-pointer -g -fsanitize<span class="token operator">=</span>address,fuzzer -fsanitize-coverage<span class="token operator">=</span>tracecmp,trace-gep,trace-div -I include/   xxx.a -lz -o fuzz
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后生成我们的fuzz文件，直接运行即可，libfuzz会在遇到第一个崩溃的时候自动停止。</p> <p>还有一些非常有用的选项，可以在<code>libfuzzer-workshop</code>中看到，我们后面源码分析中也会讲到一些。</p> <p><strong>一个比较重要的事情是要意识到， libfuzzer主要针对某一个api进行fuzz， afl则是对于程序整体进行fuzz。</strong></p> <p>其实有点像go的test， 或者go新出的原生fuzz库的使用，即 编译器级别的测试拓展做出来的fuzz功能。</p> <h2 id="环境搭建"><a href="#环境搭建" class="header-anchor">#</a> 环境搭建</h2> <p>libfuzzer其实是被包含在llvm项目中的，目录在<code>llvm/compile-rt/lib/fuzzer</code>， 这一部分是解耦出来的，可以直接使用这一部分源码和对应版本clang进行编译和调试。</p> <blockquote><p>这样就不需要编译巨大的llvm了。</p></blockquote> <p>直接在fuzzer目录运行<code>build.sh</code>脚本即可， 会编译相关文件并组合成<code>libFuzzer.a</code>文件。
这个<code>libFuzzer.a</code>文件编译其实就和我们前面看到的一样，</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>clang++ -std<span class="token operator">=</span>c++11 fuzz.cpp -fsanitize<span class="token operator">=</span>address -fsanitize-coverage<span class="token operator">=</span>trace-cmp,trace-div,trace-gep ./libFuzzer.a -lz -o fuzz
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后应该可以通过二进制文件开始调试了。</p> <h2 id="源码分析"><a href="#源码分析" class="header-anchor">#</a> 源码分析</h2> <p>libfuzzer其实做的事情就是，构造好输入数据，然后调用我们编写的<code>LLVMFuzzerTestOneInput</code>， 并将数据输入。</p> <p>工作工程大概是：</p> <ul><li>初始化</li> <li>生成数据</li> <li>开始测试</li> <li>收集覆盖率 -&gt; 回到数据生成部分</li></ul> <p>直到fuzz到crash以后，会根据jobs的设置推出，一般设置为0，就是得到一个crash就退出。</p> <h2 id="初始化"><a href="#初始化" class="header-anchor">#</a> 初始化</h2> <p>分析的起点从main函数开始，libfuzzer的mian函数在文件<code>FuzzerMain.cpp</code>文件中， 声明了函数<code>LLVMFuzzerTestOneInput</code>， 并作为参数传入了函数<code>fuzzer::FuzzerDriver</code>，
这个函数首先会读取参数并加载各种配置项， 列几个出现的重要的变量：</p> <ul><li>EF: <code>ExternalFunctions</code>: 表示外部函数， 其实是类似<code>LLVMFuzzerTestOneInput</code>之类的函数，在libfuzz中声明了，但是不一定真的被用户实现了，如果被用户实现了，会在这个变量中对应的位置记录对应地址，可以直接进行调用， 这样的设计给整个fuzz提供了一定的拓展能力。</li> <li>Flags: 在<code>FuzzerFlags.def</code>文件中的各种相关定义，这里面的是默认定义，默认被载入，然后在我们运行 <code>ParseFlags(Args, EF)</code>的时候会从命令行参数和是否存在外部函数来调整flag中的配置。</li> <li>FuzzingOptions： 其实是将<code>Flags</code>的内容基本转换过来， 后续传入比较重要的几个对象中。</li></ul> <p>主要对这几个配置相关的变量进行初始化和设置。</p> <p>然后开始进行运行， 创建了三个重要的运行相关的对象。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>Random <span class="token function">Rand</span><span class="token punctuation">(</span>Seed<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">auto</span> <span class="token operator">*</span>MD <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">MutationDispatcher</span><span class="token punctuation">(</span>Rand<span class="token punctuation">,</span> Options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">auto</span> <span class="token operator">*</span>Corpus <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">InputCorpus</span><span class="token punctuation">(</span>Options<span class="token punctuation">.</span>OutputCorpus<span class="token punctuation">,</span> Entropic<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">auto</span> <span class="token operator">*</span>F <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Fuzzer</span><span class="token punctuation">(</span>Callback<span class="token punctuation">,</span> <span class="token operator">*</span>Corpus<span class="token punctuation">,</span> <span class="token operator">*</span>MD<span class="token punctuation">,</span> Options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>MutationDispatcher: 这是变异相关的控制器，libfuzzer中默认存在13种变异方式。如果<code>EF</code>中存在自定义变异算法，会直接使用用户提供的自定义变异。</li></ul> <blockquote><p>libfuzzer的变异分发这部分，比afl写的清晰太多了 qaq, afl一个fuzzone函数全仍里头 -&gt;_-&gt;</p></blockquote> <ul><li>InputCorpus: 这是输入的语料</li> <li>Fuzzer： 这是主要函数，主要的fuzz行为都是这个对象。注意<code>Callback</code>这个参数，这个是我们看到main函数传入的第二个参数， 也就是我们自定义的<code>LLVMFuzzerTestOneInput</code>函数，</li></ul> <p>后续继续进行一些初始化操作， 然后进入函数<code>Fuzzer::Loop</code></p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">auto</span> CorporaFiles <span class="token operator">=</span> <span class="token function">ReadCorpora</span><span class="token punctuation">(</span><span class="token operator">*</span>Inputs<span class="token punctuation">,</span> <span class="token function">ParseSeedInuts</span><span class="token punctuation">(</span>Flags<span class="token punctuation">.</span>seed_inputs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
F<span class="token operator">-&gt;</span><span class="token function">Loop</span><span class="token punctuation">(</span>CorporaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="运行逻辑"><a href="#运行逻辑" class="header-anchor">#</a> 运行逻辑</h2> <p>因为是针对函数的fuzz， 因此不需要afl那样fork-server之类的设计，但是同样失去了对于运行空间重置的能力，可能每次运行状态不同。</p> <p>但是实现上来说，这种方案确实简单不少。</p> <h3 id="fuzzer-loop"><a href="#fuzzer-loop" class="header-anchor">#</a> Fuzzer::Loop</h3> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token class-name">Fuzzer</span><span class="token double-colon punctuation">::</span><span class="token function">Loop</span><span class="token punctuation">(</span>Vector<span class="token operator">&lt;</span>SizedFile<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>CorporaFiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">auto</span> FocusFunctionOrAuto <span class="token operator">=</span> Options<span class="token punctuation">.</span>FocusFunction<span class="token punctuation">;</span>
  DFT<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>Options<span class="token punctuation">.</span>DataFlowTrace<span class="token punctuation">,</span> <span class="token operator">&amp;</span>FocusFunctionOrAuto<span class="token punctuation">,</span> CorporaFiles<span class="token punctuation">,</span>
           MD<span class="token punctuation">.</span><span class="token function">GetRand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  TPC<span class="token punctuation">.</span><span class="token function">SetFocusFunction</span><span class="token punctuation">(</span>FocusFunctionOrAuto<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ReadAndExecuteSeedCorpora</span><span class="token punctuation">(</span>CorporaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
  DFT<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// No need for DFT any more.</span>
  TPC<span class="token punctuation">.</span><span class="token function">SetPrintNewPCs</span><span class="token punctuation">(</span>Options<span class="token punctuation">.</span>PrintNewCovPcs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  TPC<span class="token punctuation">.</span><span class="token function">SetPrintNewFuncs</span><span class="token punctuation">(</span>Options<span class="token punctuation">.</span>PrintNewCovFuncs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  system_clock<span class="token double-colon punctuation">::</span>time_point LastCorpusReload <span class="token operator">=</span> system_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  TmpMaxMutationLen <span class="token operator">=</span>
      <span class="token function">Min</span><span class="token punctuation">(</span>MaxMutationLen<span class="token punctuation">,</span> <span class="token function">Max</span><span class="token punctuation">(</span><span class="token function">size_t</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Corpus<span class="token punctuation">.</span><span class="token function">MaxInputSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>首先进入函数，初始化DTF和TPC， 分别表示<code>DataFlowTrace</code>和<code>TracePC</code>，</p> <p>然后先运行用户给定的语料， 确定一下目前的覆盖率，</p> <p>然后开始进入循环</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> Now <span class="token operator">=</span> system_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Options<span class="token punctuation">.</span>StopFile<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token function">FileToVector</span><span class="token punctuation">(</span>Options<span class="token punctuation">.</span>StopFile<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token generic-function"><span class="token function">duration_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>seconds<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>Now <span class="token operator">-</span> LastCorpusReload<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span>
        Options<span class="token punctuation">.</span>ReloadIntervalSec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">RereadOutputCorpus</span><span class="token punctuation">(</span>MaxInputLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
      LastCorpusReload <span class="token operator">=</span> system_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>TotalNumberOfRuns <span class="token operator">&gt;=</span> Options<span class="token punctuation">.</span>MaxNumberOfRuns<span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">TimedOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token comment">// Update TmpMaxMutationLen</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Options<span class="token punctuation">.</span>LenControl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>TmpMaxMutationLen <span class="token operator">&lt;</span> MaxMutationLen <span class="token operator">&amp;&amp;</span>
          TotalNumberOfRuns <span class="token operator">-</span> LastCorpusUpdateRun <span class="token operator">&gt;</span>
              Options<span class="token punctuation">.</span>LenControl <span class="token operator">*</span> <span class="token function">Log</span><span class="token punctuation">(</span>TmpMaxMutationLen<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        TmpMaxMutationLen <span class="token operator">=</span>
            <span class="token function">Min</span><span class="token punctuation">(</span>MaxMutationLen<span class="token punctuation">,</span> TmpMaxMutationLen <span class="token operator">+</span> <span class="token function">Log</span><span class="token punctuation">(</span>TmpMaxMutationLen<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        LastCorpusUpdateRun <span class="token operator">=</span> TotalNumberOfRuns<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      TmpMaxMutationLen <span class="token operator">=</span> MaxMutationLen<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Perform several mutations and runs.</span>
    <span class="token function">MutateAndTestOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">PurgeAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>首先是判断时间和运行次数等，决定是否退出，然后更新一下编译的最大长度，而后进入<code>MatateAndTestOne</code>函数，进行变异和运行。</p> <h3 id="fuzzer-mutateandtestone"><a href="#fuzzer-mutateandtestone" class="header-anchor">#</a> Fuzzer::MutateAndTestOne</h3> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token class-name">Fuzzer</span><span class="token double-colon punctuation">::</span><span class="token function">MutateAndTestOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  MD<span class="token punctuation">.</span><span class="token function">StartMutationSequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">auto</span> <span class="token operator">&amp;</span>II <span class="token operator">=</span> Corpus<span class="token punctuation">.</span><span class="token function">ChooseUnitToMutate</span><span class="token punctuation">(</span>MD<span class="token punctuation">.</span><span class="token function">GetRand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Options<span class="token punctuation">.</span>DoCrossOver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> <span class="token operator">&amp;</span>CrossOverII <span class="token operator">=</span> Corpus<span class="token punctuation">.</span><span class="token function">ChooseUnitToCrossOverWith</span><span class="token punctuation">(</span>
        MD<span class="token punctuation">.</span><span class="token function">GetRand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Options<span class="token punctuation">.</span>CrossOverUniformDist<span class="token punctuation">)</span><span class="token punctuation">;</span>
    MD<span class="token punctuation">.</span><span class="token function">SetCrossOverWith</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>CrossOverII<span class="token punctuation">.</span>U<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token keyword">auto</span> <span class="token operator">&amp;</span>U <span class="token operator">=</span> II<span class="token punctuation">.</span>U<span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>BaseSha1<span class="token punctuation">,</span> II<span class="token punctuation">.</span>Sha1<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>BaseSha1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>CurrentUnitData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  size_t Size <span class="token operator">=</span> U<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>Size <span class="token operator">&lt;=</span> MaxInputLen <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;Oversized Unit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>CurrentUnitData<span class="token punctuation">,</span> U<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Size<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">assert</span><span class="token punctuation">(</span>MaxMutationLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  size_t CurrentMaxMutationLen <span class="token operator">=</span>
      <span class="token function">Min</span><span class="token punctuation">(</span>MaxMutationLen<span class="token punctuation">,</span> <span class="token function">Max</span><span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TmpMaxMutationLen<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>CurrentMaxMutationLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>函数开始， 主要是一些变量的初始化，比较重要的是<code>II</code>， 这是一个<code>InputInfo</code>结构体，表示一个输入的语料， 通过之前提到的<code>InputCorpus</code>对象管理，定义在 <code>Vector&lt;InputInfo*&gt; InputCorpus::Inputs;</code>, 这里通过函数获取， 其实就是随机选择一个出来。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>InputInfo <span class="token operator">&amp;</span><span class="token function">ChooseUnitToMutate</span><span class="token punctuation">(</span>Random <span class="token operator">&amp;</span>Rand<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  InputInfo <span class="token operator">&amp;</span>II <span class="token operator">=</span> <span class="token operator">*</span>Inputs<span class="token punctuation">[</span><span class="token function">ChooseUnitIdxToMutate</span><span class="token punctuation">(</span>Rand<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>II<span class="token punctuation">.</span>U<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> II<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>接下来是变异和运行部分。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Options<span class="token punctuation">.</span>MutateDepth<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>TotalNumberOfRuns <span class="token operator">&gt;=</span> Options<span class="token punctuation">.</span>MaxNumberOfRuns<span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token function">MaybeExitGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    size_t NewSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>II<span class="token punctuation">.</span>HasFocusFunction <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>II<span class="token punctuation">.</span>DataFlowTraceForFocusFunction<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        Size <span class="token operator">&lt;=</span> CurrentMaxMutationLen<span class="token punctuation">)</span>
      NewSize <span class="token operator">=</span> MD<span class="token punctuation">.</span><span class="token function">MutateWithMask</span><span class="token punctuation">(</span>CurrentUnitData<span class="token punctuation">,</span> Size<span class="token punctuation">,</span> Size<span class="token punctuation">,</span>
                                  II<span class="token punctuation">.</span>DataFlowTraceForFocusFunction<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// If MutateWithMask either failed or wasn't called, call default Mutate.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>NewSize<span class="token punctuation">)</span>
      NewSize <span class="token operator">=</span> MD<span class="token punctuation">.</span><span class="token function">Mutate</span><span class="token punctuation">(</span>CurrentUnitData<span class="token punctuation">,</span> Size<span class="token punctuation">,</span> CurrentMaxMutationLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>NewSize <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;Mutator returned empty unit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>NewSize <span class="token operator">&lt;=</span> CurrentMaxMutationLen <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;Mutator return oversized unit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Size <span class="token operator">=</span> NewSize<span class="token punctuation">;</span>
    II<span class="token punctuation">.</span>NumExecutedMutations<span class="token operator">++</span><span class="token punctuation">;</span>
    Corpus<span class="token punctuation">.</span><span class="token function">IncrementNumExecutedMutations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">bool</span> FoundUniqFeatures <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> NewCov <span class="token operator">=</span> <span class="token function">RunOne</span><span class="token punctuation">(</span>CurrentUnitData<span class="token punctuation">,</span> Size<span class="token punctuation">,</span> <span class="token comment">/*MayDeleteFile=*/</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>II<span class="token punctuation">,</span>
                         <span class="token comment">/*ForceAddToCorpus*/</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>FoundUniqFeatures<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TryDetectingAMemoryLeak</span><span class="token punctuation">(</span>CurrentUnitData<span class="token punctuation">,</span> Size<span class="token punctuation">,</span>
                            <span class="token comment">/*DuringInitialCorpusExecution*/</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>NewCov<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">ReportNewCoverage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>II<span class="token punctuation">,</span> <span class="token punctuation">{</span>CurrentUnitData<span class="token punctuation">,</span> CurrentUnitData <span class="token operator">+</span> Size<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token comment">// We will mutate this input more in the next rounds.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Options<span class="token punctuation">.</span>ReduceDepth <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>FoundUniqFeatures<span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>通过函数<code>MD.MutateWithMask</code>和函数<code>MD.Mutate</code>进行变异，然后通过函数<code>RunOne</code>进行运行测试，如果返回出现了新的路径的话， 会退出。</p> <p>for循环的判断条件是 <code>Options.MutateDepth</code>.</p> <h3 id="executecallback"><a href="#executecallback" class="header-anchor">#</a> ExecuteCallback</h3> <p>进入<code>Fuzzer::RunOne</code>函数以后，首先是运行函数<code>ExecuteCallback</code></p> <p>首先是准备数据，主要是<code>DataCopy</code>，</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>ATTRIBUTE_NOINLINE <span class="token keyword">void</span> <span class="token class-name">Fuzzer</span><span class="token double-colon punctuation">::</span><span class="token function">ExecuteCallback</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>Data<span class="token punctuation">,</span>
                                                size_t Size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  TPC<span class="token punctuation">.</span><span class="token function">RecordInitialStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  TotalNumberOfRuns<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">InFuzzingThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// We copy the contents of Unit into a separate heap buffer</span>
  <span class="token comment">// so that we reliably find buffer overflows in it.</span>
  <span class="token keyword">uint8_t</span> <span class="token operator">*</span>DataCopy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">uint8_t</span><span class="token punctuation">[</span>Size<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>DataCopy<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>EF<span class="token operator">-&gt;</span>__msan_unpoison<span class="token punctuation">)</span>
    EF<span class="token operator">-&gt;</span><span class="token function">__msan_unpoison</span><span class="token punctuation">(</span>DataCopy<span class="token punctuation">,</span> Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>EF<span class="token operator">-&gt;</span>__msan_unpoison_param<span class="token punctuation">)</span>
    EF<span class="token operator">-&gt;</span><span class="token function">__msan_unpoison_param</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>CurrentUnitData <span class="token operator">&amp;&amp;</span> CurrentUnitData <span class="token operator">!=</span> Data<span class="token punctuation">)</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>CurrentUnitData<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  CurrentUnitSize <span class="token operator">=</span> Size<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>以下代码中比较重要的位置是<code>CB(DataCopy, Size)</code>， 因为这个CB其实是fuzzer对象初始化的时候传入的<code>Callback</code>参数， 也就是我们定义的<code>LLVMFuzzerTestOneInput</code>，</p> <p>其他部分主要是对于获取覆盖率相关的操作，我们后续会讲到。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>  <span class="token punctuation">{</span>
    ScopedEnableMsanInterceptorChecks S<span class="token punctuation">;</span>
    AllocTracer<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>Options<span class="token punctuation">.</span>TraceMalloc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    UnitStartTime <span class="token operator">=</span> system_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    TPC<span class="token punctuation">.</span><span class="token function">ResetMaps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    RunningUserCallback <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> Res <span class="token operator">=</span> <span class="token function">CB</span><span class="token punctuation">(</span>DataCopy<span class="token punctuation">,</span> Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    RunningUserCallback <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    UnitStopTime <span class="token operator">=</span> system_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>Res<span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>Res <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    HasMoreMallocsThanFrees <span class="token operator">=</span> AllocTracer<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">LooseMemeq</span><span class="token punctuation">(</span>DataCopy<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> Size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">CrashOnOverwrittenData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  CurrentUnitSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> DataCopy<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>最后经过简单的处理即可退出， 注意<code>LooseMemeq</code>这个位置，如果运行前后的数据被修改了的话，会直接认为是crash，</p> <blockquote><p>但是似乎定义是<code>LLVMFuzzerTestOneInput(const size_8* Data, size_t Size)</code>, 应该是不会被修改才对。</p></blockquote> <h2 id="多线程运行"><a href="#多线程运行" class="header-anchor">#</a> 多线程运行</h2> <h3 id="runinmultipleprocesses"><a href="#runinmultipleprocesses" class="header-anchor">#</a> RunInMultipleProcesses</h3> <p>让我们回到最开始，我们前面提到过，libfuzz一般遇到某个crash以后会直接退出， 如果想类似afl一样并行进行fuzz的话可以使用 <code>work</code> 和 <code>job</code>达到类似效果</p> <p>定义在<code>FuzzerFlag.def</code>文件中</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>FUZZER_FLAG_UNSIGNED(jobs, 0, &quot;Number of jobs to run. If jobs &gt;= 1 we spawn&quot;
                          &quot; this number of jobs in separate worker processes&quot;
                          &quot; with stdout/stderr redirected to fuzz-JOB.log.&quot;)
FUZZER_FLAG_UNSIGNED(workers, 0,
            &quot;Number of simultaneous worker processes to run the jobs.&quot;
            &quot; If zero, \&quot;min(jobs,NumberOfCpuCores()/2)\&quot; is used.&quot;)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>jobs表示，我们预计运行多少个并行的fuzz程序， workers表示我们libfuzzer会具体分成多少个线程去并发执行。</p> <p>在默认情况下，libfuzzer只是单线程运行， 在函数 <code>FuzzerDriver</code>中， 对并发执行这部分做出实现</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Flags<span class="token punctuation">.</span>jobs <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> Flags<span class="token punctuation">.</span>workers <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Flags<span class="token punctuation">.</span>workers <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token function">NumberOfCpuCores</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> Flags<span class="token punctuation">.</span>jobs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Flags<span class="token punctuation">.</span>workers <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Running %u workers\n&quot;</span><span class="token punctuation">,</span> Flags<span class="token punctuation">.</span>workers<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>Flags<span class="token punctuation">.</span>workers <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> Flags<span class="token punctuation">.</span>jobs <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">RunInMultipleProcesses</span><span class="token punctuation">(</span>Args<span class="token punctuation">,</span> Flags<span class="token punctuation">.</span>workers<span class="token punctuation">,</span> Flags<span class="token punctuation">.</span>jobs<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>可以看到，如果jobs存在的话，会设置默认的workers， 也可以手动指定。
这两个参数直接传入<code>RunInMultipleProcesses</code>函数，进行并发运行，</p> <p>这个函数实现也很简单， 就是去掉jobs和workers选项， 然后开启workers数量的线程来运行libfuzzer，</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">RunInMultipleProcesses</span><span class="token punctuation">(</span><span class="token keyword">const</span> Vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>Args<span class="token punctuation">,</span>
                                  <span class="token keyword">unsigned</span> NumWorkers<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> NumJobs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">unsigned</span><span class="token operator">&gt;</span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;</span> <span class="token function">HasErrors</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Command <span class="token function">Cmd</span><span class="token punctuation">(</span>Args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Cmd<span class="token punctuation">.</span><span class="token function">removeFlag</span><span class="token punctuation">(</span><span class="token string">&quot;jobs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Cmd<span class="token punctuation">.</span><span class="token function">removeFlag</span><span class="token punctuation">(</span><span class="token string">&quot;workers&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">&gt;</span> V<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>thread <span class="token function">Pulse</span><span class="token punctuation">(</span>PulseThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Pulse<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NumWorkers<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    V<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span>WorkerThread<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">ref</span><span class="token punctuation">(</span>Cmd<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>Counter<span class="token punctuation">,</span> NumJobs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>HasErrors<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>T <span class="token operator">:</span> V<span class="token punctuation">)</span>
    T<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> HasErrors <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="fork模式"><a href="#fork模式" class="header-anchor">#</a> fork模式</h3> <p>还可以通过<code>-fork=x</code>选项启动fork模式，看起来是上面提到的jobs和works的融合提高版？</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span>Flags<span class="token punctuation">.</span>fork<span class="token punctuation">)</span>
    <span class="token function">FuzzWithFork</span><span class="token punctuation">(</span>F<span class="token operator">-&gt;</span><span class="token function">GetMD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetRand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Options<span class="token punctuation">,</span> Args<span class="token punctuation">,</span> <span class="token operator">*</span>Inputs<span class="token punctuation">,</span> Flags<span class="token punctuation">.</span>fork<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>有一个特别点在于，fork的判断和运行其实是在jobs运行之后的，也就是说如果同时设置，会先运行jobs的逻辑，</p></blockquote> <p>首先会创建一个临时目录， 存放所需要的信息，这是有个一定目录结构的，</p> <p>然后进行对线程的设置和启动，</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>  size_t JobId <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  Vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">&gt;</span> Threads<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> t <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> t <span class="token operator">&lt;</span> NumJobs<span class="token punctuation">;</span> t<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Threads<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span>WorkerThread<span class="token punctuation">,</span> <span class="token operator">&amp;</span>FuzzQ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>MergeQ<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    FuzzQ<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>Env<span class="token punctuation">.</span><span class="token function">CreateNewJob</span><span class="token punctuation">(</span>JobId<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>向下调用， <code>WorkThread</code>函数，其实就是调用了system函数去运行系统命令。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">WorkerThread</span><span class="token punctuation">(</span>JobQueue <span class="token operator">*</span>FuzzQ<span class="token punctuation">,</span> JobQueue <span class="token operator">*</span>MergeQ<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> Job <span class="token operator">=</span> FuzzQ<span class="token operator">-&gt;</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Printf(&quot;WorkerThread: job %p\n&quot;, Job);</span>
    Job<span class="token operator">-&gt;</span>ExitCode <span class="token operator">=</span> <span class="token function">ExecuteCommand</span><span class="token punctuation">(</span>Job<span class="token operator">-&gt;</span>Cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    MergeQ<span class="token operator">-&gt;</span><span class="token function">Push</span><span class="token punctuation">(</span>Job<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">ExecuteCommand</span><span class="token punctuation">(</span><span class="token keyword">const</span> Command <span class="token operator">&amp;</span>Cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  std<span class="token double-colon punctuation">::</span>string CmdLine <span class="token operator">=</span> Cmd<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Printf(&quot;system: %s\n&quot;, CmdLine.c_str());</span>
  <span class="token keyword">int</span> exit_code <span class="token operator">=</span> <span class="token function">system</span><span class="token punctuation">(</span>CmdLine<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>exit_code<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>exit_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> exit_code<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>我们可以增加一个printf并重新编译， 可以看到通过<code>Env.CreateNewJob</code>函数生成出来的job的内容，</p> <p><img src="https://s2.loli.net/2022/05/13/EJrj4a7wbu2LVXe.png" alt="image.png"></p> <p>这里其实和<code>WorkerThread</code>函数是对应的，通过<code>Job-&gt;ExitCode</code>和<code>MergeQ</code>传递数据。
主要是对于退出状态的处理，如果不是可以退出的状态的话，会继续向<code>FuzzeQ</code>写入Job，让线程继续持续性运行。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>FuzzJob<span class="token operator">&gt;</span> <span class="token function">Job</span><span class="token punctuation">(</span>MergeQ<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Job<span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    ExitCode <span class="token operator">=</span> Job<span class="token operator">-&gt;</span>ExitCode<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ExitCode <span class="token operator">==</span> Options<span class="token punctuation">.</span>InterruptExitCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;==%lu== libFuzzer: a child was interrupted; exiting\n&quot;</span><span class="token punctuation">,</span> <span class="token function">GetPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">StopJobs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Fuzzer</span><span class="token double-colon punctuation">::</span><span class="token function">MaybeExitGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Env<span class="token punctuation">.</span><span class="token function">RunOneMergeJob</span><span class="token punctuation">(</span>Job<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Continue if our crash is one of the ignorred ones.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Options<span class="token punctuation">.</span>IgnoreTimeouts <span class="token operator">&amp;&amp;</span> ExitCode <span class="token operator">==</span> Options<span class="token punctuation">.</span>TimeoutExitCode<span class="token punctuation">)</span>
      Env<span class="token punctuation">.</span>NumTimeouts<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Options<span class="token punctuation">.</span>IgnoreOOMs <span class="token operator">&amp;&amp;</span> ExitCode <span class="token operator">==</span> Options<span class="token punctuation">.</span>OOMExitCode<span class="token punctuation">)</span>
      Env<span class="token punctuation">.</span>NumOOMs<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ExitCode <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Env<span class="token punctuation">.</span>NumCrashes<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Options<span class="token punctuation">.</span>IgnoreCrashes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>ifstream <span class="token function">In</span><span class="token punctuation">(</span>Job<span class="token operator">-&gt;</span>LogPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>string Line<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">getline</span><span class="token punctuation">(</span>In<span class="token punctuation">,</span> Line<span class="token punctuation">,</span> <span class="token char">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>Line<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">&quot;ERROR:&quot;</span><span class="token punctuation">)</span> <span class="token operator">!=</span> Line<span class="token punctuation">.</span>npos <span class="token operator">||</span>
              Line<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">&quot;runtime error:&quot;</span><span class="token punctuation">)</span> <span class="token operator">!=</span> Line<span class="token punctuation">.</span>npos<span class="token punctuation">)</span>
            <span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s\n&quot;</span><span class="token punctuation">,</span> Line<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// And exit if we don't ignore this crash.</span>
        <span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;INFO: log from the inner process:\n%s&quot;</span><span class="token punctuation">,</span>
               <span class="token function">FileToString</span><span class="token punctuation">(</span>Job<span class="token operator">-&gt;</span>LogPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">StopJobs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Stop if we are over the time budget.</span>
    <span class="token comment">// This is not precise, since other threads are still running</span>
    <span class="token comment">// and we will wait while joining them.</span>
    <span class="token comment">// We also don't stop instantly: other jobs need to finish.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Options<span class="token punctuation">.</span>MaxTotalTimeSec <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
        Env<span class="token punctuation">.</span><span class="token function">secondsSinceProcessStartUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>Options<span class="token punctuation">.</span>MaxTotalTimeSec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;INFO: fuzzed for %zd seconds, wrapping up soon\n&quot;</span><span class="token punctuation">,</span>
             Env<span class="token punctuation">.</span><span class="token function">secondsSinceProcessStartUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">StopJobs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Env<span class="token punctuation">.</span>NumRuns <span class="token operator">&gt;=</span> Options<span class="token punctuation">.</span>MaxNumberOfRuns<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;INFO: fuzzed for %zd iterations, wrapping up soon\n&quot;</span><span class="token punctuation">,</span>
             Env<span class="token punctuation">.</span>NumRuns<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">StopJobs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    FuzzQ<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>Env<span class="token punctuation">.</span><span class="token function">CreateNewJob</span><span class="token punctuation">(</span>JobId<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>最后是回收线程，然后删除临时文件夹。</p> <blockquote><p>总感觉这个删除临时文件夹很奇怪，这些运行时的数据应该和种子差不多重要，但是只是在更新种子，没有去保留临时文件夹。而且我遇到了一次第二天运行覆盖率下降了，很奇怪，感觉和这个有关。</p></blockquote> <h2 id="变异策略"><a href="#变异策略" class="header-anchor">#</a> 变异策略</h2> <p>前面提到， 变异控制器初始化实在<code>FuzzerDriver</code>函数，使用直接调用的<code>MutationDispatcher::MutateWithMask</code>和<code>MutationDispatch::Mutate</code>， 着重看一下这三个位置的逻辑。</p> <h3 id="mutationdispatcher-mutationdispatcher"><a href="#mutationdispatcher-mutationdispatcher" class="header-anchor">#</a> MutationDispatcher::MUtationDispatcher</h3> <p>首先初始化，直接设置Rand和Options成员变量。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token class-name">MutationDispatcher</span><span class="token double-colon punctuation">::</span><span class="token function">MutationDispatcher</span><span class="token punctuation">(</span>Random <span class="token operator">&amp;</span>Rand<span class="token punctuation">,</span>
                                       <span class="token keyword">const</span> FuzzingOptions <span class="token operator">&amp;</span>Options<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">Rand</span><span class="token punctuation">(</span>Rand<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Options</span><span class="token punctuation">(</span>Options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>然后设置<code>DefaultMutators</code>局部变量。</p> <p>这里就是libfuzzer内置的12个变异方式和一个按照运行状态决定是否开启的变异。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>  DefaultMutators<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>
      DefaultMutators<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
          <span class="token punctuation">{</span><span class="token operator">&amp;</span>MutationDispatcher<span class="token double-colon punctuation">::</span>Mutate_EraseBytes<span class="token punctuation">,</span> <span class="token string">&quot;EraseBytes&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span><span class="token operator">&amp;</span>MutationDispatcher<span class="token double-colon punctuation">::</span>Mutate_InsertByte<span class="token punctuation">,</span> <span class="token string">&quot;InsertByte&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span><span class="token operator">&amp;</span>MutationDispatcher<span class="token double-colon punctuation">::</span>Mutate_InsertRepeatedBytes<span class="token punctuation">,</span>
           <span class="token string">&quot;InsertRepeatedBytes&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span><span class="token operator">&amp;</span>MutationDispatcher<span class="token double-colon punctuation">::</span>Mutate_ChangeByte<span class="token punctuation">,</span> <span class="token string">&quot;ChangeByte&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span><span class="token operator">&amp;</span>MutationDispatcher<span class="token double-colon punctuation">::</span>Mutate_ChangeBit<span class="token punctuation">,</span> <span class="token string">&quot;ChangeBit&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span><span class="token operator">&amp;</span>MutationDispatcher<span class="token double-colon punctuation">::</span>Mutate_ShuffleBytes<span class="token punctuation">,</span> <span class="token string">&quot;ShuffleBytes&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span><span class="token operator">&amp;</span>MutationDispatcher<span class="token double-colon punctuation">::</span>Mutate_ChangeASCIIInteger<span class="token punctuation">,</span> <span class="token string">&quot;ChangeASCIIInt&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span><span class="token operator">&amp;</span>MutationDispatcher<span class="token double-colon punctuation">::</span>Mutate_ChangeBinaryInteger<span class="token punctuation">,</span> <span class="token string">&quot;ChangeBinInt&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span><span class="token operator">&amp;</span>MutationDispatcher<span class="token double-colon punctuation">::</span>Mutate_CopyPart<span class="token punctuation">,</span> <span class="token string">&quot;CopyPart&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span><span class="token operator">&amp;</span>MutationDispatcher<span class="token double-colon punctuation">::</span>Mutate_CrossOver<span class="token punctuation">,</span> <span class="token string">&quot;CrossOver&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span><span class="token operator">&amp;</span>MutationDispatcher<span class="token double-colon punctuation">::</span>Mutate_AddWordFromManualDictionary<span class="token punctuation">,</span>
           <span class="token string">&quot;ManualDict&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span><span class="token operator">&amp;</span>MutationDispatcher<span class="token double-colon punctuation">::</span>Mutate_AddWordFromPersistentAutoDictionary<span class="token punctuation">,</span>
           <span class="token string">&quot;PersAutoDict&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>Options<span class="token punctuation">.</span>UseCmp<span class="token punctuation">)</span>
    DefaultMutators<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span><span class="token operator">&amp;</span>MutationDispatcher<span class="token double-colon punctuation">::</span>Mutate_AddWordFromTORC<span class="token punctuation">,</span> <span class="token string">&quot;CMP&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>接下来是重点位置。</p> <p>如果用户自定义了变异函数<code>LLVMFuzzerCustomMutator</code>， 那么会直接将<code>Mutators</code>设置为这个函数，如果未设置的话，<code>Mutator=DefaultMutators</code>，</p> <p>在后续的使用中， 两个变异函数都是直接调用<code>Mutators</code>内的变异函数进行变异，也就是说，这段逻辑是在 使用自定义变异器和使用默认变异器 之间二选一。</p> <p>最后如果设置<code>LLVMFuzzerCustomCrossOver</code>的话，可以追加上，这个自定义变异可以和默认变异一起使用。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span>EF<span class="token operator">-&gt;</span>LLVMFuzzerCustomMutator<span class="token punctuation">)</span>
    Mutators<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token operator">&amp;</span>MutationDispatcher<span class="token double-colon punctuation">::</span>Mutate_Custom<span class="token punctuation">,</span> <span class="token string">&quot;Custom&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    Mutators <span class="token operator">=</span> DefaultMutators<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>EF<span class="token operator">-&gt;</span>LLVMFuzzerCustomCrossOver<span class="token punctuation">)</span>
    Mutators<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span><span class="token operator">&amp;</span>MutationDispatcher<span class="token double-colon punctuation">::</span>Mutate_CustomCrossOver<span class="token punctuation">,</span> <span class="token string">&quot;CustomCrossOver&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>libfuzzer的这个位置提供了足够的拓展性， 可以自己实现变异策略， 结构化fuzz实现之一的<code>libprotobuf-mutator</code>就是实现了一个自定义的变异器，然后和libfuzz组合在一起使用。</p></blockquote> <p>跟进一下两个函数， 其实就是稍做检查，然后直接调用EF中对应函数</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>size_t <span class="token class-name">MutationDispatcher</span><span class="token double-colon punctuation">::</span><span class="token function">Mutate_Custom</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> <span class="token operator">*</span>Data<span class="token punctuation">,</span> size_t Size<span class="token punctuation">,</span>
                                         size_t MaxSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>EF<span class="token operator">-&gt;</span>__msan_unpoison<span class="token punctuation">)</span>
    EF<span class="token operator">-&gt;</span><span class="token function">__msan_unpoison</span><span class="token punctuation">(</span>Data<span class="token punctuation">,</span> Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>EF<span class="token operator">-&gt;</span>__msan_unpoison_param<span class="token punctuation">)</span>
    EF<span class="token operator">-&gt;</span><span class="token function">__msan_unpoison_param</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> EF<span class="token operator">-&gt;</span><span class="token function">LLVMFuzzerCustomMutator</span><span class="token punctuation">(</span>Data<span class="token punctuation">,</span> Size<span class="token punctuation">,</span> MaxSize<span class="token punctuation">,</span>
                                     Rand<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">Rand</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

size_t <span class="token class-name">MutationDispatcher</span><span class="token double-colon punctuation">::</span><span class="token function">Mutate_CustomCrossOver</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> <span class="token operator">*</span>Data<span class="token punctuation">,</span> size_t Size<span class="token punctuation">,</span>
                                                  size_t MaxSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>CrossOverWith<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> Unit <span class="token operator">&amp;</span>Other <span class="token operator">=</span> <span class="token operator">*</span>CrossOverWith<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Other<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  CustomCrossOverInPlaceHere<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>MaxSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> <span class="token operator">&amp;</span>U <span class="token operator">=</span> CustomCrossOverInPlaceHere<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>EF<span class="token operator">-&gt;</span>__msan_unpoison<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    EF<span class="token operator">-&gt;</span><span class="token function">__msan_unpoison</span><span class="token punctuation">(</span>Data<span class="token punctuation">,</span> Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    EF<span class="token operator">-&gt;</span><span class="token function">__msan_unpoison</span><span class="token punctuation">(</span>Other<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Other<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    EF<span class="token operator">-&gt;</span><span class="token function">__msan_unpoison</span><span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> U<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>EF<span class="token operator">-&gt;</span>__msan_unpoison_param<span class="token punctuation">)</span>
    EF<span class="token operator">-&gt;</span><span class="token function">__msan_unpoison_param</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  size_t NewSize <span class="token operator">=</span> EF<span class="token operator">-&gt;</span><span class="token function">LLVMFuzzerCustomCrossOver</span><span class="token punctuation">(</span>
      Data<span class="token punctuation">,</span> Size<span class="token punctuation">,</span> Other<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Other<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> U<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> U<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Rand<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">Rand</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>NewSize<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>NewSize <span class="token operator">&lt;=</span> MaxSize <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;CustomCrossOver returned overisized unit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>Data<span class="token punctuation">,</span> U<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> NewSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> NewSize<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h3 id="mutationdispatcher-mutatewithmask"><a href="#mutationdispatcher-mutatewithmask" class="header-anchor">#</a> MutationDispatcher::MutateWithMask</h3> <p>其实还是封装了<code>Mutate</code>， 但是通过参数<code>Mask</code>实现了一个对某些数值的屏蔽，</p> <p>将屏蔽处理完的数据给<code>Mutate</code>进行变异</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// Mask represents the set of Data bytes that are worth mutating.</span>
size_t <span class="token class-name">MutationDispatcher</span><span class="token double-colon punctuation">::</span><span class="token function">MutateWithMask</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> <span class="token operator">*</span>Data<span class="token punctuation">,</span> size_t Size<span class="token punctuation">,</span>
                                          size_t MaxSize<span class="token punctuation">,</span>
                                          <span class="token keyword">const</span> Vector<span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>Mask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size_t MaskedSize <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>Size<span class="token punctuation">,</span> Mask<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// * Copy the worthy bytes into a temporary array T</span>
  <span class="token comment">// * Mutate T</span>
  <span class="token comment">// * Copy T back.</span>
  <span class="token comment">// This is totally unoptimized.</span>
  <span class="token keyword">auto</span> <span class="token operator">&amp;</span>T <span class="token operator">=</span> MutateWithMaskTemp<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>T<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> Size<span class="token punctuation">)</span>
    T<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  size_t OneBits <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t I <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> I <span class="token operator">&lt;</span> MaskedSize<span class="token punctuation">;</span> I<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Mask<span class="token punctuation">[</span>I<span class="token punctuation">]</span><span class="token punctuation">)</span>
      T<span class="token punctuation">[</span>OneBits<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> Data<span class="token punctuation">[</span>I<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>OneBits<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>T<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  size_t NewSize <span class="token operator">=</span> <span class="token function">Mutate</span><span class="token punctuation">(</span>T<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> OneBits<span class="token punctuation">,</span> OneBits<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>NewSize <span class="token operator">&lt;=</span> OneBits<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>NewSize<span class="token punctuation">;</span>
  <span class="token comment">// Even if NewSize &lt; OneBits we still use all OneBits bytes.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t I <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> J <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> I <span class="token operator">&lt;</span> MaskedSize<span class="token punctuation">;</span> I<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Mask<span class="token punctuation">[</span>I<span class="token punctuation">]</span><span class="token punctuation">)</span>
      Data<span class="token punctuation">[</span>I<span class="token punctuation">]</span> <span class="token operator">=</span> T<span class="token punctuation">[</span>J<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Size<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="mutationdispatcher-mutate"><a href="#mutationdispatcher-mutate" class="header-anchor">#</a> MUtationDispatcher::Mutate</h3> <p>直接封装了<code>MutateImpl</code>， 传入的第四个参数就是我们前面看到的<code>Mutators</code>，</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>size_t <span class="token class-name">MutationDispatcher</span><span class="token double-colon punctuation">::</span><span class="token function">Mutate</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> <span class="token operator">*</span>Data<span class="token punctuation">,</span> size_t Size<span class="token punctuation">,</span> size_t MaxSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">MutateImpl</span><span class="token punctuation">(</span>Data<span class="token punctuation">,</span> Size<span class="token punctuation">,</span> MaxSize<span class="token punctuation">,</span> Mutators<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在紧挨着还有个一个对于<code>MutateImpl</code>的封装函数, 是使用的<code>DefaultMutators</code>， 这个函数在libfuzzer中基本没有使用。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>size_t <span class="token class-name">MutationDispatcher</span><span class="token double-colon punctuation">::</span><span class="token function">DefaultMutate</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> <span class="token operator">*</span>Data<span class="token punctuation">,</span> size_t Size<span class="token punctuation">,</span>
                                         size_t MaxSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">MutateImpl</span><span class="token punctuation">(</span>Data<span class="token punctuation">,</span> Size<span class="token punctuation">,</span> MaxSize<span class="token punctuation">,</span> DefaultMutators<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>这就是我们前面提到的， 变异都是使用的<code>Mutators</code>，
对于<code>DefaultMutate</code>函数，似乎在配合afl使用的时候会被调用到。</p></blockquote> <p>继续向下分析，<code>MutationDispatcher::MutateImpl</code>函数实现也比较简单， 穿工服100次， 通过随机数选择变异方式，然后直接调用，如果设置只能是ASCII字符的话，会进行一次转换，然后变异方式会放入<code>CurrentMutatorSequence</code>，</p> <blockquote><p>这个<code>CurrentMutatorSequence</code>主要的功能 就是打印信息，</p></blockquote> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// Mutates Data in place, returns new size.</span>
size_t <span class="token class-name">MutationDispatcher</span><span class="token double-colon punctuation">::</span><span class="token function">MutateImpl</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> <span class="token operator">*</span>Data<span class="token punctuation">,</span> size_t Size<span class="token punctuation">,</span>
                                      size_t MaxSize<span class="token punctuation">,</span>
                                      Vector<span class="token operator">&lt;</span>Mutator<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>Mutators<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>MaxSize <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Some mutations may fail (e.g. can't insert more bytes if Size == MaxSize),</span>
  <span class="token comment">// in which case they will return 0.</span>
  <span class="token comment">// Try several times before returning un-mutated data.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> Iter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> Iter <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> Iter<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> M <span class="token operator">=</span> Mutators<span class="token punctuation">[</span><span class="token function">Rand</span><span class="token punctuation">(</span>Mutators<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    size_t NewSize <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token operator">*</span><span class="token punctuation">(</span>M<span class="token punctuation">.</span>Fn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Data<span class="token punctuation">,</span> Size<span class="token punctuation">,</span> MaxSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>NewSize <span class="token operator">&amp;&amp;</span> NewSize <span class="token operator">&lt;=</span> MaxSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Options<span class="token punctuation">.</span>OnlyASCII<span class="token punctuation">)</span>
        <span class="token function">ToASCII</span><span class="token punctuation">(</span>Data<span class="token punctuation">,</span> NewSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
      CurrentMutatorSequence<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> NewSize<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token operator">*</span>Data <span class="token operator">=</span> <span class="token char">' '</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">// Fallback, should not happen frequently.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="变异方案"><a href="#变异方案" class="header-anchor">#</a> 变异方案</h3> <p>相比较于afl 确定性变异的一点点运行和破坏模式的胡乱拼装，libfuzzer显得非常克制。</p> <p>类似afl的基于默认数据进行的变异， libfuzzer对随机产生的数据也会进行对于原本数据的修改：</p> <ul><li><p>EraseBytes: 随机删除某些内容</p></li> <li><p>InsertByte: 向随机位置增加一个随机数据</p></li> <li><p>InsertRepeatedBytes：向随机位置重复增加随机数量的某个随机数</p></li> <li><p>ChangeByte: 随即替换某个byte为随机数</p></li> <li><p>ChangeBit:  随机替换某个Bit为随机数</p></li> <li><p>ShuffleBytes: 通过<code>std::shuffle</code>在随机一段打乱顺序</p></li> <li><p>ChangeASCIIInteger: 在数据中尝试寻找数字的ascii，获取到以后随机进行数字运算，再写入回去。</p></li> <li><p>ChangeBinaryInteger: 随机位置的字节反序， 其实就是调用了 <code>__builtin_bswapxx</code>系列函数。</p></li> <li><p>CopyPart: 随机替换或者插入数据自身的一部分。</p></li> <li><p>CrossOver: 这个变异方法拥有一个成员变量<code>CrossOverWith</code>， 在<code>MutateAndTestOne</code>函数最开始会进行设定，这个变异和<code>CopyPart</code>类似，但是是对于不同样例之间。</p></li></ul> <p>然后是基于字典的变异两个：</p> <ul><li>AddWordFromManualDictionary: 从用户指定的字典中加入数据，</li> <li>AddwordFromPersistentAutoDictionary: 从libfuzzer自动探测到的字典加入数据。</li></ul> <p>其实上面两者都是调用同样的下层函数， 但是使用的字典不同:</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>
  <span class="token comment">// Dictionary provided by the user via -dict=DICT_FILE.</span>
  Dictionary ManualDictionary<span class="token punctuation">;</span>
  <span class="token comment">// Persistent dictionary modified by the fuzzer, consists of</span>
  <span class="token comment">// entries that led to successful discoveries in the past mutations.</span>
  Dictionary PersistentAutoDictionary<span class="token punctuation">;</span>


size_t <span class="token class-name">MutationDispatcher</span><span class="token double-colon punctuation">::</span><span class="token function">Mutate_AddWordFromManualDictionary</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> <span class="token operator">*</span>Data<span class="token punctuation">,</span> size_t Size<span class="token punctuation">,</span> size_t MaxSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">AddWordFromDictionary</span><span class="token punctuation">(</span>ManualDictionary<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> Size<span class="token punctuation">,</span> MaxSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
size_t <span class="token class-name">MutationDispatcher</span><span class="token double-colon punctuation">::</span><span class="token function">Mutate_AddWordFromPersistentAutoDictionary</span><span class="token punctuation">(</span>
    <span class="token keyword">uint8_t</span> <span class="token operator">*</span>Data<span class="token punctuation">,</span> size_t Size<span class="token punctuation">,</span> size_t MaxSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">AddWordFromDictionary</span><span class="token punctuation">(</span>PersistentAutoDictionary<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> Size<span class="token punctuation">,</span> MaxSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="addwordfromtorc"><a href="#addwordfromtorc" class="header-anchor">#</a> AddWordFromTORC</h3> <p>然后比较有特点的一个变异方案： AddWrodFromTORC
其实仍然是通过字典进行的变异方案，有趣的是这个字典数据来自于 <code>TPC.TORCxx</code>， 这是我们在cmp等位置插桩获取到的数据， 通过 基于这种数据的变异，可以探测到代码层的比较，从而对我们覆盖率影响较大，libfuzzer的变异效果应该会非常不错。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>size_t <span class="token class-name">MutationDispatcher</span><span class="token double-colon punctuation">::</span><span class="token function">Mutate_AddWordFromTORC</span><span class="token punctuation">(</span>
    <span class="token keyword">uint8_t</span> <span class="token operator">*</span>Data<span class="token punctuation">,</span> size_t Size<span class="token punctuation">,</span> size_t MaxSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Word W<span class="token punctuation">;</span>
  DictionaryEntry DE<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">Rand</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> X <span class="token operator">=</span> TPC<span class="token punctuation">.</span>TORC8<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>Rand<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">Rand</span><span class="token generic class-name"><span class="token operator">&lt;</span>size_t<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    DE <span class="token operator">=</span> <span class="token function">MakeDictionaryEntryFromCMP</span><span class="token punctuation">(</span>X<span class="token punctuation">.</span>A<span class="token punctuation">,</span> X<span class="token punctuation">.</span>B<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> X <span class="token operator">=</span> TPC<span class="token punctuation">.</span>TORC4<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>Rand<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">Rand</span><span class="token generic class-name"><span class="token operator">&lt;</span>size_t<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>X<span class="token punctuation">.</span>A <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>X<span class="token punctuation">.</span>B <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> Rand<span class="token punctuation">.</span><span class="token function">RandBool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      DE <span class="token operator">=</span> <span class="token function">MakeDictionaryEntryFromCMP</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span><span class="token punctuation">)</span>X<span class="token punctuation">.</span>A<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">uint16_t</span><span class="token punctuation">)</span>X<span class="token punctuation">.</span>B<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      DE <span class="token operator">=</span> <span class="token function">MakeDictionaryEntryFromCMP</span><span class="token punctuation">(</span>X<span class="token punctuation">.</span>A<span class="token punctuation">,</span> X<span class="token punctuation">.</span>B<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> X <span class="token operator">=</span> TPC<span class="token punctuation">.</span>TORCW<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>Rand<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">Rand</span><span class="token generic class-name"><span class="token operator">&lt;</span>size_t<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    DE <span class="token operator">=</span> <span class="token function">MakeDictionaryEntryFromCMP</span><span class="token punctuation">(</span>X<span class="token punctuation">.</span>A<span class="token punctuation">,</span> X<span class="token punctuation">.</span>B<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Options<span class="token punctuation">.</span>UseMemmem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">auto</span> X <span class="token operator">=</span> TPC<span class="token punctuation">.</span>MMT<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>Rand<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">Rand</span><span class="token generic class-name"><span class="token operator">&lt;</span>size_t<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      DE <span class="token operator">=</span> <span class="token function">DictionaryEntry</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token keyword">default</span><span class="token operator">:</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>另一个值得注意的是，这个创建的字典，最后会放入<code>CurrentDictionaryEntrySequence</code></p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>DE<span class="token punctuation">.</span><span class="token function">GetW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  Size <span class="token operator">=</span> <span class="token function">ApplyDictionaryEntry</span><span class="token punctuation">(</span>Data<span class="token punctuation">,</span> Size<span class="token punctuation">,</span> MaxSize<span class="token punctuation">,</span> DE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Size<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  DictionaryEntry <span class="token operator">&amp;</span>DERef <span class="token operator">=</span>
      CmpDictionaryEntriesDeque<span class="token punctuation">[</span>CmpDictionaryEntriesDequeIdx<span class="token operator">++</span> <span class="token operator">%</span>
                                kCmpDictionaryEntriesDequeSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
  DERef <span class="token operator">=</span> DE<span class="token punctuation">;</span>
  CurrentDictionaryEntrySequence<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DERef<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Size<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>而这个字典的主要作用就是设置<code>PersistentAutoDictionary</code>, 这里和我们前面提到的<code>AddWordFromPersistentAutoDictionary</code>串起来了。</p> <h2 id="插桩策略"><a href="#插桩策略" class="header-anchor">#</a> 插桩策略</h2> <h3 id="trace方法"><a href="#trace方法" class="header-anchor">#</a> trace方法</h3> <p>前面我们在使用中也看到了需要使用 <code>-fsanitize-coverage=trace-cmp</code>等编译选项设置插桩，但在对应位置插入函数调用以后，函数实现仍然是在libfuzzer中的，在文件<code>FuzzerTracePC.cpp</code>中，</p> <p>在文件中我们可以看到<code>trace-cmp</code>的实现，所有的比较位置都会被插入这个函数，传入的参数是两个比较的数据，然后继续还有switch div gep的实现，</p> <p>基本都是先通过<code>__builtin_return_address(0)</code>的封装获取到上层函数地址，然后进入<code>TPC::HandleCmp</code>函数，</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
ATTRIBUTE_TARGET_POPCNT ALWAYS_INLINE
ATTRIBUTE_NO_SANITIZE_ALL
<span class="token keyword">void</span> <span class="token class-name">TracePC</span><span class="token double-colon punctuation">::</span><span class="token function">HandleCmp</span><span class="token punctuation">(</span>uintptr_t PC<span class="token punctuation">,</span> T Arg1<span class="token punctuation">,</span> T Arg2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">uint64_t</span> ArgXor <span class="token operator">=</span> Arg1 <span class="token operator">^</span> Arg2<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span>
      TORC4<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>ArgXor<span class="token punctuation">,</span> Arg1<span class="token punctuation">,</span> Arg2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span>
      TORC8<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>ArgXor<span class="token punctuation">,</span> Arg1<span class="token punctuation">,</span> Arg2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> HammingDistance <span class="token operator">=</span> <span class="token function">Popcountll</span><span class="token punctuation">(</span>ArgXor<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// [0,64]</span>
  <span class="token keyword">uint64_t</span> AbsoluteDistance <span class="token operator">=</span> <span class="token punctuation">(</span>Arg1 <span class="token operator">==</span> Arg2 <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token function">Clzll</span><span class="token punctuation">(</span>Arg1 <span class="token operator">-</span> Arg2<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ValueProfileMap<span class="token punctuation">.</span><span class="token function">AddValue</span><span class="token punctuation">(</span>PC <span class="token operator">*</span> <span class="token number">128</span> <span class="token operator">+</span> HammingDistance<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ValueProfileMap<span class="token punctuation">.</span><span class="token function">AddValue</span><span class="token punctuation">(</span>PC <span class="token operator">*</span> <span class="token number">128</span> <span class="token operator">+</span> <span class="token number">64</span> <span class="token operator">+</span> AbsoluteDistance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>首先获取<code>ArgXor</code>并在<code>TORCx</code>中使用这个当作索引， 获得两个参数，在我们前面提到的变异中也是通过这个成员变量获取的数值。</p> <p>向后看后续函数定义， 其实libfuzzer还对strcmp、memcpy等进行了hook， 这些内存比较等函数会存放到<code>TORCW</code>成员变量。</p> <p>对于strstr\memmem这类的内存访问查找，会存放在<code>MMT</code>成员变量。</p> <h3 id="路径记录"><a href="#路径记录" class="header-anchor">#</a> 路径记录</h3> <h4 id="valueprofilemap"><a href="#valueprofilemap" class="header-anchor">#</a> ValueProfileMap</h4> <p>让我们回到 <code>HandleCmp</code>函数， 在后续的<code>ValueProfileMap</code>的设置， 这是关于路径记录的相关设置。</p> <p><code>ValueProfileMap.AddValue</code>的实现，可以看出来就是使用某一个bit表示当前的位置，</p> <p>但是注意这个传入的Value，在<code>TracePc::HandleCmp</code>中可以看到，这个数据是pc和两个参数运算后的结果。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>  <span class="token keyword">inline</span> <span class="token keyword">bool</span> <span class="token function">AddValue</span><span class="token punctuation">(</span>uintptr_t Value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    uintptr_t Idx <span class="token operator">=</span> Value <span class="token operator">%</span> kMapSizeInBits<span class="token punctuation">;</span>
    uintptr_t WordIdx <span class="token operator">=</span> Idx <span class="token operator">/</span> kBitsInWord<span class="token punctuation">;</span>
    uintptr_t BitIdx <span class="token operator">=</span> Idx <span class="token operator">%</span> kBitsInWord<span class="token punctuation">;</span>
    uintptr_t Old <span class="token operator">=</span> Map<span class="token punctuation">[</span>WordIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    uintptr_t New <span class="token operator">=</span> Old <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> BitIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Map<span class="token punctuation">[</span>WordIdx<span class="token punctuation">]</span> <span class="token operator">=</span> New<span class="token punctuation">;</span>
    <span class="token keyword">return</span> New <span class="token operator">!=</span> Old<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="modulepctable"><a href="#modulepctable" class="header-anchor">#</a> ModulePCTable</h4> <p>在开启 <code>-fsanitize-coverage=pc-table</code>以后会创建一个指令表， libfuzzer使用<code>MoudulePCTable</code>来保存这些数据。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>ATTRIBUTE_INTERFACE
<span class="token keyword">void</span> <span class="token function">__sanitizer_cov_pcs_init</span><span class="token punctuation">(</span><span class="token keyword">const</span> uintptr_t <span class="token operator">*</span>pcs_beg<span class="token punctuation">,</span>
                              <span class="token keyword">const</span> uintptr_t <span class="token operator">*</span>pcs_end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fuzzer<span class="token double-colon punctuation">::</span>TPC<span class="token punctuation">.</span><span class="token function">HandlePCsInit</span><span class="token punctuation">(</span>pcs_beg<span class="token punctuation">,</span> pcs_end<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">TracePC</span><span class="token double-colon punctuation">::</span><span class="token function">HandlePCsInit</span><span class="token punctuation">(</span><span class="token keyword">const</span> uintptr_t <span class="token operator">*</span>Start<span class="token punctuation">,</span> <span class="token keyword">const</span> uintptr_t <span class="token operator">*</span>Stop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> PCTableEntry <span class="token operator">*</span>B <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> PCTableEntry <span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>Start<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> PCTableEntry <span class="token operator">*</span>E <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> PCTableEntry <span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>Stop<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>NumPCTables <span class="token operator">&amp;&amp;</span> ModulePCTable<span class="token punctuation">[</span>NumPCTables <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Start <span class="token operator">==</span> B<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>NumPCTables <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ModulePCTable<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ModulePCTable<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ModulePCTable<span class="token punctuation">[</span>NumPCTables<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>B<span class="token punctuation">,</span> E<span class="token punctuation">}</span><span class="token punctuation">;</span>
  NumPCsInPCTables <span class="token operator">+=</span> E <span class="token operator">-</span> B<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>这其中都是指令地址等信息。</p> <h4 id="modules"><a href="#modules" class="header-anchor">#</a> Modules</h4> <p>在开启了<code>-fsanitize-coverage=inline-8bit-counters</code>以后， 会在程序中增加计数器， 在最初的时候需要设置函数在启动时捕获计数器，后续就可以通过计数器判断基本块运行次数了。</p> <p><img src="https://s2.loli.net/2022/05/14/o589d2zEsBWPSTL.png" alt="image.png"> <img src="https://s2.loli.net/2022/05/14/g6RcMEuqJKBzLmN.png" alt="image.png"></p> <p>TPC中使用<code>Modules</code>表示运行次数，而且和前面提到的<code>ModulePCTable</code>结构对应。</p> <h3 id="判断路径"><a href="#判断路径" class="header-anchor">#</a> 判断路径</h3> <p>在<code>Fuzzer::RunOne</code>函数中， 通过<code>ExecuteCallBack</code>运行了样例以后，就是判断的位置，</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>
  UniqFeatureSetTmp<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  size_t FoundUniqFeaturesOfII <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  size_t NumUpdatesBefore <span class="token operator">=</span> Corpus<span class="token punctuation">.</span><span class="token function">NumFeatureUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  TPC<span class="token punctuation">.</span><span class="token function">CollectFeatures</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> Feature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Corpus<span class="token punctuation">.</span><span class="token function">AddFeature</span><span class="token punctuation">(</span>Feature<span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>Size<span class="token punctuation">)</span><span class="token punctuation">,</span> Options<span class="token punctuation">.</span>Shrink<span class="token punctuation">)</span><span class="token punctuation">)</span>
      UniqFeatureSetTmp<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>Feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Options<span class="token punctuation">.</span>Entropic<span class="token punctuation">)</span>
      Corpus<span class="token punctuation">.</span><span class="token function">UpdateFeatureFrequency</span><span class="token punctuation">(</span>II<span class="token punctuation">,</span> Feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Options<span class="token punctuation">.</span>ReduceInputs <span class="token operator">&amp;&amp;</span> II <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>II<span class="token operator">-&gt;</span>NeverReduce<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">binary_search</span><span class="token punctuation">(</span>II<span class="token operator">-&gt;</span>UniqFeatureSet<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             II<span class="token operator">-&gt;</span>UniqFeatureSet<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Feature<span class="token punctuation">)</span><span class="token punctuation">)</span>
        FoundUniqFeaturesOfII<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>FoundUniqFeatures<span class="token punctuation">)</span>
    <span class="token operator">*</span>FoundUniqFeatures <span class="token operator">=</span> FoundUniqFeaturesOfII<span class="token punctuation">;</span>
  <span class="token function">PrintPulseAndReportSlowInput</span><span class="token punctuation">(</span>Data<span class="token punctuation">,</span> Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  size_t NumNewFeatures <span class="token operator">=</span> Corpus<span class="token punctuation">.</span><span class="token function">NumFeatureUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> NumUpdatesBefore<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>后续这个<code>NumNewFeatures</code>判断是否触发全新路径。</p> <p>主要函数在<code>TPC.CollectFeatures</code>， 传入的参数是一个匿名函数，在其中会分别便利<code>Modules</code>和<code>ValueProfileMap</code>运行这个匿名函数，</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">Callback</span><span class="token operator">&gt;</span> <span class="token comment">// void Callback(uint32_t Feature)</span>
ATTRIBUTE_NO_SANITIZE_ADDRESS ATTRIBUTE_NOINLINE size_t
<span class="token class-name">TracePC</span><span class="token double-colon punctuation">::</span><span class="token function">CollectFeatures</span><span class="token punctuation">(</span>Callback HandleFeature<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
  <span class="token keyword">auto</span> Handle8bitCounter <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size_t FirstFeature<span class="token punctuation">,</span>
                               size_t Idx<span class="token punctuation">,</span> <span class="token keyword">uint8_t</span> Counter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>UseCounters<span class="token punctuation">)</span>
      <span class="token function">HandleFeature</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>FirstFeature <span class="token operator">+</span> Idx <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span>
                                          <span class="token function">CounterToFeature</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      <span class="token function">HandleFeature</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>FirstFeature <span class="token operator">+</span> Idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  size_t FirstFeature <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NumModules<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t r <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> r <span class="token operator">&lt;</span> Modules<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>NumRegions<span class="token punctuation">;</span> r<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Modules<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Regions<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">.</span>Enabled<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
      FirstFeature <span class="token operator">+=</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token function">ForEachNonZeroByte</span><span class="token punctuation">(</span>Modules<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Regions<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">.</span>Start<span class="token punctuation">,</span>
                                             Modules<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Regions<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">.</span>Stop<span class="token punctuation">,</span>
                                             FirstFeature<span class="token punctuation">,</span> Handle8bitCounter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  FirstFeature <span class="token operator">+=</span>
      <span class="token number">8</span> <span class="token operator">*</span> <span class="token function">ForEachNonZeroByte</span><span class="token punctuation">(</span><span class="token function">ExtraCountersBegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ExtraCountersEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             FirstFeature<span class="token punctuation">,</span> Handle8bitCounter<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>UseValueProfileMask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ValueProfileMap<span class="token punctuation">.</span><span class="token function">ForEach</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size_t Idx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">HandleFeature</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>FirstFeature <span class="token operator">+</span> Idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    FirstFeature <span class="token operator">+=</span> ValueProfileMap<span class="token punctuation">.</span><span class="token function">SizeInBits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="pc-guard"><a href="#pc-guard" class="header-anchor">#</a> pc_guard</h3> <p>这个方案已经不再使用， 在libfuzzer中可以看到他们运行时会直接警告退出。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>
<span class="token keyword">void</span> <span class="token function">WarnAboutDeprecatedInstrumentation</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Use RawPrint because Printf cannot be used on Windows before OutputFile is</span>
  <span class="token comment">// initialized.</span>
  <span class="token function">RawPrint</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">RawPrint</span><span class="token punctuation">(</span>
      <span class="token string">&quot; is no longer supported by libFuzzer.\n&quot;</span>
      <span class="token string">&quot;Please either migrate to a compiler that supports -fsanitize=fuzzer\n&quot;</span>
      <span class="token string">&quot;or use an older version of libFuzzer\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">}</span> <span class="token comment">// namespace fuzzer</span>

<span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token punctuation">{</span>
ATTRIBUTE_INTERFACE
ATTRIBUTE_NO_SANITIZE_ALL
<span class="token keyword">void</span> <span class="token function">__sanitizer_cov_trace_pc_guard</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> <span class="token operator">*</span>Guard<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fuzzer<span class="token double-colon punctuation">::</span><span class="token function">WarnAboutDeprecatedInstrumentation</span><span class="token punctuation">(</span>
      <span class="token string">&quot;-fsanitize-coverage=trace-pc-guard&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Best-effort support for -fsanitize-coverage=trace-pc, which is available</span>
<span class="token comment">// in both Clang and GCC.</span>
ATTRIBUTE_INTERFACE
ATTRIBUTE_NO_SANITIZE_ALL
<span class="token keyword">void</span> <span class="token function">__sanitizer_cov_trace_pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fuzzer<span class="token double-colon punctuation">::</span><span class="token function">WarnAboutDeprecatedInstrumentation</span><span class="token punctuation">(</span><span class="token string">&quot;-fsanitize-coverage=trace-pc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ATTRIBUTE_INTERFACE
<span class="token keyword">void</span> <span class="token function">__sanitizer_cov_trace_pc_guard_init</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> <span class="token operator">*</span>Start<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> <span class="token operator">*</span>Stop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fuzzer<span class="token double-colon punctuation">::</span><span class="token function">WarnAboutDeprecatedInstrumentation</span><span class="token punctuation">(</span>
      <span class="token string">&quot;-fsanitize-coverage=trace-pc-guard&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>应该是这种方法可以通过<code>inline-8bit</code>和<code>cmp</code>实现，而且<code>trace-cmp</code>还可以感知比较数值，写入字典，这对于覆盖率提高有一定增强。</p></div></div> <!----> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/14/2022, 8:28:49 AM</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:wl200103124@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/wlingze" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://blog.csdn.net/wlz_lc_4" title="csdn" target="_blank" class="iconfont icon-csdn"></a><a href="https://www.zhihu.com/people/wlingze" title="zhihu" target="_blank" class="iconfont icon-zhihu"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2022
    <span>lingze | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.01f8cc77.js" defer></script><script src="/assets/js/2.5ece5099.js" defer></script><script src="/assets/js/72.7e1140f3.js" defer></script>
  </body>
</html>
