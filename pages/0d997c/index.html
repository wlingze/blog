<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>memory_allocator | Lingze&#39;s blog</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ctfer">
    <meta name="keywords" content="ctfer">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.415d0a97.css" as="style"><link rel="preload" href="/assets/js/app.01f8cc77.js" as="script"><link rel="preload" href="/assets/js/2.5ece5099.js" as="script"><link rel="preload" href="/assets/js/82.ea63e06a.js" as="script"><link rel="prefetch" href="/assets/js/10.f923d8b8.js"><link rel="prefetch" href="/assets/js/100.cf64d3e9.js"><link rel="prefetch" href="/assets/js/11.19955ff8.js"><link rel="prefetch" href="/assets/js/12.e16d4c4d.js"><link rel="prefetch" href="/assets/js/13.0552f541.js"><link rel="prefetch" href="/assets/js/14.78d67d73.js"><link rel="prefetch" href="/assets/js/15.d342dfc4.js"><link rel="prefetch" href="/assets/js/16.36f247d6.js"><link rel="prefetch" href="/assets/js/17.031ae63f.js"><link rel="prefetch" href="/assets/js/18.7c49a89e.js"><link rel="prefetch" href="/assets/js/19.2d69c943.js"><link rel="prefetch" href="/assets/js/20.e845eb34.js"><link rel="prefetch" href="/assets/js/21.e398898d.js"><link rel="prefetch" href="/assets/js/22.6efd51e5.js"><link rel="prefetch" href="/assets/js/23.21d2b263.js"><link rel="prefetch" href="/assets/js/24.3231fe48.js"><link rel="prefetch" href="/assets/js/25.26e66a19.js"><link rel="prefetch" href="/assets/js/26.ddde99c2.js"><link rel="prefetch" href="/assets/js/27.f8e523dc.js"><link rel="prefetch" href="/assets/js/28.2c1ddb1d.js"><link rel="prefetch" href="/assets/js/29.f15cca3e.js"><link rel="prefetch" href="/assets/js/3.c087139c.js"><link rel="prefetch" href="/assets/js/30.2d433b5b.js"><link rel="prefetch" href="/assets/js/31.87dbaed0.js"><link rel="prefetch" href="/assets/js/32.045dc002.js"><link rel="prefetch" href="/assets/js/33.db01bde8.js"><link rel="prefetch" href="/assets/js/34.d177d280.js"><link rel="prefetch" href="/assets/js/35.360c2104.js"><link rel="prefetch" href="/assets/js/36.afbabc8a.js"><link rel="prefetch" href="/assets/js/37.8e60e299.js"><link rel="prefetch" href="/assets/js/38.c6a43a23.js"><link rel="prefetch" href="/assets/js/39.08102dc6.js"><link rel="prefetch" href="/assets/js/4.28fb810e.js"><link rel="prefetch" href="/assets/js/40.5767c7d7.js"><link rel="prefetch" href="/assets/js/41.307bcf10.js"><link rel="prefetch" href="/assets/js/42.daf03989.js"><link rel="prefetch" href="/assets/js/43.952d68dc.js"><link rel="prefetch" href="/assets/js/44.cbeef42b.js"><link rel="prefetch" href="/assets/js/45.fbd2a9f2.js"><link rel="prefetch" href="/assets/js/46.a92ae456.js"><link rel="prefetch" href="/assets/js/47.24f82953.js"><link rel="prefetch" href="/assets/js/48.fa3498f4.js"><link rel="prefetch" href="/assets/js/49.a64774f2.js"><link rel="prefetch" href="/assets/js/5.0660e0b3.js"><link rel="prefetch" href="/assets/js/50.d0ed88cd.js"><link rel="prefetch" href="/assets/js/51.50727b96.js"><link rel="prefetch" href="/assets/js/52.2756affe.js"><link rel="prefetch" href="/assets/js/53.2739f473.js"><link rel="prefetch" href="/assets/js/54.f0b71120.js"><link rel="prefetch" href="/assets/js/55.94d5a5ee.js"><link rel="prefetch" href="/assets/js/56.637c3b4a.js"><link rel="prefetch" href="/assets/js/57.7b7e3fee.js"><link rel="prefetch" href="/assets/js/58.812bae5d.js"><link rel="prefetch" href="/assets/js/59.70fe1d63.js"><link rel="prefetch" href="/assets/js/6.c52e1544.js"><link rel="prefetch" href="/assets/js/60.0e6a01d3.js"><link rel="prefetch" href="/assets/js/61.702e5198.js"><link rel="prefetch" href="/assets/js/62.38f55e44.js"><link rel="prefetch" href="/assets/js/63.b505c9de.js"><link rel="prefetch" href="/assets/js/64.5489c9d8.js"><link rel="prefetch" href="/assets/js/65.3db6e034.js"><link rel="prefetch" href="/assets/js/66.3605a461.js"><link rel="prefetch" href="/assets/js/67.00d97ed9.js"><link rel="prefetch" href="/assets/js/68.78ef741a.js"><link rel="prefetch" href="/assets/js/69.808ca1f4.js"><link rel="prefetch" href="/assets/js/7.9920c8ea.js"><link rel="prefetch" href="/assets/js/70.15347f58.js"><link rel="prefetch" href="/assets/js/71.b9acfd65.js"><link rel="prefetch" href="/assets/js/72.7e1140f3.js"><link rel="prefetch" href="/assets/js/73.874f0e99.js"><link rel="prefetch" href="/assets/js/74.117bb7d4.js"><link rel="prefetch" href="/assets/js/75.964e2dfe.js"><link rel="prefetch" href="/assets/js/76.2df26afd.js"><link rel="prefetch" href="/assets/js/77.93ebe7b7.js"><link rel="prefetch" href="/assets/js/78.67c6c9bb.js"><link rel="prefetch" href="/assets/js/79.0d846438.js"><link rel="prefetch" href="/assets/js/8.f3c32733.js"><link rel="prefetch" href="/assets/js/80.4716a5b6.js"><link rel="prefetch" href="/assets/js/81.d8c3b2d2.js"><link rel="prefetch" href="/assets/js/83.4d1ef8ae.js"><link rel="prefetch" href="/assets/js/84.32a22fe7.js"><link rel="prefetch" href="/assets/js/85.7fb3f862.js"><link rel="prefetch" href="/assets/js/86.4d386fc9.js"><link rel="prefetch" href="/assets/js/87.a095878a.js"><link rel="prefetch" href="/assets/js/88.69d77356.js"><link rel="prefetch" href="/assets/js/89.21ebadb4.js"><link rel="prefetch" href="/assets/js/9.d8b27656.js"><link rel="prefetch" href="/assets/js/90.d49929b7.js"><link rel="prefetch" href="/assets/js/91.cc956227.js"><link rel="prefetch" href="/assets/js/92.b72e3535.js"><link rel="prefetch" href="/assets/js/93.a76f52a2.js"><link rel="prefetch" href="/assets/js/94.82a77dbd.js"><link rel="prefetch" href="/assets/js/95.b0cec47e.js"><link rel="prefetch" href="/assets/js/96.87307703.js"><link rel="prefetch" href="/assets/js/97.c731aa62.js"><link rel="prefetch" href="/assets/js/98.1e36c988.js"><link rel="prefetch" href="/assets/js/99.914f1e07.js">
    <link rel="stylesheet" href="/assets/css/0.styles.415d0a97.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open no-sidebar have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/EB-logo.png" alt="Lingze's blog" class="logo"> <span class="site-name can-hide">Lingze's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/archives/" class="nav-link">timeline</a></div><div class="nav-item"><a href="/about.html" class="nav-link">about</a></div><div class="nav-item"><a href="/friends.html" class="nav-link">friends</a></div><div class="nav-item"><a href="/categories/" class="nav-link">categories</a></div><div class="nav-item"><a href="/tags/" class="nav-link">tags</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar2.jpg"> <div class="blogger-info"><h3>lingze</h3> <span>bin不是垃圾桶的意思!</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/archives/" class="nav-link">timeline</a></div><div class="nav-item"><a href="/about.html" class="nav-link">about</a></div><div class="nav-item"><a href="/friends.html" class="nav-link">friends</a></div><div class="nav-item"><a href="/categories/" class="nav-link">categories</a></div><div class="nav-item"><a href="/tags/" class="nav-link">tags</a></div> <!----></nav>  <!----> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1baff76c><div class="articleInfo" data-v-1baff76c><ul class="breadcrumbs" data-v-1baff76c><li data-v-1baff76c><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-1baff76c></a></li> <li data-v-1baff76c><a href="/categories/?category=labbb" title="分类" data-v-1baff76c>labbb</a></li><li data-v-1baff76c><a href="/categories/?category=stl" title="分类" data-v-1baff76c>stl</a></li></ul> <div class="info" data-v-1baff76c><div title="作者" class="author iconfont icon-touxiang" data-v-1baff76c><a href="https://github.com/wlingze" target="_blank" title="作者" class="beLink" data-v-1baff76c>lingze</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1baff76c><a href="javascript:;" data-v-1baff76c>2022-01-27</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">memory_allocator<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="memory-allocator"><a href="#memory-allocator" class="header-anchor">#</a> memory allocator</h1> <h2 id="overview"><a href="#overview" class="header-anchor">#</a> Overview</h2> <p>相关定义在文件 <code>stl_alloc.h</code> .</p> <p>这个文件定义了一下几个分配器：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">int</span> __inst<span class="token operator">&gt;</span> <span class="token keyword">class</span> <span class="token class-name">__malloc_alloc_template</span><span class="token punctuation">;</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">bool</span> threads<span class="token punctuation">,</span> <span class="token keyword">int</span> inst<span class="token operator">&gt;</span> <span class="token keyword">class</span> <span class="token class-name">__default_alloc_template</span> <span class="token punctuation">;</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">_Alloc</span><span class="token operator">&gt;</span> <span class="token keyword">class</span> <span class="token class-name">debug_alloc</span> <span class="token punctuation">;</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">_Tp</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">_Alloc</span><span class="token operator">&gt;</span> <span class="token keyword">class</span> <span class="token class-name">simple_alloc</span><span class="token punctuation">;</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">_Tp</span><span class="token operator">&gt;</span> <span class="token keyword">class</span> <span class="token class-name">allocator</span> <span class="token punctuation">;</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">_Tp</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">_Alloc</span><span class="token operator">&gt;</span> <span class="token keyword">struct</span> <span class="token class-name">__allocator</span> <span class="token punctuation">;</span>

<span class="token keyword">typedef</span> __default_alloc_template<span class="token operator">&lt;</span>__NODE_ALLOCATOR_THREADS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">&gt;</span> alloc<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> __default_alloc_template<span class="token operator">&lt;</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">&gt;</span> single_client_alloc<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><code>__malloc_alloc_template</code> and <code>__default_alloc_template</code>, 实现了对应的分配器功能。</p> <p><code>debug_alloc</code>, <code>simple_alloc</code>, <code>allocator</code>, <code>__allocator</code>, 其实只是一层对其他分配器的封装，提供了不同的接口，但是内存分配功能来自于传入的模板参数 <code>_Alloc</code>。</p> <p><code>alloc</code>, <code>single_client_alloc</code>两个类是typedef， 但是由于对应的类中全都是静态函数，所以可以直接通过这两个进行访问。</p> <h2 id="allocator"><a href="#allocator" class="header-anchor">#</a> allocator</h2> <p>专门实现分配功能的类， <code>__malloc_alloc_template</code> and <code>__default_alloc_template</code>.</p> <h3 id="one-stage-allocator-malloc-alloc-template"><a href="#one-stage-allocator-malloc-alloc-template" class="header-anchor">#</a> one-stage allocator <code>__malloc_alloc_template</code></h3> <p><code>__malloc_alloc_template</code>, 只是简单的封装。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">int</span> __inst<span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">__malloc_alloc_template</span> <span class="token punctuation">{</span>

<span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">_S_oom_malloc</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">_S_oom_realloc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">,</span> size_t<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__STL_STATIC_TEMPLATE_MEMBER_BUG</span></span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span> __malloc_alloc_oom_handler<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">allocate</span><span class="token punctuation">(</span>size_t __n<span class="token punctuation">)</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">deallocate</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> __p<span class="token punctuation">,</span> size_t <span class="token comment">/* __n */</span><span class="token punctuation">)</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">reallocate</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> __p<span class="token punctuation">,</span> size_t <span class="token comment">/* old_sz */</span><span class="token punctuation">,</span> size_t __new_sz<span class="token punctuation">)</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span> <span class="token function">__set_malloc_handler</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>__f<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// malloc_alloc out-of-memory handling</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__STL_STATIC_TEMPLATE_MEMBER_BUG</span></span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">int</span> __inst<span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span> __malloc_alloc_template<span class="token operator">&lt;</span>__inst<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>__malloc_alloc_oom_handler<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>可以看到定义比较简单，allocate\deallocate\reallocate函数都是简单封装了一层malloc\free\realloc，</p> <p>值得注意的是 <code>__malloc_alloc_oom_handler</code>， 这个是为了模仿cpp本身的new handler机制，</p> <blockquote><p>在new获取内存失败并尝试丢出异常之前，会尝试调用 <code>new_handler</code> 函数， ，尝试处理内存不足的情况</p></blockquote> <p>于是这里提供了 set_malloc_handler函数用于设置 <code>__malloc_alloc_oom_handler</code>，然后在allocate\reallocate函数获取内存失败时会调用 <code>_S_oom_malloc\_S_oom_realloc</code>,其中会不断尝试调用 <code>__malloc_alloc_oom_handler</code> 函数。</p> <h3 id="two-stage-allocator-default-alloc-template"><a href="#two-stage-allocator-default-alloc-template" class="header-anchor">#</a> two-stage allocator <code>__default_alloc_template</code></h3> <p>二级分配器就是 <code>__default_alloc_template</code></p> <p>先简述思路，对于 <code>_MAX_BYTES</code> 大小以下的数据使用内存池进行内存分配, 以上的直接使用malloc\free。</p> <p>使用链表 free_list串连空闲状态的chunk， 并按照大小排开，共16个，从0x8 — 0x80,</p> <p>并且每个按照0x8分隔，对于小内存就从这个里面取。</p> <p>当链表为空的时候会尝试填充链表，这时候牵扯到 <code>_S_start_free</code> 和 <code>_S_end_free</code> 两个指针，指向现在空闲的内存池，每次内存池容量不够时会调用malloc进行扩充，而且扩充内存设置为需要内存的两倍，于是多余的可以增长内存池容量。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">bool</span> threads<span class="token punctuation">,</span> <span class="token keyword">int</span> inst<span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">__default_alloc_template</span> <span class="token punctuation">{</span>

<span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token comment">// Really we should use static const int x = N</span>
  <span class="token comment">// instead of enum { x = N }, but few compilers accept the former.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span> <span class="token punctuation">(</span><span class="token function">defined</span><span class="token punctuation">(</span>__SUNPRO_CC<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>__GNUC__<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
    <span class="token keyword">enum</span> <span class="token punctuation">{</span>_ALIGN <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">enum</span> <span class="token punctuation">{</span>_MAX_BYTES <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">enum</span> <span class="token punctuation">{</span>_NFREELISTS <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// _MAX_BYTES/_ALIGN</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">endif</span></span>
  <span class="token keyword">static</span> size_t
  <span class="token function">_S_round_up</span><span class="token punctuation">(</span>size_t __bytes<span class="token punctuation">)</span> 
    <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__bytes<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span> _ALIGN<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span> _ALIGN <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

__PRIVATE<span class="token operator">:</span>
  <span class="token keyword">union</span> _Obj <span class="token punctuation">{</span>
        <span class="token keyword">union</span> _Obj<span class="token operator">*</span> _M_free_list_link<span class="token punctuation">;</span>
        <span class="token keyword">char</span> _M_client_data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/* The client sees this.        */</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__SUNPRO_CC<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>__GNUC__<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>__HP_aCC<span class="token punctuation">)</span></span></span>
    <span class="token keyword">static</span> _Obj<span class="token operator">*</span> __STL_VOLATILE _S_free_list<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
        <span class="token comment">// Specifying a size results in duplicate def for 4.1</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">else</span></span>
    <span class="token keyword">static</span> _Obj<span class="token operator">*</span> __STL_VOLATILE _S_free_list<span class="token punctuation">[</span>_NFREELISTS<span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">endif</span></span>
  <span class="token keyword">static</span>  size_t <span class="token function">_S_freelist_index</span><span class="token punctuation">(</span>size_t __bytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__bytes<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>_ALIGN<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>_ALIGN <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">_S_refill</span><span class="token punctuation">(</span>size_t __n<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">_S_chunk_alloc</span><span class="token punctuation">(</span>size_t __size<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&amp;</span> __nobjs<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Chunk allocation state.</span>
  <span class="token keyword">static</span> <span class="token keyword">char</span><span class="token operator">*</span> _S_start_free<span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">char</span><span class="token operator">*</span> _S_end_free<span class="token punctuation">;</span>
  <span class="token keyword">static</span> size_t _S_heap_size<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">ifdef</span> <span class="token expression">__STL_THREADS</span></span>
    <span class="token keyword">static</span> _STL_mutex_lock _S_node_allocator_lock<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">endif</span></span>

    <span class="token keyword">class</span> <span class="token class-name">_Lock</span><span class="token punctuation">;</span>
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">_Lock</span><span class="token punctuation">;</span>
    <span class="token keyword">class</span> <span class="token class-name">_Lock</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span><span class="token operator">:</span>
            <span class="token function">_Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> __NODE_ALLOCATOR_LOCK<span class="token punctuation">;</span> <span class="token punctuation">}</span>
            <span class="token operator">~</span><span class="token function">_Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> __NODE_ALLOCATOR_UNLOCK<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>

  <span class="token comment">/* __n must be &gt; 0      */</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">allocate</span><span class="token punctuation">(</span>size_t __n<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">/* __p may not be 0 */</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">deallocate</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> __p<span class="token punctuation">,</span> size_t __n<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">reallocate</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> __p<span class="token punctuation">,</span> size_t __old_sz<span class="token punctuation">,</span> size_t __new_sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><h4 id="内存池分配"><a href="#内存池分配" class="header-anchor">#</a> 内存池分配</h4> <p>在allocate函数中，进行判断，根据内存需求的大小来看是否使用内存池，</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">/* __n must be &gt; 0      */</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">allocate</span><span class="token punctuation">(</span>size_t __n<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">void</span><span class="token operator">*</span> __ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>__n <span class="token operator">&gt;</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span> _MAX_BYTES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      __ret <span class="token operator">=</span> malloc_alloc<span class="token double-colon punctuation">::</span><span class="token function">allocate</span><span class="token punctuation">(</span>__n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      _Obj<span class="token operator">*</span> __STL_VOLATILE<span class="token operator">*</span> __my_free_list
          <span class="token operator">=</span> _S_free_list <span class="token operator">+</span> <span class="token function">_S_freelist_index</span><span class="token punctuation">(</span>__n<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Acquire the lock here with a constructor call.</span>
      <span class="token comment">// This ensures that it is released in exit or during stack</span>
      <span class="token comment">// unwinding.</span>
<span class="token macro property"><span class="token directive-hash">#</span>     <span class="token directive keyword">ifndef</span> <span class="token expression">_NOTHREADS</span></span>
      <span class="token comment">/*REFERENCED*/</span>
      _Lock __lock_instance<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span>     <span class="token directive keyword">endif</span></span>
      _Obj<span class="token operator">*</span> __RESTRICT __result <span class="token operator">=</span> <span class="token operator">*</span>__my_free_list<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__result <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        __ret <span class="token operator">=</span> <span class="token function">_S_refill</span><span class="token punctuation">(</span><span class="token function">_S_round_up</span><span class="token punctuation">(</span>__n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>__my_free_list <span class="token operator">=</span> __result <span class="token operator">-&gt;</span> _M_free_list_link<span class="token punctuation">;</span>
        __ret <span class="token operator">=</span> __result<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> __ret<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>可以看到， 大于 <code>_MAX_BYTES</code> 时会直接使用malloc函数。</p> <p>小于时使用内存池，</p> <p><code>_S_free_list</code> 是一个数组，通过 <code>_S_freelist_index(**n)</code>获取对应的索引值，并得到对应的链表 <code>__my_free_list</code> 。**</p> <p>然后判断其中是否有数据，有的话链表首项脱链并返回，没有的话调用函数 <code>_S-refill</code> 进行链表填充， <code>_S_round_up(__n)</code> 是向8的倍数向上对齐。</p> <p>在看deallocate函数，</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">deallocate</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> __p<span class="token punctuation">,</span> size_t __n<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__n <span class="token operator">&gt;</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span> _MAX_BYTES<span class="token punctuation">)</span>
      malloc_alloc<span class="token double-colon punctuation">::</span><span class="token function">deallocate</span><span class="token punctuation">(</span>__p<span class="token punctuation">,</span> __n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      _Obj<span class="token operator">*</span> __STL_VOLATILE<span class="token operator">*</span>  __my_free_list
          <span class="token operator">=</span> _S_free_list <span class="token operator">+</span> <span class="token function">_S_freelist_index</span><span class="token punctuation">(</span>__n<span class="token punctuation">)</span><span class="token punctuation">;</span>
      _Obj<span class="token operator">*</span> __q <span class="token operator">=</span> <span class="token punctuation">(</span>_Obj<span class="token operator">*</span><span class="token punctuation">)</span>__p<span class="token punctuation">;</span>

      <span class="token comment">// acquire lock</span>
<span class="token macro property"><span class="token directive-hash">#</span>       <span class="token directive keyword">ifndef</span> <span class="token expression">_NOTHREADS</span></span>
      <span class="token comment">/*REFERENCED*/</span>
      _Lock __lock_instance<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span>       <span class="token directive keyword">endif</span> <span class="token comment">/* _NOTHREADS */</span></span>
      __q <span class="token operator">-&gt;</span> _M_free_list_link <span class="token operator">=</span> <span class="token operator">*</span>__my_free_list<span class="token punctuation">;</span>
      <span class="token operator">*</span>__my_free_list <span class="token operator">=</span> __q<span class="token punctuation">;</span>
      <span class="token comment">// lock is released here</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>要么使用free函数，要么直接放入到内存池中。</p> <h4 id="内存池拓展"><a href="#内存池拓展" class="header-anchor">#</a> 内存池拓展</h4> <p>下面看下内存拓展相关的部分。</p> <p>首先的内存池拓展接口是 <code>_S_refill</code> ， 直接使用 <code>_S_chunk_alloc</code> 分配对应的堆块 <strong>nobjs个，默认是20，但是内存不够时可在分配时修改这个 <code>__nobjs</code> 的大小，</strong></p> <p>然后比较如果只分配了一个，那么正好返回回去，如果比一个大，那么开头的一个返回回去，剩下的加入到对应的 <code>_S_free_list</code> 中。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">/* Returns an object of size __n, and optionally adds to size __n free list.*/</span>
<span class="token comment">/* We assume that __n is properly aligned.                                */</span>
<span class="token comment">/* We hold the allocation lock.                                         */</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">bool</span> __threads<span class="token punctuation">,</span> <span class="token keyword">int</span> __inst<span class="token operator">&gt;</span>
<span class="token keyword">void</span><span class="token operator">*</span>
<span class="token class-name">__default_alloc_template</span><span class="token operator">&lt;</span>__threads<span class="token punctuation">,</span> __inst<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">_S_refill</span><span class="token punctuation">(</span>size_t __n<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> __nobjs <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> __chunk <span class="token operator">=</span> <span class="token function">_S_chunk_alloc</span><span class="token punctuation">(</span>__n<span class="token punctuation">,</span> __nobjs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _Obj<span class="token operator">*</span> __STL_VOLATILE<span class="token operator">*</span> __my_free_list<span class="token punctuation">;</span>
    _Obj<span class="token operator">*</span> __result<span class="token punctuation">;</span>
    _Obj<span class="token operator">*</span> __current_obj<span class="token punctuation">;</span>
    _Obj<span class="token operator">*</span> __next_obj<span class="token punctuation">;</span>
    <span class="token keyword">int</span> __i<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> __nobjs<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span>__chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __my_free_list <span class="token operator">=</span> _S_free_list <span class="token operator">+</span> <span class="token function">_S_freelist_index</span><span class="token punctuation">(</span>__n<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Build free list in chunk */</span>
      __result <span class="token operator">=</span> <span class="token punctuation">(</span>_Obj<span class="token operator">*</span><span class="token punctuation">)</span>__chunk<span class="token punctuation">;</span>
      <span class="token operator">*</span>__my_free_list <span class="token operator">=</span> __next_obj <span class="token operator">=</span> <span class="token punctuation">(</span>_Obj<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>__chunk <span class="token operator">+</span> __n<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>__i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> __i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        __current_obj <span class="token operator">=</span> __next_obj<span class="token punctuation">;</span>
        __next_obj <span class="token operator">=</span> <span class="token punctuation">(</span>_Obj<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>__next_obj <span class="token operator">+</span> __n<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>__nobjs <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">==</span> __i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            __current_obj <span class="token operator">-&gt;</span> _M_free_list_link <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            __current_obj <span class="token operator">-&gt;</span> _M_free_list_link <span class="token operator">=</span> __next_obj<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">(</span>__result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>那么关于 <code>_S_chunk_alloc</code>  函数。</p> <p>这里就是对于内存池的空闲空间拓展的时候的代码。</p> <blockquote><p>递归的时候有点函数式编程的感觉，这个代码有点难读。</p></blockquote> <ul><li>首先，如果空闲空间足够的话，则直接分配对应 <code>__nobjs</code> 个 大小为 <code>__size</code> 的chunk，</li> <li>如果内存不够，可以分配多少个<code>__size</code>大小的 <code>__nobjs</code> 就分配多少个，并设置 <code>__nobjs</code></li> <li>如果不能分配的话，剩余内存完全不足，则设置 <code>__bytes_to_get</code> ，(注意这个大小比需要的内存两倍还大)，将原本剩余的空闲内存放到链表里，调用malloc获取内存，
<ul><li>(这里有个小想法，这个剩余内存，一定是小于0x80的，因为如果他大于这个数的话，那么前面最起码可以分配出来一个内存返回，所以这个剩余内存完全可以扔到 free_list)</li> <li>调用成功以后设置好空闲内存，递归调用自身，这次应该内存充足直接返回。</li> <li>调用失败的话，
<ul><li>会尝试将比当前size大一点的下个free_list中的chunk取出，当作内存池的剩余内存，递归调用自身，这时候最起码可以返回一个chunk</li> <li>如果free_list中也没chunk了，那么尝试调用第一级分配器，其实第一级分配器也是malloc，但是存在 <code>malloc_handler</code>，可能有用，或者直接抛出错误。这都是可以接受的解决。</li></ul></li></ul></li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">/* We allocate memory in large chunks in order to avoid fragmenting     */</span>
<span class="token comment">/* the malloc heap too much.                                            */</span>
<span class="token comment">/* We assume that size is properly aligned.                             */</span>
<span class="token comment">/* We hold the allocation lock.                                         */</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">bool</span> __threads<span class="token punctuation">,</span> <span class="token keyword">int</span> __inst<span class="token operator">&gt;</span>
<span class="token keyword">char</span><span class="token operator">*</span>
<span class="token class-name">__default_alloc_template</span><span class="token operator">&lt;</span>__threads<span class="token punctuation">,</span> __inst<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">_S_chunk_alloc</span><span class="token punctuation">(</span>size_t __size<span class="token punctuation">,</span> 
                                                            <span class="token keyword">int</span><span class="token operator">&amp;</span> __nobjs<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span><span class="token operator">*</span> __result<span class="token punctuation">;</span>
    size_t __total_bytes <span class="token operator">=</span> __size <span class="token operator">*</span> __nobjs<span class="token punctuation">;</span>
    size_t __bytes_left <span class="token operator">=</span> _S_end_free <span class="token operator">-</span> _S_start_free<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>__bytes_left <span class="token operator">&gt;=</span> __total_bytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        __result <span class="token operator">=</span> _S_start_free<span class="token punctuation">;</span>
        _S_start_free <span class="token operator">+=</span> __total_bytes<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">(</span>__result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>__bytes_left <span class="token operator">&gt;=</span> __size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        __nobjs <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>__bytes_left<span class="token operator">/</span>__size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        __total_bytes <span class="token operator">=</span> __size <span class="token operator">*</span> __nobjs<span class="token punctuation">;</span>
        __result <span class="token operator">=</span> _S_start_free<span class="token punctuation">;</span>
        _S_start_free <span class="token operator">+=</span> __total_bytes<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">(</span>__result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        size_t __bytes_to_get <span class="token operator">=</span> 
	  <span class="token number">2</span> <span class="token operator">*</span> __total_bytes <span class="token operator">+</span> <span class="token function">_S_round_up</span><span class="token punctuation">(</span>_S_heap_size <span class="token operator">&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Try to make use of the left-over piece.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>__bytes_left <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            _Obj<span class="token operator">*</span> __STL_VOLATILE<span class="token operator">*</span> __my_free_list <span class="token operator">=</span>
                        _S_free_list <span class="token operator">+</span> <span class="token function">_S_freelist_index</span><span class="token punctuation">(</span>__bytes_left<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">(</span><span class="token punctuation">(</span>_Obj<span class="token operator">*</span><span class="token punctuation">)</span>_S_start_free<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> _M_free_list_link <span class="token operator">=</span> <span class="token operator">*</span>__my_free_list<span class="token punctuation">;</span>
            <span class="token operator">*</span>__my_free_list <span class="token operator">=</span> <span class="token punctuation">(</span>_Obj<span class="token operator">*</span><span class="token punctuation">)</span>_S_start_free<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        _S_start_free <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>__bytes_to_get<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> _S_start_free<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            size_t __i<span class="token punctuation">;</span>
            _Obj<span class="token operator">*</span> __STL_VOLATILE<span class="token operator">*</span> __my_free_list<span class="token punctuation">;</span>
	    _Obj<span class="token operator">*</span> __p<span class="token punctuation">;</span>
            <span class="token comment">// Try to make do with what we have.  That can't</span>
            <span class="token comment">// hurt.  We do not try smaller requests, since that tends</span>
            <span class="token comment">// to result in disaster on multi-process machines.</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>__i <span class="token operator">=</span> __size<span class="token punctuation">;</span>
                 __i <span class="token operator">&lt;=</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span> _MAX_BYTES<span class="token punctuation">;</span>
                 __i <span class="token operator">+=</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span> _ALIGN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                __my_free_list <span class="token operator">=</span> _S_free_list <span class="token operator">+</span> <span class="token function">_S_freelist_index</span><span class="token punctuation">(</span>__i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                __p <span class="token operator">=</span> <span class="token operator">*</span>__my_free_list<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> __p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token operator">*</span>__my_free_list <span class="token operator">=</span> __p <span class="token operator">-&gt;</span> _M_free_list_link<span class="token punctuation">;</span>
                    _S_start_free <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>__p<span class="token punctuation">;</span>
                    _S_end_free <span class="token operator">=</span> _S_start_free <span class="token operator">+</span> __i<span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token function">_S_chunk_alloc</span><span class="token punctuation">(</span>__size<span class="token punctuation">,</span> __nobjs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// Any leftover piece will eventually make it to the</span>
                    <span class="token comment">// right free list.</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
	    _S_end_free <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">// In case of exception.</span>
            _S_start_free <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>malloc_alloc<span class="token double-colon punctuation">::</span><span class="token function">allocate</span><span class="token punctuation">(</span>__bytes_to_get<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// This should either throw an</span>
            <span class="token comment">// exception or remedy the situation.  Thus we assume it</span>
            <span class="token comment">// succeeded.</span>
        <span class="token punctuation">}</span>
        _S_heap_size <span class="token operator">+=</span> __bytes_to_get<span class="token punctuation">;</span>
        _S_end_free <span class="token operator">=</span> _S_start_free <span class="token operator">+</span> __bytes_to_get<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token function">_S_chunk_alloc</span><span class="token punctuation">(</span>__size<span class="token punctuation">,</span> __nobjs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><h2 id="分配器的封装"><a href="#分配器的封装" class="header-anchor">#</a> 分配器的封装</h2> <h3 id="simple-alloc"><a href="#simple-alloc" class="header-anchor">#</a> simple_alloc</h3> <p>就是一个简单的分配器。简单封装了上层的 <code>_Alloc</code></p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">_Tp</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">_Alloc</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">simple_alloc</span> <span class="token punctuation">{</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">static</span> _Tp<span class="token operator">*</span> <span class="token function">allocate</span><span class="token punctuation">(</span>size_t __n<span class="token punctuation">)</span>
      <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token number">0</span> <span class="token operator">==</span> __n <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span>_Tp<span class="token operator">*</span><span class="token punctuation">)</span> _Alloc<span class="token double-colon punctuation">::</span><span class="token function">allocate</span><span class="token punctuation">(</span>__n <span class="token operator">*</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>_Tp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">static</span> _Tp<span class="token operator">*</span> <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">(</span>_Tp<span class="token operator">*</span><span class="token punctuation">)</span> _Alloc<span class="token double-colon punctuation">::</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span> <span class="token punctuation">(</span>_Tp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">deallocate</span><span class="token punctuation">(</span>_Tp<span class="token operator">*</span> __p<span class="token punctuation">,</span> size_t __n<span class="token punctuation">)</span>
      <span class="token punctuation">{</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> __n<span class="token punctuation">)</span> _Alloc<span class="token double-colon punctuation">::</span><span class="token function">deallocate</span><span class="token punctuation">(</span>__p<span class="token punctuation">,</span> __n <span class="token operator">*</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>_Tp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">deallocate</span><span class="token punctuation">(</span>_Tp<span class="token operator">*</span> __p<span class="token punctuation">)</span>
      <span class="token punctuation">{</span> _Alloc<span class="token double-colon punctuation">::</span><span class="token function">deallocate</span><span class="token punctuation">(</span>__p<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>_Tp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="debug-alloc"><a href="#debug-alloc" class="header-anchor">#</a> debug_alloc</h3> <p>可以用作内存检测，将chunk的第一位用于保存 size， 并在free的时候检测。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">_Alloc</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">debug_alloc</span> <span class="token punctuation">{</span>

<span class="token keyword">private</span><span class="token operator">:</span>

  <span class="token keyword">enum</span> <span class="token punctuation">{</span>_S_extra <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment">// Size of space used to store size.  Note</span>
                        <span class="token comment">// that this must be large enough to preserve</span>
                        <span class="token comment">// alignment.</span>

<span class="token keyword">public</span><span class="token operator">:</span>

  <span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">allocate</span><span class="token punctuation">(</span>size_t __n<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">char</span><span class="token operator">*</span> __result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>_Alloc<span class="token double-colon punctuation">::</span><span class="token function">allocate</span><span class="token punctuation">(</span>__n <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> _S_extra<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>size_t<span class="token operator">*</span><span class="token punctuation">)</span>__result <span class="token operator">=</span> __n<span class="token punctuation">;</span>
    <span class="token keyword">return</span> __result <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> _S_extra<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">deallocate</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> __p<span class="token punctuation">,</span> size_t __n<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">char</span><span class="token operator">*</span> __real_p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>__p <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> _S_extra<span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>size_t<span class="token operator">*</span><span class="token punctuation">)</span>__real_p <span class="token operator">==</span> __n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _Alloc<span class="token double-colon punctuation">::</span><span class="token function">deallocate</span><span class="token punctuation">(</span>__real_p<span class="token punctuation">,</span> __n <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> _S_extra<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">reallocate</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> __p<span class="token punctuation">,</span> size_t __old_sz<span class="token punctuation">,</span> size_t __new_sz<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">char</span><span class="token operator">*</span> __real_p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>__p <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> _S_extra<span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>size_t<span class="token operator">*</span><span class="token punctuation">)</span>__real_p <span class="token operator">==</span> __old_sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> __result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>
      _Alloc<span class="token double-colon punctuation">::</span><span class="token function">reallocate</span><span class="token punctuation">(</span>__real_p<span class="token punctuation">,</span> __old_sz <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> _S_extra<span class="token punctuation">,</span>
                                   __new_sz <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> _S_extra<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>size_t<span class="token operator">*</span><span class="token punctuation">)</span>__result <span class="token operator">=</span> __new_sz<span class="token punctuation">;</span>
    <span class="token keyword">return</span> __result <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> _S_extra<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h3 id="allocator-2"><a href="#allocator-2" class="header-anchor">#</a> allocator</h3> <p>这个其实是标准的 stl分配器接口，</p> <p>也是简单封装了上层，但是这里使用了个 typedef， 所以是指定了分配器是 alloc，也就是第二层分配器。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">_Tp</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">allocator</span> <span class="token punctuation">{</span>
  <span class="token keyword">typedef</span> alloc _Alloc<span class="token punctuation">;</span>          <span class="token comment">// The underlying allocator.</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">typedef</span> size_t     size_type<span class="token punctuation">;</span>
  <span class="token keyword">typedef</span> ptrdiff_t  difference_type<span class="token punctuation">;</span>
  <span class="token keyword">typedef</span> _Tp<span class="token operator">*</span>       pointer<span class="token punctuation">;</span>
  <span class="token keyword">typedef</span> <span class="token keyword">const</span> _Tp<span class="token operator">*</span> const_pointer<span class="token punctuation">;</span>
  <span class="token keyword">typedef</span> _Tp<span class="token operator">&amp;</span>       reference<span class="token punctuation">;</span>
  <span class="token keyword">typedef</span> <span class="token keyword">const</span> _Tp<span class="token operator">&amp;</span> const_reference<span class="token punctuation">;</span>
  <span class="token keyword">typedef</span> _Tp        value_type<span class="token punctuation">;</span>

  <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">_Tp1</span><span class="token operator">&gt;</span> <span class="token keyword">struct</span> <span class="token class-name">rebind</span> <span class="token punctuation">{</span>
    <span class="token keyword">typedef</span> allocator<span class="token operator">&lt;</span>_Tp1<span class="token operator">&gt;</span> other<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">allocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> __STL_NOTHROW <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">allocator</span><span class="token punctuation">(</span><span class="token keyword">const</span> allocator<span class="token operator">&amp;</span><span class="token punctuation">)</span> __STL_NOTHROW <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">_Tp1</span><span class="token operator">&gt;</span> <span class="token function">allocator</span><span class="token punctuation">(</span><span class="token keyword">const</span> allocator<span class="token operator">&lt;</span>_Tp1<span class="token operator">&gt;</span><span class="token operator">&amp;</span><span class="token punctuation">)</span> __STL_NOTHROW <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token operator">~</span><span class="token function">allocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> __STL_NOTHROW <span class="token punctuation">{</span><span class="token punctuation">}</span>

  pointer <span class="token function">address</span><span class="token punctuation">(</span>reference __x<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>__x<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  const_pointer <span class="token function">address</span><span class="token punctuation">(</span>const_reference __x<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>__x<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token comment">// __n is permitted to be 0.  The C++ standard says nothing about what</span>
  <span class="token comment">// the return value is when __n == 0.</span>
  _Tp<span class="token operator">*</span> <span class="token function">allocate</span><span class="token punctuation">(</span>size_type __n<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> __n <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>_Tp<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>_Alloc<span class="token double-colon punctuation">::</span><span class="token function">allocate</span><span class="token punctuation">(</span>__n <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>_Tp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
                    <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// __p is not permitted to be a null pointer.</span>
  <span class="token keyword">void</span> <span class="token function">deallocate</span><span class="token punctuation">(</span>pointer __p<span class="token punctuation">,</span> size_type __n<span class="token punctuation">)</span>
    <span class="token punctuation">{</span> _Alloc<span class="token double-colon punctuation">::</span><span class="token function">deallocate</span><span class="token punctuation">(</span>__p<span class="token punctuation">,</span> __n <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>_Tp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  size_type <span class="token function">max_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> __STL_NOTHROW 
    <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">size_t</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>_Tp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">construct</span><span class="token punctuation">(</span>pointer __p<span class="token punctuation">,</span> <span class="token keyword">const</span> _Tp<span class="token operator">&amp;</span> __val<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">new</span><span class="token punctuation">(</span>__p<span class="token punctuation">)</span> <span class="token function">_Tp</span><span class="token punctuation">(</span>__val<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span>pointer __p<span class="token punctuation">)</span> <span class="token punctuation">{</span> __p<span class="token operator">-&gt;</span><span class="token operator">~</span><span class="token function">_Tp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h2 id="stl标准分配器"><a href="#stl标准分配器" class="header-anchor">#</a> stl标准分配器</h2> <p>其实就是 <code>allocator</code></p> <p>标准分配器的要求的定义是</p> <p><a href="https://en.cppreference.com/w/cpp/memory/allocator" target="_blank" rel="noopener noreferrer">std::allocator<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="静态函数的问题"><a href="#静态函数的问题" class="header-anchor">#</a> 静态函数的<a href="https://www.zhihu.com/question/53085291/answer/133516400" target="_blank" rel="noopener noreferrer">问题<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h3> <p>其实对于一个allocator来说，使用静态成员函数是最为合理的，因为本身应该如同malloc\free一样为全局变量。</p> <p>但是还要考虑到stl标准中要求的，对于不同容器可以使用不同的分配实例。</p> <p>我们可以在 &quot;sgistl &quot;中看到两个类 &quot;allocator &quot;和&quot;__allocator&quot;。</p> <p>正如我们在注释中看到的。<code>allocator</code>实现了分配器的标准定义。</p> <p><code>__allocator</code>只是封装了一层<code>sgi-style allocator</code>，使其成为stl标准库中定义的分配器。</p> <p>当它的模板参数<code>_Alloc=alloc</code>时也是如此。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// Allocator adaptor to turn an SGI-style allocator (e.g. alloc, malloc_alloc)</span>
<span class="token comment">// into a standard-conforming allocator.   Note that this adaptor does</span>
<span class="token comment">// *not* assume that all objects of the underlying alloc class are</span>
<span class="token comment">// identical, nor does it assume that all of the underlying alloc's</span>
<span class="token comment">// member functions are static member functions.  Note, also, that</span>
<span class="token comment">// __allocator&lt;_Tp, alloc&gt; is essentially the same thing as allocator&lt;_Tp&gt;.</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">_Tp</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">_Alloc</span><span class="token operator">&gt;</span> <span class="token keyword">struct</span> <span class="token class-name">__allocator</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>并且在<code>__allocator</code>中，没有指定分配器对应的函数是否是静态函数。就是这个点。</p></div></div> <!----> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">1/27/2022, 3:17:21 AM</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:wl200103124@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/wlingze" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://blog.csdn.net/wlz_lc_4" title="csdn" target="_blank" class="iconfont icon-csdn"></a><a href="https://www.zhihu.com/people/wlingze" title="zhihu" target="_blank" class="iconfont icon-zhihu"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2022
    <span>lingze | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.01f8cc77.js" defer></script><script src="/assets/js/2.5ece5099.js" defer></script><script src="/assets/js/82.ea63e06a.js" defer></script>
  </body>
</html>
